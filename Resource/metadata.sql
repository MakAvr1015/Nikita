/******************************************************************************/
/***          Generated by IBExpert 2011.01.11 04.08.2016 11:44:46          ***/
/******************************************************************************/

/******************************************************************************/
/***      Following SET SQL DIALECT is just for the Database Comparer       ***/
/******************************************************************************/
SET SQL DIALECT 3;



SET TERM ^ ; 



/******************************************************************************/
/***                           Stored Procedures                            ***/
/******************************************************************************/

CREATE OR ALTER PROCEDURE IS_INT (
    STRNUM VARCHAR(255))
RETURNS (
    IR INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_CONVERT_CYR_STR (
    INP_STR VARCHAR(255))
RETURNS (
    OUT_STR VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_DATE_TO_STR (
    F_DATE DATE)
RETURNS (
    F_VALUE VARCHAR(20))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_EXEC_EXCEPTION (
    F_ERR_CODE INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE PR_EXPORT_DISCOUNT_CARD
RETURNS (
    F_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_EXPORT_DOC_IN (
    F_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_EXPORT_DOC_MOVE (
    F_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_EXPORT_DOC_OUT (
    F_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_EXPORT_DOCS_BY_PERIOD (
    P_START_DATE DATE,
    P_END_DATE DATE)
RETURNS (
    V_RESULT VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_EXPORT_INVENTORY (
    P_ID BIGINT)
RETURNS (
    R_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_EXPORT_PRICE_BY_DOC_OUT (
    F_DOC_OUT BIGINT,
    F_PRICE_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_GET_CHANGED_GOOD (
    F_SKLAD BIGINT,
    F_PRICE1 BIGINT,
    F_PRICE2 BIGINT,
    F_DATE DATE)
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(20),
    F_NAME VARCHAR(255),
    F_DOP_INFO VARCHAR(255),
    F_PRICE1_VAL NUMERIC(15,3),
    F_PRICE2_VAL NUMERIC(15,3),
    F_GRP_NAME VARCHAR(60),
    F_GRP_ID BIGINT,
    F_GRP_DOP_INFO VARCHAR(10000),
    F_GRP_EXT_ID VARCHAR(20),
    F_END_OST NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_NSI_SCANCODE_GET (
    SCAN_ID BIGINT,
    F_SCANVALUE VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT,
    F_GOODNAME VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE PR_POST_EVENT_GOOD
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE PR_SET_SYS_PRIV (
    P_TABLE_NAME VARCHAR(60) NOT NULL,
    P_USR VARCHAR(60) NOT NULL,
    P_TYPE VARCHAR(20),
    P_STATE VARCHAR(20),
    P_SEL SMALLINT = 0,
    P_INS SMALLINT = 0,
    P_DEL SMALLINT = 0,
    P_UPD SMALLINT = 0)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_CALC_DOC_OUT_PARTY (
    P_STR_DATE DATE,
    P_END_DATE DATE)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_CALC_INVENTORY (
    F_INVENTORY_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_CALC_PRICE (
    F_PRICE_ID BIGINT,
    F_START_DATE DATE)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_CALC_PRICE_BY_DOC (
    DOC_ID BIGINT,
    START_DATE DATE,
    PRICE_ID BIGINT,
    CHACNGE_PRICE INTEGER,
    DOC_SOURCE INTEGER = 0)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_CALC_PRICE_BY_PRICE (
    PARENT_ID BIGINT,
    START_DATE DATE,
    PRICE_ID BIGINT,
    CHACNGE_PRICE INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_CHECK_CONTEXT_VAL (
    P_CONTEXT_NAME VARCHAR(60),
    P_CONTEXT_VAL VARCHAR(60) = null)
RETURNS (
    F_RESULT SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_CHECK_PRIVS (
    P_TABLE_NAME VARCHAR(60),
    P_STATE INTEGER,
    P_TYPE INTEGER,
    P_OPERATION VARCHAR(20))
RETURNS (
    F_PARAM_NAME VARCHAR(60),
    F_RESULT SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_CHECK_SYS_PRIVS (
    F_TABLE VARCHAR(60))
RETURNS (
    F_RESULT VARCHAR(20),
    F_TYPE VARCHAR(20),
    F_STATE VARCHAR(20))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_COPY_IN2MOVE (
    F_DOC_IN BIGINT)
RETURNS (
    F_MOVE_DOC BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_COPY_IN2PRICE (
    F_DOC_IN BIGINT,
    F_CHANGE_PRICE INTEGER,
    F_PRICE BIGINT)
RETURNS (
    F_DOC_PRICE BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_COPY_MOVE2SPISAN (
    P_DOC_MOVE BIGINT)
RETURNS (
    F_MOVE_DOC BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_COPY_PRICE2PRICE (
    P_SOURCE_PRICE BIGINT,
    P_PRICE BIGINT,
    P_CHANGE_PRICE NUMERIC(15,3),
    P_PARTNER_GOOD BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_CREATE_ARCHIVE_BASE (
    P_ARCH_NAME VARCHAR(60),
    P_ARCH_HOST VARCHAR(60),
    P_START_DATE DATE,
    P_END_DATE DATE)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_DOC_OUT_CALC_SKIDKA (
    F_DOC_OUT INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_EXPORT_REG_GOODS (
    P_SKLAD INTEGER,
    P_DATE DATE,
    P_PRICE INTEGER)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_ALL_CURR_OST
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_NAME VARCHAR(255),
    F_OST VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_DOC_BODY (
    P_DOC_NAME VARCHAR(60),
    P_DOC_ID BIGINT,
    P_SHOW_PHOTO SMALLINT = 0)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_GOOD_NAME VARCHAR(255),
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_SKLAD_OST NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_DOC_HEAD (
    P_DOC_NAME VARCHAR(60),
    P_DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_SENDER_NAME VARCHAR(255),
    F_RECIPIENT_NAME VARCHAR(255),
    F_PRICE BIGINT,
    F_STATE BIGINT,
    F_PRICE_NAME VARCHAR(255),
    F_STATE_NAME VARCHAR(255),
    F_TYPE_NAME VARCHAR(255),
    F_TYPE BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_DOC_NUM (
    F_SKLAD INTEGER)
RETURNS (
    F_RESULT VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_DOC_NUM_BY_PARTY (
    V_PARTY_ID BIGINT)
RETURNS (
    F_NUMBERS VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_GOOD_CURR_OST (
    P_GOOD BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_NAME VARCHAR(255),
    F_OST VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_GOOD_MOOVE (
    F_GOOD BIGINT,
    F_START_DATE DATE,
    F_END_DATE DATE)
RETURNS (
    F_DOC_ID BIGINT,
    F_DOC_DATE DATE,
    F_DOC_NUM VARCHAR(60),
    F_IN_CNT NUMERIC(15,3),
    F_OUT_CNT NUMERIC(15,3),
    F_IN_SUM NUMERIC(15,3),
    F_OUT_SUM NUMERIC(15,3),
    F_PARTNER VARCHAR(60),
    F_PARTNER_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_GOOD_MOOVE_BY_STOCK (
    F_GOOD BIGINT,
    F_START_DATE DATE,
    F_END_DATE DATE,
    F_SKLAD BIGINT)
RETURNS (
    F_DOC_ID BIGINT,
    F_DOC_DATE DATE,
    F_DOC_NUM VARCHAR(60),
    F_IN_CNT NUMERIC(15,3),
    F_OUT_CNT NUMERIC(15,3),
    F_IN_SUM NUMERIC(15,3),
    F_OUT_SUM NUMERIC(15,3),
    F_PARTNER VARCHAR(60),
    F_PARTNER_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_IN_BY_PERIOD (
    F_STR_DATE DATE,
    F_END_DATE DATE)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(255),
    F_NUM_OUT VARCHAR(20),
    F_DATE_OUT DATE,
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_NSI_DISCOUNT (
    F_NUMBER_IN VARCHAR(60))
RETURNS (
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3),
    F_CARD_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_OUT_BY_PERIOD (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    F_DOC_TYPE BIGINT = 0)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(255),
    F_NUM_OUT VARCHAR(20),
    F_DATE_OUT DATE,
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_INPUT_PRICE NUMERIC(15,3),
    F_INPUT_SUM NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_OUT_BY_PERIOD_BY_SKLAD (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    P_SKLAD BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_INPUT_PRICE NUMERIC(15,3),
    F_INPUT_SUM NUMERIC(15,3),
    F_SKIDKA_SUM NUMERIC(15,3),
    F_BACK_SUM NUMERIC(15,3),
    F_BACK_CNT NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_OUT_BY_PRD_BY_SKLAD_EXT (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    P_SKLAD BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_INPUT_PRICE NUMERIC(15,3),
    F_INPUT_SUM NUMERIC(15,3),
    F_SKIDKA_SUM NUMERIC(15,3),
    F_BACK_SUM NUMERIC(15,3),
    F_BACK_CNT NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_SOURCE_FOR_PRICE
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_SYS_PARAM (
    PARAM_NAME VARCHAR(60))
RETURNS (
    PARAM_VALUE VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_GET_USER_BUFFER (
    F_SKLAD BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_GOOD_NAME VARCHAR(100),
    F_CNT FLOAT,
    F_OST FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_IN (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_USER VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_IN_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_MOVE (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_SKLAD BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_USER VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_OUT (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_SKLAD BIGINT,
    F_DISCOUNT_CARD VARCHAR(60) = null,
    F_USER VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_OUT_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_SKIDKA NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT,
    F_DESCR VARCHAR(255) = null)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_PRICE (
    F_NUMBER VARCHAR(20),
    F_PRICE BIGINT,
    F_DATE DATE)
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_PRICE_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_PRICE NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_TEMPLATE (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_SKLAD BIGINT)
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_INVENTORY_DOC_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_DISCOUNT_CARD (
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_GOOD (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_PARTNER BIGINT,
    F_EXT_BASE BIGINT,
    F_DOP_INFO VARCHAR(10000) = null,
    F_BARTER SMALLINT = 0,
    F_PICTURE_NAME VARCHAR(60) = null)
RETURNS (
    F_GOOD_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_PARTNER (
    F_NAME VARCHAR(60),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_ADDRESS VARCHAR(255),
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20))
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_PRICE (
    F_PRICE_ID BIGINT,
    F_PRICE_NAME VARCHAR(60))
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_SCANCODE (
    F_GOOD BIGINT,
    F_SCANCODE VARCHAR(20))
RETURNS (
    F_RESULT SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_INVENTORY_MAKE_DOCS_BY_REZ (
    F_INVENTORY_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_MAKE_PARTY_FROM_DOC_IN (
    P_DOC_IN BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_MAKE_PARTY_FROM_DOC_MOVE (
    P_DOC_MOVE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_MONEY_IN_AUTO (
    F_MONEY BIGINT,
    F_SUM NUMERIC(15,3) = -1)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_MONEY_OUT_AUTO (
    F_MONEY BIGINT,
    F_SUM NUMERIC(15,3) = -1)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_MOVE_GOODS_MMEDIA
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_RECALC_PARTY_OST (
    P_GOOD BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_REFRESH_T_OST
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_ROUND (
    F_VALUE FLOAT,
    F_RND FLOAT)
RETURNS (
    F_RESULT NUMERIC(10,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_SET_PARTY_FOR_DOC_OUT (
    P_DOC_OUT BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_SET_PRICE_FROM_NSI (
    F_PRICE BIGINT,
    F_DOC BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_SET_SYS_CONTEXT (
    P_CONTEXT_NAME D_STR,
    P_CONTEXT_VAL D_STR)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_SET_SYS_PARAM (
    PARAM_NAME VARCHAR(60),
    PARAM_VALUE VARCHAR(60),
    OVERWRITE SMALLINT = 0)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_GET (
    DOC_ID BIGINT,
    DOC_TYPE BIGINT = 0)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PARTNER_NAME VARCHAR(60),
    F_PARTNER_KPP VARCHAR(20),
    F_PARTNER_INN VARCHAR(20),
    F_STATE_NAME VARCHAR(60),
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD_INN VARCHAR(20),
    F_SKLAD_F_NAME VARCHAR(100),
    F_SKLAD_KPP VARCHAR(20),
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_DOC_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_USER VARCHAR(60),
    F_TYPE_NAME VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_DOC_TYPE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_S (
    P_DOC_TYPE BIGINT = -1,
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_DOC_COUNT FLOAT,
    F_DOC_SUM NUMERIC(15,3),
    F_SKLAD_NAME VARCHAR(60),
    F_PARTNER_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_DOC_TYPE BIGINT,
    F_DOC_TYPE_NAME VARCHAR(60),
    F_USER VARCHAR(60),
    F_PAY_SUM NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_I (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT FLOAT,
    F_SUM FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_S (
    DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_SKLAD_OST FLOAT,
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_GOOD_PARTNER BIGINT,
    F_OLD_PRICE_VAL NUMERIC(15,3),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_ICON BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_S_BY_CNT (
    DOC_ID BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_U (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_IN_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_USER VARCHAR(60) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_INVENTORY_STR_S_BY_CNT (
    INVENTORY_DOC BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_CNT FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_GET (
    DOC_ID BIGINT,
    DOC_TYPE BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60),
    F_SKLAD_FROM_NAME VARCHAR(60),
    F_SKLAD_FROM_INN VARCHAR(20),
    F_SKLAD_FROM_F_NAME VARCHAR(100),
    F_SKLAD_FROM_KPP VARCHAR(20),
    F_SKLAD_TO_NAME VARCHAR(60),
    F_SKLAD_TO_INN VARCHAR(20),
    F_SKLAD_TO_F_NAME VARCHAR(100),
    F_SKLAD_TO_KPP VARCHAR(20),
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_DOC_SUM NUMERIC(15,3),
    F_TYPE BIGINT,
    F_DOP_INFO VARCHAR(10000),
    F_USER VARCHAR(60),
    F_TYPE_NAME VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_I (
    F_ID BIGINT,
    F_DATE DATE,
    F_NUMBER VARCHAR(20),
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_STATE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_PRICE BIGINT,
    F_TYPE BIGINT,
    F_DOC_COUNT NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_S (
    F_DOC_TYPE BIGINT = null,
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_DATE DATE,
    F_NUMBER VARCHAR(20),
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(100),
    F_DOC_SUM NUMERIC(15,3),
    F_PRICE BIGINT,
    F_TYPE BIGINT,
    F_TYPE_NAME VARCHAR(60),
    F_DOC_COUNT NUMERIC(15,3),
    F_SKLAD_FROM_NAME VARCHAR(60),
    F_SKLAD_TO_NAME VARCHAR(60),
    F_USER VARCHAR(60),
    F_DEFAULT_PROPERTY VARCHAR(60),
    F_DOP_INFO VARCHAR(10000),
    F_PRICE_NAME VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_I (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_DESCR VARCHAR(255) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_S (
    F_DOC_MOVE_IN BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_DOP_INFO VARCHAR(10000),
    F_SCANCODE VARCHAR(20),
    F_ED_IZM_SHORT_NAME VARCHAR(60),
    F_ED_IZM_NAME VARCHAR(60),
    F_ARTICLE VARCHAR(20),
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_SUM NUMERIC(18,6),
    F_GOOD_PARTNER BIGINT,
    F_SKLAD_OST FLOAT,
    F_SKLAD_TO_OST FLOAT,
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_DESCR VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_S_BY_CNT (
    MOVE_DOC BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_DESCR VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_U (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_DESCR VARCHAR(255))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_U (
    F_ID BIGINT,
    F_DATE DATE,
    F_NUMBER VARCHAR(20),
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_STATE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_PRICE BIGINT,
    F_TYPE BIGINT,
    F_DOC_COUNT NUMERIC(15,3),
    F_DOP_INFO VARCHAR(10000) = null,
    F_USER VARCHAR(60) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_GET (
    DOC_ID BIGINT,
    DOC_TYPE BIGINT = 1,
    DOC_SKLAD BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_PAYDATE_PLAN DATE,
    F_DOC_SUM NUMERIC(15,3),
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_PARTNER_NAME VARCHAR(60),
    F_PARTNER_ADRES VARCHAR(255),
    F_PARTNER_INN VARCHAR(20),
    F_PARTNER_KPP VARCHAR(20),
    F_PARTNER_BANK VARCHAR(60),
    F_PARTNER_BANK_ADRES VARCHAR(255),
    F_PARTNER_BANK_RSCH VARCHAR(20),
    F_PARTNER_BANK_KSCH VARCHAR(20),
    F_PARTNER_BANK_BIK VARCHAR(20),
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD_ADRES VARCHAR(255),
    F_SKLAD_F_NAME VARCHAR(60),
    F_SKLAD_U_ADRES VARCHAR(255),
    F_SKLAD_INN VARCHAR(20),
    F_SKLAD_KPP VARCHAR(20),
    F_SKLAD_BANK VARCHAR(255),
    F_SKLAD_BANK_ADRES VARCHAR(255),
    F_SKLAD_BANK_RSCH VARCHAR(20),
    F_SKLAD_BANK_KSCH VARCHAR(20),
    F_SKLAD_BANK_BIK VARCHAR(20),
    F_SKIDKA INTEGER,
    F_PAY_SUM NUMERIC(15,3),
    F_TYPE BIGINT,
    F_TYPE_NAME VARCHAR(60),
    F_DISCOUNT_CARD VARCHAR(60),
    F_USER VARCHAR(60),
    F_PROPERTY_1 VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PAYDATE_PLAN DATE,
    F_DOC_TYPE BIGINT = 1)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_MAKE_PAY (
    F_DOC_ID BIGINT,
    F_MONEY_TYPE BIGINT = 1,
    F_SUM INTEGER = -1)
RETURNS (
    F_MONEY_IN_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_S (
    DOC_TYPE INTEGER = -1,
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PAYDATE_PLAN DATE,
    F_STATE BIGINT,
    F_DOC_COUNT FLOAT,
    F_DOC_SUM NUMERIC(15,3),
    F_STATE_NAME VARCHAR(60),
    F_SKLAD_NAME VARCHAR(60),
    F_PARTNER_NAME VARCHAR(60),
    F_DOC_SKIDKA NUMERIC(15,3),
    F_DOC_SKIDKA_PERCENT NUMERIC(15,3),
    F_PRICE_NAME VARCHAR(60),
    F_PRICE BIGINT,
    F_PAY_SUM NUMERIC(15,3),
    F_PAY_TYPE BIGINT,
    F_USER VARCHAR(60),
    F_PROPERTY_1 VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_SET_DEF_PROP (
    P_DOC_IN BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_GET (
    P_DOC_ID BIGINT,
    P_GOOD_ID BIGINT,
    P_DOC_STR_ID BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT FLOAT,
    F_SUM NUMERIC(15,3),
    F_GOOD_NAME VARCHAR(255),
    F_PRICE_VAL NUMERIC(15,3),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SKLAD_OST FLOAT,
    F_SKIDKA NUMERIC(15,3),
    F_GOOD_PARNER BIGINT,
    F_DESCR VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_GET_PARTY (
    P_DOC_OUT BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_GOOD_NAME VARCHAR(255),
    F_CNT BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_PARTY_ID BIGINT,
    F_PARTY_DATE DATE,
    F_PARTY_PRICE BIGINT,
    F_NUMBERS VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_I (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_SKD NUMERIC(15,3) = 0,
    F_DESCR VARCHAR(255) = null,
    F_BARTER SMALLINT = 0)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_S (
    DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT FLOAT,
    F_SUM NUMERIC(15,3),
    F_GOOD_NAME VARCHAR(255),
    F_PRICE_VAL NUMERIC(15,3),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SKLAD_OST FLOAT,
    F_SKIDKA NUMERIC(15,3),
    F_GOOD_PARNER BIGINT,
    F_DESCR VARCHAR(255),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_S_BY_CNT (
    DOC_OUT BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_DESCR VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_U (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT FLOAT,
    F_SUM NUMERIC(15,3),
    F_DESCR VARCHAR(255) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PAYDATE_PLAN DATE,
    F_STATE BIGINT,
    F_PRICE INTEGER,
    F_SKIDKA INTEGER,
    F_DISCOUNT_CARD VARCHAR(60) = null,
    F_I_TYPE BIGINT = null,
    F_PROPERTY_1 VARCHAR(255) = null,
    F_USER VARCHAR(60) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_GET (
    F_PRICE_DOC BIGINT,
    F_PARENT_PRICE_DOC BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_USER VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_I (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_SATE BIGINT,
    F_PRICE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_NACENKA NUMERIC(15,3),
    F_USER VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_I (
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_DOC_PRICE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_S (
    F_DOC_PRICE_ID INTEGER)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_DOC_PRICE BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ARTICLE VARCHAR(20),
    F_OLD_PRICE NUMERIC(15,3),
    F_SKLAD_OST NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_DOC_PRICE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_U (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_STATE BIGINT,
    F_PRICE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PROPERTYES_S (
    P_DOC BIGINT,
    P_MOVETYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_PROPERTY_ID BIGINT,
    F_PROPERTY_NAME VARCHAR(255),
    F_VALUE VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_PROPERTYES_SET (
    P_DOC_ID BIGINT,
    P_DOC_MOVETYPE BIGINT,
    P_PROPERTY_ID BIGINT,
    P_VALUE VARCHAR(255))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_D (
    DOC_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_GET (
    DOC_ID BIGINT = -10)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_AUTHOR VARCHAR(60),
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60),
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_I (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_AUTHOR VARCHAR(60),
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_I (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_DESCR VARCHAR(255) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_S (
    P_TEMPLATE_DOC BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(60),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(20),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_GOOD_PARTNER BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_OST_SKLAD_DEF NUMERIC(15,3),
    F_DESCR VARCHAR(255),
    F_GOOD_GRP_COLOR VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_S_BY_CNT (
    DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_U (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_DESCR VARCHAR(255))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_U (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_SKLAD BIGINT = null,
    F_PARTNER BIGINT = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_GET (
    F_INVENTORY_DOC BIGINT,
    F_INV BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_I (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_S (
    F_INV BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_I (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_COUNT NUMERIC(15,3),
    F_INVENTORY_DOC BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_S (
    F_INV_DOC BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_INVENTORY_DOC BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_COUNT NUMERIC(15,3),
    F_INVENTORY_DOC BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_U (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_GET (
    F_INVENTORY BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_I (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_S
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_STR_S (
    F_INV BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_COUNT_PLAN NUMERIC(15,3),
    F_COUNT_FACT NUMERIC(15,3),
    F_INVENTORY BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_INVENTORY_U (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_GET (
    F_MONEY_IN BIGINT,
    F_MONEY_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_USER VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_USER VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_I (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_S (
    F_MONEY_IN BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_S_DOC (
    F_DOC_OUT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_U (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_GET (
    F_MONEY_IN BIGINT,
    F_MONEY_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_DOP_INFO VARCHAR(10000),
    F_USER VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_USER VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_I (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_S (
    F_MONEY_IN BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_S_DOC (
    F_DOC_OUT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_U (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT,
    F_DOP_INFO VARCHAR(10000))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_GET (
    F_BANK_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20),
    F_XML VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CARD_GET (
    P_DISCOUNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CARD_S
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CARD_U (
    F_NSI_DISCOUNT BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CREATE
RETURNS (
    F_DISCOUNT_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_IN_TYPES_GET (
    F_ID BIGINT)
RETURNS (
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_IN_TYPES_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_MOVE_TYPES_GET (
    F_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_MOVE_TYPES_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_OUT_TYPES_GET (
    F_ID BIGINT)
RETURNS (
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_PROPERTY_S
RETURNS (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_DOC_PROPERTY.F_ID */,
    F_NAME VARCHAR(255) /* TYPE OF COLUMN T_NSI_DOC_PROPERTY.F_NAME */)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_GET (
    F_ED_IZM BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_IMPORT_PHOTO (
    F_ARTICLE VARCHAR(60),
    F_MMEDIA BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_NAME VARCHAR(60) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_PARTY_CREATE (
    P_GOOD BIGINT,
    P_DATE DATE,
    P_CNT NUMERIC(15,3),
    P_PRICE NUMERIC(15,3))
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_D (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_I (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID */,
    F_NAME VARCHAR(60) /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_NAME */,
    F_CHECK_OST SMALLINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_CHECK_OST */,
    F_COMPL SMALLINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_COMPL */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_S (
    P_ID D_INT = 0)
RETURNS (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID */,
    F_NAME VARCHAR(60) /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_NAME */,
    F_CHECK_OST SMALLINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_CHECK_OST */,
    F_COMPL SMALLINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_COMPL */)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_U (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID */,
    F_NAME VARCHAR(60) /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_NAME */,
    F_CHECK_OST SMALLINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_CHECK_OST */,
    F_COMPL SMALLINT /* TYPE OF COLUMN T_NSI_GOOD_TYPE.F_COMPL */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_DOP_INFO_D (
    P_GOOD_INFO_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_DOP_INFO_I (
    P_GOOD BIGINT,
    P_GOOD_INFO BIGINT,
    P_GOOD_INFO_VAL VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_INFO BIGINT,
    F_GOOD_INFO_NAME VARCHAR(100),
    F_GOOD_INFO_VAL VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_DOP_INFO_S (
    P_GOOD BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_INFO BIGINT,
    F_GOOD_INFO_NAME VARCHAR(100),
    F_GOOD_INFO_VAL VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GET (
    NSI_ID BIGINT,
    F_GRP BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_GOODS_GRP_NAME VARCHAR(60),
    F_GOODS_GRP_EXT_ID VARCHAR(20),
    F_GOODS_GRP_COLOR VARCHAR(60),
    F_ED_IZM BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_DOP_INFO VARCHAR(255),
    F_PARTNER BIGINT,
    F_BARTER SMALLINT,
    F_XML VARCHAR(10000),
    F_GOOD_TYPE BIGINT,
    F_GOOD_TYPE_NAME VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GET_BY_SCANCODE (
    SCAN VARCHAR(20))
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ED_IZM BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_GET (
    F_GRP BIGINT,
    F_PARENT_GRP BIGINT)
RETURNS (
    GRP_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60),
    F_EXT_ID VARCHAR(20),
    F_DOP_INFO VARCHAR(10000),
    F_COLOR VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_I (
    F_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_S
RETURNS (
    GRP_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60),
    F_COLOR VARCHAR(60))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_U (
    F_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60),
    F_EXT_ID VARCHAR(20),
    F_DOP_INFO VARCHAR(10000),
    F_COLOR VARCHAR(60) = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_I (
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM BIGINT,
    F_EXT_ARTICLE VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_D (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_I (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID */,
    F_NAME VARCHAR(100) /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_NAME */,
    F_MULTI SMALLINT /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_MULTI */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_S
RETURNS (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID */,
    F_NAME VARCHAR(100) /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_NAME */,
    F_MULTI SMALLINT /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_MULTI */)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_D (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_I (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID */,
    F_NSI_GOODS_INFO BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_NSI_GOODS_INFO */,
    F_ORDER BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ORDER */,
    F_VALUE VARCHAR(100) /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_VALUE */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_S (
    P_NSI_GOOD_INFO BIGINT)
RETURNS (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID */,
    F_NSI_GOODS_INFO BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_NSI_GOODS_INFO */,
    F_ORDER BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ORDER */,
    F_VALUE VARCHAR(100) /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_VALUE */)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_U (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID */,
    F_NSI_GOODS_INFO BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_NSI_GOODS_INFO */,
    F_ORDER BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ORDER */,
    F_VALUE VARCHAR(100) /* TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_VALUE */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_U (
    F_ID BIGINT /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID */,
    F_NAME VARCHAR(100) /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_NAME */,
    F_MULTI SMALLINT /* TYPE OF COLUMN T_NSI_GOODS_INFO.F_MULTI */)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_ART_GET (
    F_GOOD_ART VARCHAR(60),
    F_CH_DATE TIMESTAMP = null)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_I (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_CH_DATE TIMESTAMP = 'NOW')
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_S (
    F_GOOD_ID BIGINT,
    F_CH_DATE TIMESTAMP = null)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_S (
    GRP_ID INTEGER)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM BIGINT,
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_DOP_INFO VARCHAR(255),
    F_COLOR VARCHAR(60),
    F_MMEDIA_EXISTS VARCHAR(2),
    F_MMEDIA BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_CRE_DATE DATE)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_U (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM BIGINT,
    F_DOP_INFO VARCHAR(255),
    F_BARTER SMALLINT = 0,
    F_GOOD_TYPE BIGINT = null)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_XML (
    F_GOOD BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_GET (
    F_MONEY_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_CARD_GET (
    P_PARTNER BIGINT,
    P_DATE DATE = 'now')
RETURNS (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    F_DISCOUNT_TYPE BIGINT,
    F_DISCOUNT NUMERIC(15,3),
    F_MAX_DEB NUMERIC(15,3),
    F_PAY_DAY BIGINT,
    F_AVG_OUT NUMERIC(15,3),
    F_AVG_PAY NUMERIC(15,3),
    F_DEB_SUM NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_CARD_SET (
    P_PARTNER BIGINT,
    P_STR_DATE DATE,
    P_END_DATE DATE,
    P_DISCOUNT_TYPE BIGINT,
    P_DISCOUNT NUMERIC(15,3),
    P_PAY_DAY BIGINT,
    P_MAX_DEB NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_GET (
    NSI_ID INTEGER)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_BANK VARCHAR(255),
    F_BANK_RSCH VARCHAR(20),
    F_BANK_BIK VARCHAR(20),
    F_BANK_KSCH VARCHAR(20),
    F_BANK_ADRES VARCHAR(255),
    F_XML VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_GET (
    F_PARTNER BIGINT,
    F_INFO_NAME BIGINT)
RETURNS (
    F_RESULT VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_I (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_INFO_NAME BIGINT,
    F_VALUE VARCHAR(100))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_S (
    PARTNER_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_INFO VARCHAR(60),
    F_INFO_NAME BIGINT,
    F_VALUE VARCHAR(100))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_U (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_INFO_NAME BIGINT,
    F_VALUE VARCHAR(100))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PARTY_SET (
    P_GOOD BIGINT,
    P_DATE DATE,
    P_CNT NUMERIC(15,3),
    P_PRICE NUMERIC(15,3),
    P_SKLAD BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_GET (
    PRICE_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3),
    F_PARENT_OBJECT BIGINT,
    F_SAVE_RESULT SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT_OBJECT BIGINT,
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT_OBJECT BIGINT,
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3),
    F_SAVE_RESULT SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_I (
    F_ID BIGINT,
    F_NSI_PRICE BIGINT,
    F_START_LINE FLOAT,
    F_END_LINE FLOAT,
    F_FORMULA FLOAT,
    F_ROUND FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_S (
    P_NSI_PRICE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NSI_PRICE BIGINT,
    F_START_LINE FLOAT,
    F_END_LINE FLOAT,
    F_FORMULA FLOAT,
    F_ROUND FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_U (
    F_ID BIGINT,
    F_NSI_PRICE BIGINT,
    F_START_LINE FLOAT,
    F_END_LINE FLOAT,
    F_FORMULA FLOAT,
    F_ROUND FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT_OBJECT BIGINT,
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3),
    F_SAVE_RESULT SMALLINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_GET (
    F_GOOD_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_GET_ALL_STR (
    F_GOOD BIGINT)
RETURNS (
    F_RESULT VARCHAR(255))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_I (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_S (
    F_SCANCODE VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_S_BY_GOOD (
    F_IN_GOOD VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_U (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_GET (
    SKLAD_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(60),
    F_PARTNER_INN VARCHAR(20),
    F_PARTNER_KPP VARCHAR(20),
    F_PARTNER_ADRES VARCHAR(255),
    F_PARTNER_BANK VARCHAR(255),
    F_PARTNER_BANK_ADRES VARCHAR(255),
    F_PARTNER_BANK_RSCH VARCHAR(20),
    F_PARTNER_BANK_KSCH VARCHAR(20),
    F_PARTNER_BANK_BIK VARCHAR(20),
    F_XML VARCHAR(10000),
    F_PRICE_IN BIGINT,
    F_PRICE_OUT BIGINT,
    F_PRICE_IN_NAME VARCHAR(60),
    F_PRICE_OUT_NAME VARCHAR(60),
    F_PARTNER_ROZN BIGINT,
    F_PARTNER_ROZN_NAME VARCHAR(255),
    F_PREFIX VARCHAR(2))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER_ROZN BIGINT,
    F_PREFIX VARCHAR(2),
    F_DEBET NUMERIC(15,3),
    F_CREDET NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER BIGINT,
    F_PRICE_IN BIGINT,
    F_PRICE_OUT BIGINT,
    F_PARTNER_ROZN BIGINT,
    F_PREFIX VARCHAR(2) = '')
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_GET (
    STATE_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_I (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_R_SCH VARCHAR(60))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_S (
    F_PARTNER_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(60),
    F_BANK_KPP VARCHAR(20),
    F_BANK_INN VARCHAR(20),
    F_BANK_ADRES VARCHAR(255),
    F_BANK_K_SCH VARCHAR(60),
    F_R_SCH VARCHAR(60),
    F_BANK_BIK VARCHAR(20),
    F_XML VARCHAR(10000))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_U (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_R_SCH VARCHAR(60))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PARTNER_DISCOUNT_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PARTNER_DISCOUNT_I (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_DISCOUNT BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PARTNER_DISCOUNT_S (
    P_PARTNER BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DISCOUNT_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3),
    F_PARTNER BIGINT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_PRICE_CALC (
    F_PRICE_ID BIGINT,
    F_GOOD_ID BIGINT,
    F_DATE DATE = current_date)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_MAKE_DATE TIMESTAMP,
    F_VALUE FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_PRICE_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PRICE_GET (
    F_PRICE_ID BIGINT,
    F_GOOD_ID BIGINT,
    F_DATE DATE = current_date)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_MAKE_DATE TIMESTAMP,
    F_VALUE FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_PRICE_I (
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_VALUE FLOAT,
    F_SOURCE BIGINT = NULL,
    F_ACTIVE SMALLINT = 1)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PRICE_S (
    F_PRICE_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_MAKE_DATE TIMESTAMP,
    F_GOOD_NAME VARCHAR(255),
    F_VALUE FLOAT,
    F_DEFAULT_SKLAD_OST NUMERIC(15,3),
    F_ARTICLE VARCHAR(20))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_PRICE_SET (
    P_GOOD BIGINT,
    P_PRICE BIGINT,
    P_DATE DATE,
    P_VALUE NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_PRICE_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_VALUE FLOAT,
    F_STR_DATE DATE = 'now')
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_D (
    F_ID BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_GET (
    F_GOOD BIGINT,
    F_DATE DATE,
    F_SKLAD BIGINT)
RETURNS (
    F_START_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT,
    F_END_OST FLOAT)
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_I (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_REFRESH (
    F_GOOD_IN BIGINT,
    F_SKLAD_IN BIGINT,
    F_PRICE BIGINT,
    F_DATE_IN DATE = current_date)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT,
    F_END_OST FLOAT,
    F_GOOD_GRP BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_GRP_NAME VARCHAR(60),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_PRICE_VAL NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_S (
    F_SKLAD_IN BIGINT,
    F_DATE_IN DATE,
    F_PRICE BIGINT,
    F_SCAN VARCHAR(20) = null,
    F_T_OST SMALLINT = 1)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT,
    F_END_OST FLOAT,
    F_GOOD_GRP BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_GRP_NAME VARCHAR(60),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_PRICE_VAL NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_SET (
    P_SKLAD D_INT,
    P_GOOD D_INT,
    P_DATE D_DATE,
    P_OPERATION D_BOOL,
    P_CNT D_INT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_PARTNER_GET (
    P_PARTNER BIGINT,
    P_DATE DATE)
RETURNS (
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_STR_OST NUMERIC(15,3),
    F_DOC_OUT_SUM NUMERIC(15,3),
    F_DOC_IN_SUM NUMERIC(15,3),
    F_MONEY_IN_SUM NUMERIC(15,3),
    F_MONEY_OUT_SUM NUMERIC(15,3),
    F_END_OST NUMERIC(15,3))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE SP_T_REG_PARTNER_SET (
    P_PARTNER BIGINT,
    P_DATE DATE,
    P_REG_TYPE INTEGER,
    P_REG_SUM NUMERIC(15,3))
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_T_USER_BUFFER_SET (
    P_GOOD BIGINT,
    P_CNT FLOAT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_UNMAKE_PARTY_FROM_DOC (
    P_DOC_IN BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE SP_UNMAKE_PARTY_FROM_DOC_MOVE (
    P_DOC_MOVE BIGINT)
AS
BEGIN
  EXIT;
END^





CREATE OR ALTER PROCEDURE T_NSI_DOC_PROPERTY_VAL_S (
    P_PROPERTY INTEGER)
RETURNS (
    F_ID BIGINT,
    F_DOC_PROPERTY BIGINT,
    F_VALUE VARCHAR(100))
AS
BEGIN
  SUSPEND;
END^





CREATE OR ALTER PROCEDURE UPD_20160704
AS
BEGIN
  EXIT;
END^






SET TERM ; ^



/******************************************************************************/
/***                                Triggers                                ***/
/******************************************************************************/


SET TERM ^ ;



/******************************************************************************/
/***                      Triggers for updatable views                      ***/
/******************************************************************************/



/* Trigger: V_USER_BUFFER_BD0 */
CREATE OR ALTER TRIGGER V_USER_BUFFER_BD0 FOR V_USER_BUFFER
ACTIVE BEFORE DELETE POSITION 0
AS
BEGIN
  POST_EVENT 'DUMMY_EVENT';
END
^

/* Trigger: V_USER_BUFFER_BD0 */
CREATE OR ALTER TRIGGER V_USER_BUFFER_BD0 FOR V_USER_BUFFER
ACTIVE BEFORE DELETE POSITION 0
AS
begin
  delete from t_user_bufer where f_id=old.f_id;
end
^

/******************************************************************************/
/***                          Triggers for tables                           ***/
/******************************************************************************/



/* Trigger: TR_GEN_T_DOC_IN_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_DOC_IN_ID FOR T_DOC_IN
ACTIVE BEFORE INSERT POSITION 0
as

begin
  if (not exists(select *
                 from SP_CHECK_SYS_PRIVS('T_DOC_IN')
                 where F_RESULT = 'INS' and
                       (F_TYPE = 'ANY' or F_TYPE = new.F_TYPE))) then
    execute procedure PR_EXEC_EXCEPTION(3);
  if (new.F_ID is null) then
    new.F_ID = gen_id(GEN_T_DOC_IN_ID, 1);
  if (new.F_NUMBER is null) then
    select F_RESULT
    from SP_GET_DOC_NUM(new.F_SKLAD)
    into new.F_NUMBER;
  new.F_USER = current_user;
end
^

/* Trigger: TR_GEN_T_DOC_IN_STR_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_DOC_IN_STR_ID FOR T_DOC_IN_STR
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_doc_in_str_ID,1);

end
^

/* Trigger: TR_GEN_T_DOC_OUT_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_DOC_OUT_ID FOR T_DOC_OUT
ACTIVE BEFORE INSERT POSITION 0
as

begin
  if (not exists(select *
                 from SP_CHECK_SYS_PRIVS('T_DOC_OUT')
                 where F_RESULT = 'INS' and
                       (F_TYPE = 'ANY' or F_TYPE = new.F_TYPE))) then
    execute procedure PR_EXEC_EXCEPTION(3);
  if (new.F_ID is null) then
    new.F_ID = gen_id(GEN_T_DOC_OUT_ID, 1);
  if (new.F_NUMBER is null) then
    select F_RESULT
    from SP_GET_DOC_NUM(new.F_SKLAD)
    into new.F_NUMBER;
  new.F_USER = current_user;
end
^

/* Trigger: TR_GEN_T_DOC_OUT_STR_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_DOC_OUT_STR_ID FOR T_DOC_OUT_STR
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_doc_out_str_ID,1);
--  select f_value from SP_T_PRICE_GET(new.f_price,new.f_good) into new.f_price_val;
end
^

/* Trigger: TR_GEN_T_MONEY_IN_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_MONEY_IN_ID FOR T_MONEY_IN
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_money_in_ID,1);

end
^

/* Trigger: TR_GEN_T_MONEY_IN_STR_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_MONEY_IN_STR_ID FOR T_MONEY_IN_STR
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_money_in_str_ID,1);

end
^

/* Trigger: TR_GEN_T_MONEY_OUT_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_MONEY_OUT_ID FOR T_MONEY_OUT
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_money_OUT_ID,1);

end
^

/* Trigger: TR_GEN_T_MONEY_OUT_STR_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_MONEY_OUT_STR_ID FOR T_MONEY_OUT_STR
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_money_out_str_ID,1);

end
^

/* Trigger: TR_GEN_T_NSI_BANK_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_NSI_BANK_ID FOR T_NSI_BANK
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_nsi_bank_ID,1);
  if (new.f_state is null) then
    new.f_state=1;
end
^

/* Trigger: TR_GEN_T_NSI_GOODS_GRP_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_NSI_GOODS_GRP_ID FOR T_NSI_GOODS_GRP
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_nsi_goods_grp_ID,1);
  IF (NEW.f_ext_id IS NULL) THEN
    NEW.f_ext_id=NEW.f_id;
  IF (NEW.f_state IS NULL) THEN
    NEW.f_state=1;

end
^

/* Trigger: TR_GEN_T_NSI_GOODS_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_NSI_GOODS_ID FOR T_NSI_GOODS
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_nsi_goods_ID,1);
  if (coalesce(new.f_article,'')='') then
    new.f_article=new.f_id;
  IF (NEW.f_state IS NULL) THEN
    NEW.f_state=1;
  new.f_cre_date='today';
end
^

/* Trigger: TR_GEN_T_NSI_PARTNER_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_NSI_PARTNER_ID FOR T_NSI_PARTNER
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_nsi_partner_ID,1);
  IF (NEW.f_state IS NULL) THEN
    NEW.f_state=1;

end
^

/* Trigger: TR_GEN_T_NSI_PRICE_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_NSI_PRICE_ID FOR T_NSI_PRICE
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_nsi_price_ID,1);
  IF (NEW.f_state is null) THEN
    NEW.f_state=1;

end
^

/* Trigger: TR_GEN_T_NSI_SKLAD_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_NSI_SKLAD_ID FOR T_NSI_SKLAD
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_nsi_sklad_ID,1);
  IF (NEW.f_state IS NULL) THEN
    NEW.f_state=1;

end
^

/* Trigger: TR_GEN_T_NSI_STATE_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_NSI_STATE_ID FOR T_NSI_STATE
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_nsi_state_ID,1);

end
^

/* Trigger: TR_GEN_T_PARTNER_BANK_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_PARTNER_BANK_ID FOR T_PARTNER_BANK
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_partner_bank_ID,1);

end
^

/* Trigger: TR_GEN_T_PRICE_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_PRICE_ID FOR T_PRICE
ACTIVE BEFORE INSERT POSITION 0
AS
  declare variable f_id   bigint;
begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_price_ID,1);
end
^

/* Trigger: TR_GEN_T_REG_GOOD_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_REG_GOOD_ID FOR T_REG_GOOD
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_reg_good_ID,1);
  select g.f_end_ost from t_reg_good g where
    g.f_good=new.f_good
    and g.f_sklad=new.f_sklad
    and g.f_date=(select max(s.f_date) from t_reg_good s where s.f_good=new.f_good
        and s.f_sklad=new.f_sklad and s.f_date<new.f_date)
    into new.f_str_ost;
   new.f_str_ost=coalesce(new.f_str_ost,0);
end
^

/* Trigger: TR_GEN_T_SYS_LINKS_ID */
CREATE OR ALTER TRIGGER TR_GEN_T_SYS_LINKS_ID FOR T_SYS_LINKS
ACTIVE BEFORE INSERT POSITION 0
AS

begin
  IF (NEW.f_id IS NULL) THEN 
    NEW.f_id=GEN_ID(GEN_t_sys_links_ID,1);

end
^

/* Trigger: T_CURR_PRICE_BI */
CREATE OR ALTER TRIGGER T_CURR_PRICE_BI FOR T_CURR_PRICE
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_curr_price_id,1);
  new.f_make_date='now';
end
^

/* Trigger: T_DOC_IN_AU0 */
CREATE OR ALTER TRIGGER T_DOC_IN_AU0 FOR T_DOC_IN
ACTIVE AFTER UPDATE POSITION 0
as
declare variable GOOD_ID bigint;
declare variable CNT float;
declare variable REG_ID bigint;
declare variable F_SYS_ST bigint;
declare variable V_IN_TYPE bigint;
declare variable V_IS_FILIAL int;
begin
  /* Trigger text */
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
  into :F_SYS_ST;
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('IN_DOC_TYPE')
  into :V_IN_TYPE;
  if (new.F_STATE >= F_SYS_ST and
      old.F_STATE < f_sys_st) then
  begin
    execute procedure SP_T_REG_PARTNER_SET(new.F_PARTNER, new.F_DATE, 1, (new.F_DOC_SUM));

    if (new.F_TYPE = V_IN_TYPE) then
    begin
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('IS_FILIAL')
      into :V_IS_FILIAL;
      if (coalesce(V_IS_FILIAL, 0) = 0) then
        execute procedure SP_CALC_PRICE_BY_DOC(new.F_ID, new.F_DATE, new.F_PRICE, 0, 0);
      execute procedure SP_MAKE_PARTY_FROM_DOC_IN(new.f_id);
    end
    for select S.F_GOOD, S.F_CNT
        from T_DOC_IN_STR S
        where S.F_DOC_IN = new.F_ID and
              S.F_CNT > 0
        into :GOOD_ID, :CNT
    do
    begin
      execute procedure SP_T_REG_GOOD_SET(new.f_sklad,:good_id,new.f_date,0,:cnt);
/*      REG_ID = -1;
      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = new.F_SKLAD and
            F_DATE = new.F_DATE
      into :REG_ID;*/
      if (new.F_TYPE = V_IN_TYPE) then
        update T_NSI_GOODS
        set F_PARTNER = new.F_PARTNER
        where F_ID = :GOOD_ID and
              (F_PARTNER is null);
      ------------------------------------
/*      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_IN = coalesce(F_MOVE_IN, 0) + :CNT
        where F_ID = :REG_ID;
        REG_ID = null;
      end
      else
      if (exists(select F_ID
                 from T_NSI_GOODS
                 where F_ID = :GOOD_ID)) then
      begin
        insert into T_REG_GOOD (F_GOOD, F_SKLAD, F_DATE, F_MOVE_IN)
        values (:GOOD_ID, new.F_SKLAD, new.F_DATE, :CNT);
      end*/
    --------------------------------------
    end
  end
  if (new.F_STATE < F_SYS_ST and
      old.F_STATE >= F_SYS_ST) then
  begin
    if (new.F_TYPE = V_IN_TYPE) then
    begin
      execute procedure SP_UNMAKE_PARTY_FROM_DOC(old.f_id);
    end
    execute procedure SP_T_REG_PARTNER_SET(old.F_PARTNER, old.F_DATE, 1, (old.F_DOC_SUM * -1));
    for select S.F_GOOD, S.F_CNT
        from T_DOC_IN_STR S
        where S.F_DOC_IN = new.F_ID
        into :GOOD_ID, :CNT
    do
    begin
      execute procedure SP_T_REG_GOOD_SET(old.f_sklad,:good_id,old.f_date,0,(:cnt*-1));
/*      REG_ID = -1;
      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = new.F_SKLAD and
            F_DATE = new.F_DATE
      into :REG_ID;
      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_IN = coalesce(F_MOVE_IN, 0) - :CNT
        where F_ID = :REG_ID;
      end*/
    end
  end

end
^

/* Trigger: T_DOC_IN_BD_CHECK */
CREATE OR ALTER TRIGGER T_DOC_IN_BD_CHECK FOR T_DOC_IN
ACTIVE BEFORE DELETE POSITION 0
AS
begin
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_DOC_IN') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
end
^

/* Trigger: T_DOC_IN_BU0 */
CREATE OR ALTER TRIGGER T_DOC_IN_BU0 FOR T_DOC_IN
ACTIVE BEFORE UPDATE OR DELETE POSITION 1
AS
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (old.f_state>=f_sys_st and coalesce(new.f_state,old.f_state)=old.f_state and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end
end
^

/* Trigger: T_DOC_IN_BU_CHECK */
CREATE OR ALTER TRIGGER T_DOC_IN_BU_CHECK FOR T_DOC_IN
ACTIVE BEFORE UPDATE POSITION 0
as
begin
  if (new.F_STATE < 0 and
      old.F_STATE > 0) then
  begin
    if (not exists(select *
                   from SP_CHECK_SYS_PRIVS('T_DOC_IN')
                   where F_RESULT = 'DEL' and
                         (F_STATE = 'ANY' or F_STATE = old.F_STATE) and
                         (F_TYPE = 'ANY' or F_TYPE = old.F_TYPE))) then
      execute procedure PR_EXEC_EXCEPTION(3);
  end
  else
  begin
    if (not exists(select *
                   from SP_CHECK_SYS_PRIVS('T_DOC_IN')
                   where F_RESULT = 'UPD' and
                         (F_STATE = 'ANY' or F_STATE = old.F_STATE) and
                         (F_TYPE = 'ANY' or F_TYPE = old.F_TYPE))) then
      execute procedure PR_EXEC_EXCEPTION(3);
  end
end
^

/* Trigger: T_DOC_IN_STR_AIUD10 */
CREATE OR ALTER TRIGGER T_DOC_IN_STR_AIUD10 FOR T_DOC_IN_STR
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 10
AS
begin
  if (coalesce(old.f_cnt,0)<>coalesce(new.f_cnt,0) or coalesce(old.f_sum,0)<>coalesce(new.f_sum,0) ) then
  begin
     update t_doc_in
        set f_doc_count=coalesce(f_doc_count,0)-coalesce(old.f_cnt,0),
        f_doc_sum=coalesce(f_doc_sum,0)-coalesce(old.f_sum,0)
        where f_id=old.f_doc_in;
     update t_doc_in
        set f_doc_count=coalesce(f_doc_count,0)+coalesce(new.f_cnt,0),
        f_doc_sum=coalesce(f_doc_sum,0)+coalesce(new.f_sum,0)
        where f_id=new.f_doc_in;
  end
end
^

/* Trigger: T_DOC_MOVE_AU0 */
CREATE OR ALTER TRIGGER T_DOC_MOVE_AU0 FOR T_DOC_MOVE
ACTIVE AFTER UPDATE POSITION 0
as
declare variable GOOD_ID bigint;
declare variable CNT float;
declare variable REG_ID bigint;
declare variable F_SYS_ST bigint;
declare variable V_IS_FILIAL int;
declare variable V_SKLAD bigint;
begin
  /* Trigger text */

  if ((new.F_PRICE <> old.F_PRICE) and
      (new.F_PRICE is not null)) then
  begin
    --    update t_doc_move_str set f_price=(select f_id from SP_T_PRICE_GET(NEW.F_PRICE,f_good)) where f_doc_move=new.f_id;
    update T_DOC_MOVE_STR
    set F_PRICE_VAL = (select F_VALUE
                       from SP_T_PRICE_GET(new.F_PRICE, F_GOOD)),
        F_PRICE = new.F_PRICE
    where F_DOC_MOVE = new.F_ID;
  end
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('DEFAULT_SKLAD')
  into :V_SKLAD;

  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
  into :F_SYS_ST;
  if (new.F_STATE >= F_SYS_ST and
      old.F_STATE < f_sys_st) then
  begin
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('IS_FILIAL')
    into :V_IS_FILIAL;
    if (coalesce(V_IS_FILIAL, 0) = 1 and V_SKLAD=new.f_sklad_to) then
      execute procedure SP_CALC_PRICE_BY_DOC(new.F_ID, new.F_DATE, new.F_PRICE, 0, 1);
    if (new.f_type=3 and V_SKLAD=new.f_sklad_to) then
      execute procedure SP_MAKE_PARTY_FROM_DOC_move(new.f_id);
    for select S.F_GOOD, S.F_CNT
        from T_DOC_MOVE_STR S
        where S.F_DOC_MOVE = new.F_ID and
              S.F_CNT > 0
        into :GOOD_ID, :CNT
    do
    begin
      execute procedure SP_T_REG_GOOD_SET(new.f_sklad_to,:good_id,new.f_date,0,:cnt);
      execute procedure SP_T_REG_GOOD_SET(new.f_sklad_from,:good_id,new.f_date,1,:cnt);

/*      REG_ID = -1;
      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = new.F_SKLAD_TO and
            F_DATE = new.F_DATE
      into :REG_ID;
      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_IN = coalesce(F_MOVE_IN, 0) + :CNT
        where F_ID = :REG_ID;
        REG_ID = null;
      end
      else
      begin
        if (new.F_SKLAD_TO is not null) then
          insert into T_REG_GOOD (F_GOOD, F_SKLAD, F_DATE, F_MOVE_IN)
          values (:GOOD_ID, new.F_SKLAD_TO, new.F_DATE, :CNT);
      end

      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = new.F_SKLAD_FROM and
            F_DATE = new.F_DATE
      into :REG_ID;
      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_OUT = coalesce(F_MOVE_OUT, 0) + :CNT
        where F_ID = :REG_ID;
        REG_ID = null;
      end
      else
      begin
        if (new.F_SKLAD_FROM is not null) then
          insert into T_REG_GOOD (F_GOOD, F_SKLAD, F_DATE, F_MOVE_OUT)
          values (:GOOD_ID, new.F_SKLAD_FROM, new.F_DATE, :CNT);
      end */
    end
    --------------------------------------
  end
  if (new.F_STATE < F_SYS_ST and
      old.F_STATE >= F_SYS_ST) then
  begin
    if (new.f_type=3 and V_SKLAD=new.f_sklad_to) then
      execute procedure SP_UNMAKE_PARTY_FROM_DOC_move(new.f_id);

    for select S.F_GOOD, S.F_CNT
        from T_DOC_MOVE_STR S
        where S.F_DOC_MOVE = new.F_ID
        into :GOOD_ID, :CNT
    do
    begin
      execute procedure SP_T_REG_GOOD_SET(new.f_sklad_to,:good_id,new.f_date,0,:cnt*(-1));
      execute procedure SP_T_REG_GOOD_SET(new.f_sklad_from,:good_id,new.f_date,1,:cnt*(-1));

/*      REG_ID = -1;
      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = new.F_SKLAD_FROM and
            F_DATE = new.F_DATE
      into :REG_ID;
      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_OUT = coalesce(F_MOVE_OUT, 0) - :CNT
        where F_ID = :REG_ID;
      end
      REG_ID = -1;
      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = new.F_SKLAD_TO and
            F_DATE = new.F_DATE
      into :REG_ID;
      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_IN = coalesce(F_MOVE_IN, 0) - :CNT
        where F_ID = :REG_ID;
      end*/

    end
  end

end
^

/* Trigger: T_DOC_MOVE_BDCHECK */
CREATE OR ALTER TRIGGER T_DOC_MOVE_BDCHECK FOR T_DOC_MOVE
ACTIVE BEFORE DELETE POSITION 0
AS
begin
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_DOC_MOVE') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
end
^

/* Trigger: T_DOC_MOVE_BI */
CREATE OR ALTER TRIGGER T_DOC_MOVE_BI FOR T_DOC_MOVE
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (not exists(select *
                 from SP_CHECK_SYS_PRIVS('T_DOC_MOVE')
                 where F_RESULT = 'INS' and
                       (F_TYPE = 'ANY' or F_TYPE = new.F_TYPE))) then
    execute procedure PR_EXEC_EXCEPTION(3);

  if (new.F_ID is null) then
    new.F_ID = gen_id(GEN_T_DOC_MOVE_ID, 1);
  if (new.F_NUMBER is null) then
    select F_RESULT
    from SP_GET_DOC_NUM(new.F_SKLAD_FROM)
    into new.F_NUMBER;
  new.F_USER = current_user;
end
^

/* Trigger: T_DOC_MOVE_BI0 */
CREATE OR ALTER TRIGGER T_DOC_MOVE_BI0 FOR T_DOC_MOVE
ACTIVE BEFORE UPDATE OR DELETE POSITION 1
as
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (old.f_state>=f_sys_st and coalesce(new.f_state,old.f_state)=old.f_state and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end
end
^

/* Trigger: T_DOC_MOVE_BU_CHECK */
CREATE OR ALTER TRIGGER T_DOC_MOVE_BU_CHECK FOR T_DOC_MOVE
ACTIVE BEFORE UPDATE POSITION 0
AS
begin
  if (new.F_STATE < 0 and
      old.F_STATE > 0) then
  begin
    if (not exists(select *
                   from SP_CHECK_SYS_PRIVS('T_DOC_MOVE')
                   where F_RESULT = 'DEL' and
                         (F_STATE = 'ANY' or F_STATE = old.F_STATE) and
                         (F_TYPE = 'ANY' or F_TYPE = old.F_TYPE))) then
      execute procedure PR_EXEC_EXCEPTION(3);
  end
  else
  begin
    if (not exists(select *
                   from SP_CHECK_SYS_PRIVS('T_DOC_MOVE')
                   where F_RESULT = 'UPD' and
                         (F_STATE = 'ANY' or F_STATE = old.F_STATE) and
                         (F_TYPE = 'ANY' or F_TYPE = old.F_TYPE))) then
      execute procedure PR_EXEC_EXCEPTION(3);
  end
  new.f_last_user=user;
  new.f_last_dt='now';
end
^

/* Trigger: T_DOC_MOVE_STR_AIUD10 */
CREATE OR ALTER TRIGGER T_DOC_MOVE_STR_AIUD10 FOR T_DOC_MOVE_STR
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 10
AS
begin
  if (coalesce(old.f_cnt,0)<>coalesce(new.f_cnt,0) or coalesce(old.f_sum,0)<>coalesce(new.f_sum,0) ) then
  begin
     update t_doc_move
        set f_doc_count=coalesce(f_doc_count,0)-coalesce(old.f_cnt,0),
        f_doc_sum=coalesce(f_doc_sum,0)-coalesce(old.f_sum,0)
        where f_id=old.f_doc_move;
     update t_doc_move
        set f_doc_count=coalesce(f_doc_count,0)+coalesce(new.f_cnt,0),
        f_doc_sum=coalesce(f_doc_sum,0)+coalesce(new.f_sum,0)
        where f_id=new.f_doc_move;
  end
end
^

/* Trigger: T_DOC_MOVE_STR_BI */
CREATE OR ALTER TRIGGER T_DOC_MOVE_STR_BI FOR T_DOC_MOVE_STR
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_DOC_MOVE_STR_ID,1);
END
^

/* Trigger: T_DOC_OUT_AU0 */
CREATE OR ALTER TRIGGER T_DOC_OUT_AU0 FOR T_DOC_OUT
ACTIVE AFTER UPDATE POSITION 0
as
declare variable GOOD_ID bigint;
declare variable CNT float;
declare variable REG_ID bigint;
declare variable STR_ID bigint;
declare variable F_SYS_ST bigint;
declare variable V_ROUND numeric(15,3);
begin
  if ((new.F_PRICE <> old.F_PRICE) or (coalesce(old.F_SKIDKA, 0) <> coalesce(new.F_SKIDKA, 0)) or (coalesce(old.F_DISCOUNT_CARD, '') <> coalesce(new.F_DISCOUNT_CARD, ''))) then
  begin
    update T_DOC_OUT_STR
    set F_PRICE_VAL_NSI = (select F_VALUE
                           from SP_T_PRICE_GET(new.F_PRICE, F_GOOD))
    where F_DOC_OUT = new.F_ID and
          coalesce(F_PRICE_VAL_NSI, 0) >= 0;

    update T_DOC_OUT_STR
    set F_PRICE_VAL_NSI = (select F_VALUE
                           from SP_T_PRICE_GET(new.F_PRICE, F_GOOD)) * (-1)
    where F_DOC_OUT = new.F_ID and
          F_PRICE_VAL_NSI < 0;

    execute procedure SP_DOC_OUT_CALC_SKIDKA(new.F_ID);
    /*
    select f_round from sp_t_nsi_price_get(new.f_price) into :v_round;
    update t_doc_out_str
      set f_price_val=(select f_value from SP_T_PRICE_GET(NEW.F_PRICE,f_good))*(100-coalesce(new.f_skidka,0))/100.00,
      f_price_val_nsi=(select f_value from SP_T_PRICE_GET(NEW.F_PRICE,f_good))
      where f_doc_out=new.f_id;
    update t_doc_out_str
      set f_price_val=(select f_result from sp_round(f_price_val,:v_round))
      where f_doc_out=new.f_id;
      */
  end
  /* Trigger text */
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
  into :F_SYS_ST;
  if (new.F_STATE >= F_SYS_ST and
      coalesce(old.F_STATE,0) < F_SYS_ST) then
  begin
    execute procedure SP_T_REG_PARTNER_SET(new.F_PARTNER, new.F_DATE, 2, (new.F_DOC_SUM));
    execute procedure SP_SET_PARTY_FOR_DOC_OUT(new.F_ID);
    for select S.F_GOOD, S.F_CNT
        from T_DOC_OUT_STR S
        where S.F_DOC_OUT = new.F_ID and f_cnt>0
        into :GOOD_ID, :CNT
    do
    begin
      execute procedure SP_T_REG_GOOD_SET(new.f_sklad,:good_id,new.f_date,1,:cnt);
/*      REG_ID = -1;
      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = new.F_SKLAD and
            F_DATE = new.F_DATE
      into :REG_ID;
      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_OUT = coalesce(F_MOVE_OUT, 0) + :CNT
        where F_ID = :REG_ID;
      end
      else
      if (exists(select F_ID
                 from T_NSI_GOODS
                 where F_ID = :GOOD_ID)) then
      begin
        insert into T_REG_GOOD (F_GOOD, F_SKLAD, F_DATE, F_MOVE_OUT)
        values (:GOOD_ID, new.F_SKLAD, new.F_DATE, :CNT);
      end*/
    end
  end
  if (old.F_STATE >= F_SYS_ST and
      coalesce(new.F_STATE,0) < F_SYS_ST) then
  begin
    execute procedure SP_T_REG_PARTNER_SET(old.F_PARTNER, old.F_DATE, 2, (old.F_DOC_SUM) * (-1));
    for select S.F_ID, S.F_GOOD, S.F_CNT
        from T_DOC_OUT_STR S
        where S.F_DOC_OUT = old.F_ID and f_cnt>0
        into :STR_ID, :GOOD_ID, :CNT
    do
    begin
      delete from T_DOC_OUT_STR_PARTY P
      where P.F_DOC_OUT_STR = :STR_ID;
      execute procedure SP_T_REG_GOOD_SET(new.f_sklad,:good_id,new.f_date,1,:cnt*(-1));
/*      REG_ID = -1;
      select F_ID
      from T_REG_GOOD
      where F_GOOD = :GOOD_ID and
            F_SKLAD = old.F_SKLAD and
            F_DATE = old.F_DATE
      into :REG_ID;
      if (coalesce(REG_ID, -1) > 0) then
      begin
        update T_REG_GOOD
        set F_MOVE_OUT = coalesce(F_MOVE_OUT, 0) - :CNT
        where F_ID = :REG_ID;
      end*/
    end
  end
  ---------------------------------------------------------
end
^

/* Trigger: T_DOC_OUT_BD_CHECK */
CREATE OR ALTER TRIGGER T_DOC_OUT_BD_CHECK FOR T_DOC_OUT
ACTIVE BEFORE DELETE POSITION 0
AS
begin
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_DOC_OUT') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
end
^

/* Trigger: T_DOC_OUT_BUD0 */
CREATE OR ALTER TRIGGER T_DOC_OUT_BUD0 FOR T_DOC_OUT
ACTIVE BEFORE UPDATE OR DELETE POSITION 1
AS
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (old.f_state>=f_sys_st and coalesce(new.f_state,old.f_state)=old.f_state and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end
  if (coalesce(old.f_discount_card,'') <> coalesce(new.f_discount_card,'')) then
    select f_discount from sp_get_nsi_discount(new.f_discount_card) into new.f_skidka;

end
^

/* Trigger: T_DOC_OUT_BU_CHECK */
CREATE OR ALTER TRIGGER T_DOC_OUT_BU_CHECK FOR T_DOC_OUT
ACTIVE BEFORE UPDATE POSITION 0
as
declare variable V_RESULT smallint;
begin
  if (new.F_STATE < 0 and
      old.F_STATE > 0) then
  begin
    select F_RESULT
    from SP_CHECK_PRIVS('T_DOC_OUT', old.F_STATE, new.F_TYPE, 'DEL')
    into :V_RESULT;
    if (V_RESULT <> 1) then
    begin
      new.F_STATE = old.F_STATE;
      --      execute procedure PR_EXEC_EXCEPTION(3);
    end
    if (not exists(select *
                   from SP_CHECK_SYS_PRIVS('T_DOC_OUT')
                   where F_RESULT = 'DEL')) then
      execute procedure PR_EXEC_EXCEPTION(3);
  end
  else
  begin
    if (not exists(select *
                   from SP_CHECK_SYS_PRIVS('T_DOC_OUT')
                   where F_RESULT = 'UPD' and
                         (F_STATE = 'ANY' or F_STATE = old.F_STATE) and
                         (F_TYPE = 'ANY' or F_TYPE = old.F_TYPE))) then
      execute procedure PR_EXEC_EXCEPTION(3);
  end
  new.f_last_user=user;
  new.f_last_dt='now';
end
^

/* Trigger: T_DOC_OUT_STR_AIUD10 */
CREATE OR ALTER TRIGGER T_DOC_OUT_STR_AIUD10 FOR T_DOC_OUT_STR
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 10
AS
begin
     update t_doc_out
        set f_doc_count=coalesce(f_doc_count,0)-coalesce(old.f_cnt,0),
        f_doc_sum=coalesce(f_doc_sum,0)-coalesce(old.f_sum,0)
        where f_id=old.f_doc_out;
     update t_doc_out
        set f_doc_count=coalesce(f_doc_count,0)+coalesce(new.f_cnt,0),
        f_doc_sum=coalesce(f_doc_sum,0)+coalesce(new.f_sum,0)
        where f_id=new.f_doc_out;
end
^

/* Trigger: T_DOC_OUT_STR_BU0 */
CREATE OR ALTER TRIGGER T_DOC_OUT_STR_BU0 FOR T_DOC_OUT_STR
ACTIVE BEFORE UPDATE POSITION 0
AS
begin
  /* Trigger text */
  if (new.f_price<>old.f_price) then
  begin
    --select f_value from SP_T_PRICE_GET(new.f_price,new.f_good) into new.f_price_val;
    select p.f_value from t_price p where p.f_id=new.f_price into new.f_price_val;
  end
end
^

/* Trigger: T_DOC_OUT_STR_PARTY_BI */
CREATE OR ALTER TRIGGER T_DOC_OUT_STR_PARTY_BI FOR T_DOC_OUT_STR_PARTY
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_DOC_OUT_STR_PARTY_ID,1);
END
^

/* Trigger: T_DOC_PRICE_AI0 */
CREATE OR ALTER TRIGGER T_DOC_PRICE_AI0 FOR T_DOC_PRICE
ACTIVE AFTER INSERT POSITION 0
AS
begin
  if (new.f_parent is not null) then
  begin
    INSERT INTO T_DOC_PRICE_STR (
    F_GOOD,
    F_PRICE,
    F_DOC_PRICE)
    select
      f_good,
      f_price_val,
      new.f_id
    from sp_t_doc_in_str_s(new.f_parent);
  end
end
^

/* Trigger: T_DOC_PRICE_AU10 */
CREATE OR ALTER TRIGGER T_DOC_PRICE_AU10 FOR T_DOC_PRICE
ACTIVE AFTER UPDATE POSITION 10
AS
  declare variable f_sys_st bigint;
  declare variable f_str_id bigint;
  declare variable f_str_good bigint;
  declare variable f_price_val numeric(15,3);
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  if (new.f_state>=f_sys_st and old.f_state<f_sys_st) then
  begin
    for
      select
        f_id,
        f_good,
        f_price
      from
        t_doc_price_str
      where
        f_doc_price=new.f_id
      into
        :f_str_id,
        :f_str_good,
        :f_price_val
    do begin
      execute procedure SP_T_PRICE_SET(:f_str_good,new.f_price,new.f_date,:f_price_val);
--      execute procedure SP_T_PRICE_I(:f_str_good,new.f_price,new.f_date,:f_price_val,:f_str_id);
    end
  end
end
^

/* Trigger: T_DOC_PRICE_BD_CHECK */
CREATE OR ALTER TRIGGER T_DOC_PRICE_BD_CHECK FOR T_DOC_PRICE
ACTIVE BEFORE DELETE POSITION 0
AS
begin
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_DOC_OUT') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
end
^

/* Trigger: T_DOC_PRICE_BI */
CREATE OR ALTER TRIGGER T_DOC_PRICE_BI FOR T_DOC_PRICE
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_DOC_PRICE') where f_result='INS') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_DOC_price_ID,1);
  new.f_user = current_user;
END
^

/* Trigger: T_DOC_PRICE_BIU0 */
CREATE OR ALTER TRIGGER T_DOC_PRICE_BIU0 FOR T_DOC_PRICE
ACTIVE BEFORE UPDATE OR DELETE POSITION 1
as
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (old.f_state>=f_sys_st and coalesce(new.f_state,old.f_state)=old.f_state and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end
end
^

/* Trigger: T_DOC_PRICE_BU_CHECK */
CREATE OR ALTER TRIGGER T_DOC_PRICE_BU_CHECK FOR T_DOC_PRICE
ACTIVE BEFORE UPDATE POSITION 0
AS
begin
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_DOC_PRICE') where f_result='UPD') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
end
^

/* Trigger: T_DOC_PRICE_STR_BI */
CREATE OR ALTER TRIGGER T_DOC_PRICE_STR_BI FOR T_DOC_PRICE_STR
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_DOC_PRICE_STR_ID,1);
END
^

/* Trigger: T_DOC_PRICE_STR_BIU1 */
CREATE OR ALTER TRIGGER T_DOC_PRICE_STR_BIU1 FOR T_DOC_PRICE_STR
ACTIVE BEFORE INSERT OR UPDATE POSITION 1
AS
declare variable v_price_id bigint;
begin
  if ((coalesce(old.f_good,0)<>coalesce(new.f_good,0)) and (new.f_good is not null)) then
  begin
    select f_price from t_doc_price where f_id=new.f_doc_price into :v_price_id;
    if (v_price_id is not null) then
      select f_value from SP_T_PRICE_GET(:v_price_id,new.f_good) into new.f_old_price;
  end
end
^

/* Trigger: T_DOC_PROPERTY_BI */
CREATE OR ALTER TRIGGER T_DOC_PROPERTY_BI FOR T_DOC_PROPERTY
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_doc_property_id,1);
end
^

/* Trigger: T_DOC_TEMPLATE_AU0 */
CREATE OR ALTER TRIGGER T_DOC_TEMPLATE_AU0 FOR T_DOC_TEMPLATE
ACTIVE AFTER UPDATE POSITION 0
AS
begin
  if (new.f_price<>old.f_price) then
    update t_doc_template_str set f_price_val=(select f_value from SP_T_PRICE_GET(NEW.F_PRICE,f_good)) where f_doc_template=new.f_id;

end
^

/* Trigger: T_DOC_TEMPLATE_BI */
CREATE OR ALTER TRIGGER T_DOC_TEMPLATE_BI FOR T_DOC_TEMPLATE
ACTIVE BEFORE INSERT POSITION 0
as
declare variable V_STATE bigint;
begin
  if (new.F_ID is null) then
    new.F_ID = gen_id(GEN_T_DOC_TEMPLATE_ID, 1);
  new.F_NUMBER = new.F_ID;
  while (char_length(new.F_NUMBER) < 7) do
  begin
    new.F_NUMBER = '0' || new.F_NUMBER;
  end
  if (new.F_STATE is null) then
  begin
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('in_doc_state')
    into :V_STATE;
    new.F_STATE = :V_STATE;
  end
  if (new.f_date is null) then
    new.f_date='now';
end
^

/* Trigger: T_DOC_TEMPLATE_STR_BI */
CREATE OR ALTER TRIGGER T_DOC_TEMPLATE_STR_BI FOR T_DOC_TEMPLATE_STR
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_doc_template_str_id,1);
end
^

/* Trigger: T_INVENTORY_AU0 */
CREATE OR ALTER TRIGGER T_INVENTORY_AU0 FOR T_INVENTORY
INACTIVE AFTER UPDATE POSITION 0
AS
begin
  if ((old.f_date_start<>new.f_date_start or old.f_date_start is null ) and (new.f_date_start is not null)) then
  begin
    insert into t_inventory_str(f_good,f_inventory,f_count_plan)
    select f_good,new.f_id,f_end_ost from SP_T_REG_GOOD_S(new.f_sklad,new.f_date_start,null);
   end
  if (new.f_date_start is null  and old.f_date_start is not null) then
  begin
    delete from t_inventory_str where f_inventory=new.f_id;
  end
end
^

/* Trigger: T_INVENTORY_BI */
CREATE OR ALTER TRIGGER T_INVENTORY_BI FOR T_INVENTORY
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_INVENTORY_ID,1);
END
^

/* Trigger: T_INVENTORY_BU0 */
CREATE OR ALTER TRIGGER T_INVENTORY_BU0 FOR T_INVENTORY
ACTIVE BEFORE UPDATE POSITION 0
AS
begin
  if (new.f_sklad is null and new.f_date_start is not null) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(2);
end
^

/* Trigger: T_INVENTORY_DOC_BI */
CREATE OR ALTER TRIGGER T_INVENTORY_DOC_BI FOR T_INVENTORY_DOC
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_INVENTORY_DOC_ID,1);
END
^

/* Trigger: T_INVENTORY_DOC_BUD0 */
CREATE OR ALTER TRIGGER T_INVENTORY_DOC_BUD0 FOR T_INVENTORY_DOC
ACTIVE BEFORE UPDATE OR DELETE POSITION 0
AS
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (old.f_state>=f_sys_st and coalesce(new.f_state,old.f_state)=old.f_state and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end
end
^

/* Trigger: T_INVENTORY_DOC_STR_AIUD0 */
CREATE OR ALTER TRIGGER T_INVENTORY_DOC_STR_AIUD0 FOR T_INVENTORY_DOC_STR
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 0
AS
begin
  if (coalesce(new.f_count,0)<>coalesce(old.f_count,0)) then
  begin
    update t_inventory_doc set f_doc_count=coalesce(f_doc_count,0)-coalesce(old.f_count,0)+coalesce(new.f_count,0) where f_id=
      iif(deleting,old.f_inventory_doc,new.f_inventory_doc);
  end
/*  if (DELETING) then
  begin
    update t_inventory_doc set f_doc_count=coalesce(f_doc_count,0)-coalesce(old.f_count,0) where f_id=old.f_inventory_doc;
  end*/
end
^

/* Trigger: T_INVENTORY_DOC_STR_BI */
CREATE OR ALTER TRIGGER T_INVENTORY_DOC_STR_BI FOR T_INVENTORY_DOC_STR
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_INVENTORY_DOC_STR_ID,1);
END
^

/* Trigger: T_INVENTORY_STR_BI */
CREATE OR ALTER TRIGGER T_INVENTORY_STR_BI FOR T_INVENTORY_STR
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_INVENTORY_STR_ID,1);
END
^

/* Trigger: T_MONEY_IN_AU0 */
CREATE OR ALTER TRIGGER T_MONEY_IN_AU0 FOR T_MONEY_IN
ACTIVE AFTER UPDATE POSITION 0
as
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (new.f_state>=f_sys_st and old.f_state<f_sys_st) then
  begin
  /* Trigger text */
    execute procedure SP_T_REG_PARTNER_SET(new.f_partner,new.f_date,3,(new.f_summa));
  end
  if (new.f_state<f_sys_st and old.f_state>=f_sys_st) then
  begin
    execute procedure SP_T_REG_PARTNER_SET(old.f_partner,old.f_date,3,(old.f_summa*-1));
  end
end
^

/* Trigger: T_MONEY_IN_BUD0 */
CREATE OR ALTER TRIGGER T_MONEY_IN_BUD0 FOR T_MONEY_IN
ACTIVE BEFORE UPDATE OR DELETE POSITION 0
as
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (old.f_state>=f_sys_st and coalesce(new.f_state,old.f_state)=old.f_state and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end
end
^

/* Trigger: T_MONEY_IN_BU_CHECK */
CREATE OR ALTER TRIGGER T_MONEY_IN_BU_CHECK FOR T_MONEY_IN
ACTIVE BEFORE UPDATE POSITION 0
AS
begin
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_MONEY_IN') where f_result='UPD') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
end
^

/* Trigger: T_MONEY_IN_STR_BIUD0 */
CREATE OR ALTER TRIGGER T_MONEY_IN_STR_BIUD0 FOR T_MONEY_IN_STR
ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 0
AS
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (exists(select f_id from t_money_in m where m.f_id=new.f_money and m.f_state=:f_sys_st) and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end

end
^

/* Trigger: T_MONEY_OUT_AU0 */
CREATE OR ALTER TRIGGER T_MONEY_OUT_AU0 FOR T_MONEY_OUT
ACTIVE AFTER UPDATE POSITION 0
as
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (new.f_state>=f_sys_st and old.f_state<f_sys_st) then
  begin
  /* Trigger text */
    execute procedure SP_T_REG_PARTNER_SET(new.f_partner,new.f_date,4,(new.f_summa));
  end
  if (new.f_state<f_sys_st and old.f_state>=f_sys_st) then
  begin
    execute procedure SP_T_REG_PARTNER_SET(new.f_partner,new.f_date,4,(old.f_summa*-1));
  end
end
^

/* Trigger: T_MONEY_OUT_BUD0 */
CREATE OR ALTER TRIGGER T_MONEY_OUT_BUD0 FOR T_MONEY_OUT
ACTIVE BEFORE UPDATE OR DELETE POSITION 0
as
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (old.f_state>=f_sys_st and coalesce(new.f_state,old.f_state)=old.f_state and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end
end
^

/* Trigger: T_MONEY_OUT_STR_BIUD0 */
CREATE OR ALTER TRIGGER T_MONEY_OUT_STR_BIUD0 FOR T_MONEY_OUT_STR
ACTIVE BEFORE INSERT OR UPDATE OR DELETE POSITION 0
AS
declare variable f_sys_st bigint;
declare variable f_check_zapas bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :f_check_zapas;
  if (exists(select f_id from t_money_out m where m.f_id=new.f_money and m.f_state=:f_sys_st) and f_check_zapas=1) then
  begin
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
  end

end
^

/* Trigger: T_NSI_DISCOUNT_CARD_BI */
CREATE OR ALTER TRIGGER T_NSI_DISCOUNT_CARD_BI FOR T_NSI_DISCOUNT_CARD
ACTIVE BEFORE INSERT POSITION 0
as
declare variable V_SKLAD bigint;
declare variable V_PREFIX varchar(2);
declare variable V_DISCOUNT numeric(15,3);
begin
  if (new.F_ID is null) then
    new.F_ID = gen_id(GEN_T_NSI_DISCOUNT_CARD_ID, 1);
  new.F_NUMBER = new.F_ID;
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('default_sklad')
  into :V_SKLAD;
  select F_PREFIX
  from SP_T_NSI_SKLAD_GET(:V_SKLAD)
  into :V_PREFIX;
  while (char_length(new.F_NUMBER) < 7) do
  begin
    new.F_NUMBER = '0' || new.F_NUMBER;
  end
  new.F_NUMBER = coalesce(V_PREFIX, '') || new.F_NUMBER;
  if (new.F_DISCOUNT is null) then
  begin
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('def_discount')
    into :V_DISCOUNT;
    new.F_DISCOUNT = :V_DISCOUNT;
  end
end
^

/* Trigger: T_NSI_DOC_IN_TYPES_BI */
CREATE OR ALTER TRIGGER T_NSI_DOC_IN_TYPES_BI FOR T_NSI_DOC_IN_TYPES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_DOC_IN_TYPES_ID,1);
END
^

/* Trigger: T_NSI_DOC_MOVE_TYPES_BI */
CREATE OR ALTER TRIGGER T_NSI_DOC_MOVE_TYPES_BI FOR T_NSI_DOC_MOVE_TYPES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_DOC_MOVE_TYPES_ID,1);
END
^

/* Trigger: T_NSI_DOC_OUT_TYPES_BI */
CREATE OR ALTER TRIGGER T_NSI_DOC_OUT_TYPES_BI FOR T_NSI_DOC_OUT_TYPES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_DOC_OUT_TYPES_ID,1);
END
^

/* Trigger: T_NSI_DOC_PROPERTY_BI */
CREATE OR ALTER TRIGGER T_NSI_DOC_PROPERTY_BI FOR T_NSI_DOC_PROPERTY
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_doc_property_id,1);
end
^

/* Trigger: T_NSI_DOC_PROPERTY_VAL_BI */
CREATE OR ALTER TRIGGER T_NSI_DOC_PROPERTY_VAL_BI FOR T_NSI_DOC_PROPERTY_VAL
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_doc_property_val_id,1);
end
^

/* Trigger: T_NSI_ED_IZM_BI */
CREATE OR ALTER TRIGGER T_NSI_ED_IZM_BI FOR T_NSI_ED_IZM
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_ED_IZM_ID,1);
END
^

/* Trigger: T_NSI_GOODS_AI0 */
CREATE OR ALTER TRIGGER T_NSI_GOODS_AI0 FOR T_NSI_GOODS
ACTIVE AFTER INSERT POSITION 0
AS
begin
  /* Trigger text */
  execute procedure sp_t_nsi_scancode_i(null, null,new.f_id,1);
end
^

/* Trigger: T_NSI_GOODS_AIUD0 */
CREATE OR ALTER TRIGGER T_NSI_GOODS_AIUD0 FOR T_NSI_GOODS
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 0
AS
begin
--  post_event 'refresh_goods';
  if (coalesce(new.f_name,'') <> coalesce(old.f_name,'') or coalesce(new.f_article,'')<>
    coalesce(old.f_article,'') or coalesce(new.f_state,0)<>coalesce(old.f_state,0)) then
    execute procedure PR_POST_EVENT_GOOD;
end
^

/* Trigger: T_NSI_GOODS_BU0 */
CREATE OR ALTER TRIGGER T_NSI_GOODS_BU0 FOR T_NSI_GOODS
ACTIVE BEFORE UPDATE POSITION 0
AS
begin
  if (coalesce(new.f_name,'')<>coalesce(old.f_name, '')
    or coalesce(new.f_goods_grp ,0)<>coalesce(old.f_goods_grp , 0)
    or coalesce(new.f_dop_info,'')<>coalesce(old.f_dop_info , '')) then
  new.f_ch_date='now';
end
^

/* Trigger: T_NSI_GOODS_DOP_INFO_BI */
CREATE OR ALTER TRIGGER T_NSI_GOODS_DOP_INFO_BI FOR T_NSI_GOODS_DOP_INFO
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_goods_dop_info_id,1);
end
^

/* Trigger: T_NSI_GOODS_INFO_BI */
CREATE OR ALTER TRIGGER T_NSI_GOODS_INFO_BI FOR T_NSI_GOODS_INFO
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_goods_info_id,1);
end
^

/* Trigger: T_NSI_GOODS_INFO_STR_BI */
CREATE OR ALTER TRIGGER T_NSI_GOODS_INFO_STR_BI FOR T_NSI_GOODS_INFO_STR
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_goods_info_str_id,1);
end
^

/* Trigger: T_NSI_GOODS_LINKS_BI */
CREATE OR ALTER TRIGGER T_NSI_GOODS_LINKS_BI FOR T_NSI_GOODS_LINKS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_goods_links_id,1);
end
^

/* Trigger: T_NSI_GOODS_LINK_POS_BI */
CREATE OR ALTER TRIGGER T_NSI_GOODS_LINK_POS_BI FOR T_NSI_GOODS_LINK_POS
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_goods_link_pos_id,1);
end
^

/* Trigger: T_NSI_GOODS_MMEDIA_BI */
CREATE OR ALTER TRIGGER T_NSI_GOODS_MMEDIA_BI FOR T_NSI_GOODS_MMEDIA
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_goods_mmedia_id,1);
end
^

/* Trigger: T_NSI_GOODS_MMEDIA_BU0 */
CREATE OR ALTER TRIGGER T_NSI_GOODS_MMEDIA_BU0 FOR T_NSI_GOODS_MMEDIA
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
begin
  new.f_ch_date = 'now';
end
^

/* Trigger: T_NSI_GOODS_MMEDIA_MAP_BI */
CREATE OR ALTER TRIGGER T_NSI_GOODS_MMEDIA_MAP_BI FOR T_NSI_GOODS_MMEDIA_MAP
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_goods_mmedia_map_id,1);
end
^

/* Trigger: T_NSI_GOOD_PARTY_BI */
CREATE OR ALTER TRIGGER T_NSI_GOOD_PARTY_BI FOR T_NSI_GOOD_PARTY
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_GOOD_PARTY_ID,1);
END
^

/* Trigger: T_NSI_GOOD_TYPE_BI */
CREATE OR ALTER TRIGGER T_NSI_GOOD_TYPE_BI FOR T_NSI_GOOD_TYPE
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_good_type_id,1);
end
^

/* Trigger: T_NSI_INFO_NAME_BI */
CREATE OR ALTER TRIGGER T_NSI_INFO_NAME_BI FOR T_NSI_INFO_NAME
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_INFO_NAME_ID,1);
END
^

/* Trigger: T_NSI_MONEY_IN_TYPES_BI */
CREATE OR ALTER TRIGGER T_NSI_MONEY_IN_TYPES_BI FOR T_NSI_MONEY_IN_TYPES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_MONEY_IN_TYPES_ID,1);
END
^

/* Trigger: T_NSI_OBJECTS_BI */
CREATE OR ALTER TRIGGER T_NSI_OBJECTS_BI FOR T_NSI_OBJECTS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_OBJECTS_ID,1);
END
^

/* Trigger: T_NSI_PARTNER_CARD_BI */
CREATE OR ALTER TRIGGER T_NSI_PARTNER_CARD_BI FOR T_NSI_PARTNER_CARD
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.F_ID is null) then
    new.F_ID = gen_id(GEN_T_NSI_PARTNER_CARD_ID, 1);
  new.F_USER = current_user;
  new.F_TIMESTAMP = 'now';
end
^

/* Trigger: T_NSI_PARTNER_DISCOUNT_CARD_BI */
CREATE OR ALTER TRIGGER T_NSI_PARTNER_DISCOUNT_CARD_BI FOR T_NSI_PARTNER_DISCOUNT_CARD
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_partner_discount_card,1);
end
^

/* Trigger: T_NSI_PARTNER_INFO_BI */
CREATE OR ALTER TRIGGER T_NSI_PARTNER_INFO_BI FOR T_NSI_PARTNER_INFO
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_PARTNER_INFO_ID,1);
END
^

/* Trigger: T_NSI_PRICE_STR_BI */
CREATE OR ALTER TRIGGER T_NSI_PRICE_STR_BI FOR T_NSI_PRICE_STR
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_price_str_id,1);
end
^

/* Trigger: T_NSI_SCANCODE_BI */
CREATE OR ALTER TRIGGER T_NSI_SCANCODE_BI FOR T_NSI_SCANCODE
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable v_scnancode varchar(9);
declare variable v_genval    bigint;
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_SCANCODE_ID,1);
  v_genval=new.f_id;
  if (new.f_value is null) then
  begin
    while (NEW.F_VALUE is null) do
    begin
      v_scnancode=substring(cast(100000000+v_genval as varchar(9)) from 2);
      if (not exists(select f_id from t_nsi_scancode where f_value=:v_scnancode)) then
        new.f_value=v_scnancode;
      else
        v_genval=GEN_ID(GEN_T_NSI_SCANCODE_ID,1);
    end
  end
END
^

/* Trigger: T_NSI_SKIDKA_BI */
CREATE OR ALTER TRIGGER T_NSI_SKIDKA_BI FOR T_NSI_SKIDKA
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.F_ID IS NULL) THEN
    NEW.F_ID = GEN_ID(GEN_T_NSI_SKIDKA_ID,1);
END
^

/* Trigger: T_NSI_STATE_NSI_BI */
CREATE OR ALTER TRIGGER T_NSI_STATE_NSI_BI FOR T_NSI_STATE_NSI
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_nsi_state_nsi_id,1);
end
^

/* Trigger: T_OST_BI */
CREATE OR ALTER TRIGGER T_OST_BI FOR T_OST
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_ost_id,1);
end
^

/* Trigger: T_OST_PARTY_BI0 */
CREATE OR ALTER TRIGGER T_OST_PARTY_BI0 FOR T_OST_PARTY
ACTIVE BEFORE INSERT POSITION 0
AS
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_ost_party,1);
end
^

/* Trigger: T_PRICE_AI0 */
CREATE OR ALTER TRIGGER T_PRICE_AI0 FOR T_PRICE
ACTIVE AFTER INSERT POSITION 0
AS
  declare variable f__id   bigint;
begin
  for
    select f_id
    from
      t_price
    where
      f_good=new.f_good and f_price=new.f_price
      and f_id<>new.f_id
      and f_active=1
    into
      :f__id do
  begin
--    if ((exists(select 1 from t_doc_in_str d where d.f_price=:f__id)) or (exists(select 1 from t_doc_out_str d where d.f_price=:f__id))) then
      update t_price set f_active=0 where f_id=:f__id and f_active=1;
--    else
--      delete from t_price where f_id=:f__id;
  end
end
^

/* Trigger: T_REG_GOOD_AIUD0 */
CREATE OR ALTER TRIGGER T_REG_GOOD_AIUD0 FOR T_REG_GOOD
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 0
as
declare variable V_ID bigint;
declare variable V_DATE date;
begin
  if (coalesce(new.F_MOVE_IN, 0) <> coalesce(old.F_MOVE_IN, 0)) then
  begin
    update T_REG_GOOD
    set F_STR_OST = coalesce(F_STR_OST, 0) - coalesce(old.F_MOVE_IN, 0)
    where F_GOOD = old.F_GOOD and
          F_SKLAD = old.F_SKLAD and
          F_DATE > old.F_DATE;
    update T_REG_GOOD
    set F_STR_OST = coalesce(F_STR_OST, 0) + coalesce(new.F_MOVE_IN, 0)
    where F_GOOD = new.F_GOOD and
          F_SKLAD = new.F_SKLAD and
          F_DATE > new.F_DATE;
  end
  if (coalesce(new.F_MOVE_OUT, 0) <> coalesce(old.F_MOVE_OUT, 0)) then
  begin
    update T_REG_GOOD
    set F_STR_OST = coalesce(F_STR_OST, 0) + coalesce(old.F_MOVE_OUT, 0)
    where F_GOOD = old.F_GOOD and
          F_SKLAD = old.F_SKLAD and
          F_DATE > old.F_DATE;
    update T_REG_GOOD
    set F_STR_OST = coalesce(F_STR_OST, 0) - coalesce(new.F_MOVE_OUT, 0)
    where F_GOOD = new.F_GOOD and
          F_SKLAD = new.F_SKLAD and
          F_DATE > new.F_DATE;
  end
  select F_DATE, F_ID
  from T_OST
  where F_GOOD = new.F_GOOD and
        F_SKLAD = new.F_SKLAD
  into :V_DATE, :V_ID;
  if (V_ID is null) then
  begin
    insert into t_OST (F_GOOD, F_SKLAD, F_DATE, F_END_OST)
    values (new.F_GOOD, new.F_SKLAD, new.F_DATE, new.F_END_OST);
  end
  else
  if (V_DATE <= new.F_DATE) then
    update T_OST
    set F_END_OST = new.F_END_OST,
      f_date=new.f_date
    where F_ID = :V_ID;
end
^

/* Trigger: T_REG_GOOD_BIU0 */
CREATE OR ALTER TRIGGER T_REG_GOOD_BIU0 FOR T_REG_GOOD
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
begin
  /* Trigger text */
  new.f_ch_date='now';
end
^

/* Trigger: T_REG_PARTNER_AIUD0 */
CREATE OR ALTER TRIGGER T_REG_PARTNER_AIUD0 FOR T_REG_PARTNER
ACTIVE AFTER INSERT OR UPDATE OR DELETE POSITION 0
AS
begin
  if (coalesce(new.f_doc_in_sum,0)<>coalesce(old.f_doc_in_sum,0)) then
  begin
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)-coalesce(old.f_doc_in_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)+coalesce(new.f_doc_in_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
  end

  if (coalesce(new.f_doc_out_sum,0)<>coalesce(old.f_doc_out_sum,0)) then
  begin
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)+coalesce(old.f_doc_out_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)-coalesce(new.f_doc_out_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
  end

  if (coalesce(new.f_money_in_sum,0)<>coalesce(old.f_money_in_sum,0)) then
  begin
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)-coalesce(old.f_money_in_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)+coalesce(new.f_money_in_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
  end

  if (coalesce(new.f_money_out_sum,0)<>coalesce(old.f_money_out_sum,0)) then
  begin
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)+coalesce(old.f_money_out_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
    update t_reg_partner set f_str_ost=coalesce(f_str_ost,0)-coalesce(new.f_money_out_sum,0)
    where
        f_partner=old.f_partner
        and f_date>old.f_date;
  end

end
^

/* Trigger: T_REG_PARTNER_BI */
CREATE OR ALTER TRIGGER T_REG_PARTNER_BI FOR T_REG_PARTNER
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_reg_partner_id,1);
  select g.f_end_ost from t_reg_partner g where
    g.f_partner=new.f_partner
    and g.f_date=(select max(s.f_date) from t_reg_partner s where s.f_partner=new.f_partner
        and s.f_partner=new.f_partner and s.f_date<new.f_date)
    into new.f_str_ost;
   new.f_str_ost=coalesce(new.f_str_ost,0);

end
^

/* Trigger: T_SYS_SOURCE_DBASE_BI */
CREATE OR ALTER TRIGGER T_SYS_SOURCE_DBASE_BI FOR T_SYS_SOURCE_DBASE
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_sys_source_dbase_id,1);
end
^

/* Trigger: T_USER_BUFER_BI */
CREATE OR ALTER TRIGGER T_USER_BUFER_BI FOR T_USER_BUFER
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.f_id is null) then
    new.f_id = gen_id(gen_t_user_bufer_id,1);
end
^

SET TERM ; ^



/******************************************************************************/
/***                           Stored Procedures                            ***/
/******************************************************************************/


SET TERM ^ ;

CREATE OR ALTER PROCEDURE IS_INT (
    STRNUM VARCHAR(255))
RETURNS (
    IR INTEGER)
AS
declare variable IPINT integer;
begin
    IR=0;
    ipINT=CAST (STRNUM AS INTEGER);
    IR=ipINT;
    SUSPEND;
WHEN ANY DO
    BEGIN
       IR=NULL;
       SUSPEND;
    end
end^


CREATE OR ALTER PROCEDURE PR_CONVERT_CYR_STR (
    INP_STR VARCHAR(255))
RETURNS (
    OUT_STR VARCHAR(255))
AS
declare variable SRC_ALPH varchar(255);
declare variable DST_ALPH varchar(255);
declare variable I numeric(15,2);
begin
  /* Procedure Text */
  SRC_ALPH='/\';
  dst_alph='__abvgdeegziklmnoprstufhc4444euy';
  i=1;
  out_str=inp_str;
  while (i<255) do
  begin
    out_str=replace(out_str,substring(src_alph from i for 1),substring(dst_alph from i for 1));
    out_str=replace(out_str,upper(substring(src_alph from i for 1)),upper(substring(dst_alph from i for 1)));
    i=i+1;
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_DATE_TO_STR (
    F_DATE DATE)
RETURNS (
    F_VALUE VARCHAR(20))
AS
DECLARE VARIABLE V_DAY VARCHAR(2);
DECLARE VARIABLE V_MONTH VARCHAR(2);
DECLARE VARIABLE V_YEAR VARCHAR(4);
begin
  v_day=cast(extract(day from f_date) as varchar(2));
  if (v_day<10) then
    v_day='0'||v_day;
  v_month=cast(extract(month from f_date) as varchar(2));
  if (v_month<10) then
    v_month='0'||v_month;
  v_year=cast(extract(year from f_date) as varchar(4));
  f_value=v_day||'.'||v_month||'.'||v_year;
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_EXEC_EXCEPTION (
    F_ERR_CODE INTEGER)
AS
declare variable V_EXECPT_MSG varchar(255);
begin
  select f_msg from f_messages where f_id=:f_err_code into :v_execpt_msg;
  if (exists(select f_msg from f_messages where f_id=:f_err_code)) then
    exception ex_error :v_execpt_msg;
end^


CREATE OR ALTER PROCEDURE PR_EXPORT_DISCOUNT_CARD
RETURNS (
    F_VALUE VARCHAR(10000))
AS
begin
  f_value='<NSI_DISCOUNT_CARDS>';
  suspend;
  for
  select '<Discount_card NUMBER="'||f_number||'" DISCOUNT="'||f_discount||'"/>'
  from sp_t_nsi_discount_card_s
  into :f_value do
    suspend;
  f_value='</NSI_DISCOUNT_CARDS>';
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_EXPORT_DOC_IN (
    F_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
declare variable F_GOOD_ID bigint;
begin
  select
    '<Document MoveType="DOC_IN" Id="'||f_id||'" DocType="'||f_doc_type||'">'||
    '<wbNumber>'||coalesce(f_number,f_id)||'</wbNumber>'||
    '<wbDate>'||(select f_value from pr_date_to_str(f_date))||'</wbDate>'||
    '<wbSum>'||coalesce(f_doc_sum,coalesce((select sum(s.f_sum) from t_doc_in_str s where s.f_id=g.f_id),0))||'</wbSum>'||
--    '<Recipient>'||
    (select f_xml from sp_t_nsi_sklad_get(f_sklad))||
--    '</Recipient>'||
--    '<Sender>'||
    (select f_xml from sp_t_nsi_partner_get(f_partner))||
--    '</Sender>'||
    '<DocUser>'||F_USER||'</DocUser>'||
    '<DocBody>'
  from sp_t_doc_in_get(:f_id) g
  into :f_value;
  suspend;
  for select
    f_good,
    '<Pos>'||
    '<Price>'||(select f_result from sp_round(f_price_val,0.01))||'</Price>'||
    '<Kol>'||(select f_result from sp_round(f_cnt,0.01))||'</Kol>'||
    '<Summ>'||(select f_result from sp_round(f_sum,0.01))||'</Summ>'
  from sp_t_doc_in_str_s(:f_id)
  into
    :f_good_id,:f_value do
  begin
    suspend;
    for select f_value from SP_T_NSI_GOODS_XML(:f_good_id) into :f_value do
    begin
      suspend;
    end
    f_value='</Pos>';
    suspend;
  end
  f_value='</DocBody></Document>';
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_EXPORT_DOC_MOVE (
    F_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
declare variable F_GOOD_ID bigint;
begin
  select
    '<Document MoveType="DOC_MOVE" Id="'||f_id||'" DocType="1">'||
    '<wbNumber>'||coalesce(f_number,f_id)||'</wbNumber>'||
    '<wbDate>'||(select f_value from pr_date_to_str(f_date))||'</wbDate>'||
    '<wbSum>'||coalesce(f_doc_sum,coalesce((select sum(s.f_sum) from t_doc_move_str s where s.f_doc_move=g.f_id),0))||'</wbSum>'||
    '<Recipient>'||
    (select f_xml from sp_t_nsi_sklad_get(f_sklad_to))||
    '</Recipient>'||
    '<Sender>'||
    (select f_xml from sp_t_nsi_sklad_get(f_sklad_from))||
    '</Sender>'||
    (
    select
      case
        when coalesce(f_partner,0)>0 then
          (select f_xml from sp_t_nsi_partner_get(f_partner))
        else ''
      end
    from
     sp_t_nsi_sklad_get(f_sklad_from)
     )||
    '<DocUser>'||F_USER||'</DocUser>'||
    '<DocBody>'
  from sp_t_doc_move_get(:f_id) g
  into :f_value;
  suspend;
  for select
    f_good,
    '<Pos>'||
    '<Price>'||(select f_result from sp_round(f_price_val,0.01))||'</Price>'||
    '<Kol>'||(select f_result from sp_round(f_cnt,0.01))||'</Kol>'||
    '<Summ>'||(select f_result from sp_round(f_sum,0.01))||'</Summ>'
  from sp_t_doc_move_str_s(:f_id)
  into
    :f_good_id,:f_value do
  begin
    suspend;
    for select f_value from SP_T_NSI_GOODS_XML(:f_good_id) into :f_value do
    begin
      suspend;
    end
    f_value='</Pos>';
    suspend;
  end
  f_value='</DocBody></Document>';
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_EXPORT_DOC_OUT (
    F_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
declare variable F_GOOD_ID bigint;
begin
  select
    '<Document MoveType="DOC_OUT" Id="'||f_id||'" DocType="'||coalesce(f_type,1)||'">'||
    '<wbNumber>'||coalesce(f_number,f_id)||'</wbNumber>'||
    '<wbDate>'||(select f_value from pr_date_to_str(f_date))||'</wbDate>'||
    '<wbSum>'||coalesce(f_doc_sum,coalesce((select sum(s.f_sum) from t_doc_out_str s where s.f_doc_out=g.f_id),0))||'</wbSum>'||
    coalesce('<Discount_card>'||f_discount_card||'</Discount_card>','')||
--    '<Recipient>'||
    (select f_xml from sp_t_nsi_sklad_get(f_sklad))||
--    '</Recipient>'||
--    '<Sender>'||
    (select f_xml from sp_t_nsi_partner_get(f_partner))||
--    '</Sender>'||
    '<DocUser>'||F_USER||'</DocUser>'||
    '<DocBody>'

  from sp_t_doc_out_get(:f_id) g
  into :f_value;
  suspend;
  for select
    f_good,
    '<Pos>'||
    '<Price>'||(select f_result from sp_round(f_price_val,0.01))||'</Price>'||

    '<Skidka>'||(select f_result from sp_round(f_skidka,0.01))||'</Skidka>'||
    '<Kol>'||(select f_result from sp_round(f_cnt,0.01))||'</Kol>'||
    '<Summ>'||(select f_result from sp_round(f_sum,0.01))||'</Summ>'
  from sp_t_doc_out_str_s(:f_id)
  into
    :f_good_id,:f_value do
  begin
    suspend;
    for select f_value from SP_T_NSI_GOODS_XML(:f_good_id) into :f_value do
    begin
      suspend;
    end
    f_value='</Pos>';
    suspend;
  end
  f_value='</DocBody></Document>';
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_EXPORT_DOCS_BY_PERIOD (
    P_START_DATE DATE,
    P_END_DATE DATE)
RETURNS (
    V_RESULT VARCHAR(10000))
AS
declare variable VAR_ID bigint;
declare variable F_SYS_ST bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  for select f_id from t_doc_in where f_date between :p_start_date and :p_end_date and f_state>=:f_sys_st into :var_id do
  begin
    for select f_value from pr_export_doc_in(:var_id) into :v_result do
      suspend;
  end
  for select f_id from t_doc_out where f_date between :p_start_date and :p_end_date and f_state>=:f_sys_st into :var_id do
  begin
    for select f_value from pr_export_doc_out(:var_id) into :v_result do
      suspend;
  end
  for select f_id from t_doc_move where f_date between :p_start_date and :p_end_date and f_state>=:f_sys_st into :var_id do
  begin
    for select f_value from pr_export_doc_move(:var_id) into :v_result do
      suspend;
  end

end^


CREATE OR ALTER PROCEDURE PR_EXPORT_INVENTORY (
    P_ID BIGINT)
RETURNS (
    R_VALUE VARCHAR(10000))
AS
DECLARE VARIABLE V_ID BIGINT;
DECLARE VARIABLE V_GOOD BIGINT;
begin
  select
   '<Inventory Id="'||f_id||'">'||
   '<wbNumber>'||coalesce(f_number,f_id)||'</wbNumber>'||
   '<wbDate>'||(select f_value from pr_date_to_str(f_date_start))||'</wbDate>'||
   '<Sklad id="'||f_sklad||'" name="'||f_sklad_name||'"/>'
  from
   sp_t_inventory_get(:p_id)
  into :r_value;
  suspend;
  for
    select
      f_id,
      '<InventoryDoc Id="'||f_id||'">'||
      '<wbNumber>'||coalesce(f_number,f_id)||'</wbNumber>'||
      '<Manager>'||coalesce(f_manager,'')||'</Manager>'
    from
      sp_t_inventory_doc_s(:p_id)
    into :v_id, :r_value do
  begin
    suspend;
    for
      select
        f_good,
        '<Pos>'||
        '<Kol>'||(select f_result from sp_round(f_count,0.01))||'</Kol>'||
        '<Good id="'||f_good||'"> '||
        '<name> <![CDATA['||f_good_name||']]></name>'||
        '<article> <![CDATA['||f_good_article||']]></article>'
      from
        sp_t_inventory_doc_str_s(:v_id)
      into :v_good,:r_value do
    begin
      suspend;
      for
        select '<ScanCode>'||f_value||'</ScanCode>'
        from SP_T_NSI_SCANCODE_S_BY_GOOD(:v_good)
        into :r_value do
      begin
        suspend;
      end
      r_value='</Good></Pos>';
      suspend;
    end
    r_value='</InventoryDoc>';
    suspend;
  end
  r_value='</Inventory>';
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_EXPORT_PRICE_BY_DOC_OUT (
    F_DOC_OUT BIGINT,
    F_PRICE_ID BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
begin
  select '<Doc_price f_number="'||f_number||'" price_id="'||:f_price_id||'"' from t_doc_out where f_id=:f_doc_out into :f_value;
  suspend;
  select ' price_name="'||f_name||'">' from t_nsi_price where f_id=:f_price_id into :f_value;
  suspend;
  for
    select
        '<Good id="'||f_good||'"> '||
        '<article> <![CDATA['||f_article||']]></article>'||
        '<name> <![CDATA['||f_good_name||']]></name>'||
/*        '<article>' ||f_article||'</article>'||
        '<name>' ||f_good_name||'</name>'||*/

        '<f_value>'||(select f_value from sp_t_price_get(:f_price_id,f_good))||'</f_value></Good>'
    from sp_t_doc_out_str_s(:f_doc_out) into :f_value do
    begin
      suspend;
    end
  f_value='</Doc_price>';
  suspend;
end^


CREATE OR ALTER PROCEDURE PR_GET_CHANGED_GOOD (
    F_SKLAD BIGINT,
    F_PRICE1 BIGINT,
    F_PRICE2 BIGINT,
    F_DATE DATE)
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(20),
    F_NAME VARCHAR(255),
    F_DOP_INFO VARCHAR(255),
    F_PRICE1_VAL NUMERIC(15,3),
    F_PRICE2_VAL NUMERIC(15,3),
    F_GRP_NAME VARCHAR(60),
    F_GRP_ID BIGINT,
    F_GRP_DOP_INFO VARCHAR(10000),
    F_GRP_EXT_ID VARCHAR(20),
    F_END_OST NUMERIC(15,3))
AS
begin
   for select distinct f_good from t_reg_good where f_sklad=:f_sklad
      and f_ch_date>=:f_date
    union
    select distinct f_good from t_price where f_price=:f_price1
      and f_str_date>=:f_date
    union
    select distinct f_good from t_price where f_price=:f_price2
      and f_str_date>=:f_date
    union
    select distinct f_id from T_NSI_GOODS where f_ch_date>=:f_date
    union
    select distinct f_good from T_NSI_GOODS_MMEDIA where f_ch_date>=:f_date into :f_good do
    begin
      select
        f_name,
        f_article,
        f_dop_info, 
        f_goods_grp,
        f_goods_grp_name,
        f_goods_grp_ext_id
      from SP_T_NSI_GOODS_GET(:f_good,null)
      into
        :f_name,
        :f_article,
        :f_dop_info,
        :f_grp_id,
        :f_grp_name,
        :f_grp_ext_id;
      f_price1_val=null;
      select f_value from sp_t_price_get(:f_price1,:f_good) into :f_price1_val;
      f_price2_val=null;
      select f_value from sp_t_price_get(:f_price2,:f_good) into :f_price2_val;
      f_grp_dop_info=null;
      select f_dop_info from t_nsi_goods_grp where f_id=:f_grp_id into :f_grp_dop_info;
      f_end_ost=0;
      select f_end_ost from SP_T_REG_GOOD_GET(:f_good,'now',:f_sklad) into :f_end_ost;
      suspend;
    end
end^


CREATE OR ALTER PROCEDURE PR_NSI_SCANCODE_GET (
    SCAN_ID BIGINT,
    F_SCANVALUE VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT,
    F_GOODNAME VARCHAR(255))
AS
DECLARE VARIABLE CNT INTEGER;
begin /*$$IBE$$ 
  cnt=0;
  for select
        f_id,
        f_value,
        f_good,
        f_count
      from
        t_nsi_scancode
      where
        f_id=:scan_id
      union
      select
        f_id,
        f_value,
        f_good,
        f_count
      from
        t_nsi_scancode
      where
        f_value=:f_scanvalue
      into
        :f_id,
        :f_value,
        :f_good,
        :f_count
      do
      begin
        if (coalesce(f_good,-1)>0) then
          select f_name from sp_t_nsi_goods_get(:f_good, null) into :f_goodname;
        cnt=cnt+1;
        suspend;
      end
      if (cnt=0) then
      begin
        f_id=GEN_ID(GEN_T_NSI_SCANCODE_ID,1);
        f_value=f_scanvalue;
        execute procedure SP_T_NSI_SCANCODE_I(:f_id,:f_value,null, null);
      end
 $$IBE$$*/ EXIT;
end^


CREATE OR ALTER PROCEDURE PR_POST_EVENT_GOOD
AS
begin
  post_event 'refresh_goods';
end^


CREATE OR ALTER PROCEDURE PR_SET_SYS_PRIV (
    P_TABLE_NAME VARCHAR(60) NOT NULL,
    P_USR VARCHAR(60) NOT NULL,
    P_TYPE VARCHAR(20),
    P_STATE VARCHAR(20),
    P_SEL SMALLINT = 0,
    P_INS SMALLINT = 0,
    P_DEL SMALLINT = 0,
    P_UPD SMALLINT = 0)
AS
declare variable V_STATE varchar(20);
begin
  for select f_id from t_nsi_state
    where f_id = (coalesce(:p_state,f_id))
    into :v_state do
  begin
    if (p_sel=1) then
      UPDATE OR INSERT INTO t_sys_privs(f_table_name,f_usr,f_priv,f_type,f_state)
        values(:p_table_name,:p_usr,'SEL',:p_type,:v_state)
        matching(f_table_name,f_usr,f_priv,f_type,f_state);
    if (p_sel=0) then
      delete from t_sys_privs where
        f_table_name = :p_table_name
        and f_usr = :p_usr
        and f_priv = 'SEL'
        and f_type = coalesce(:p_type,f_type)
        and f_state = :v_state;
    if (p_upd=1) then
      UPDATE OR INSERT INTO t_sys_privs(f_table_name,f_usr,f_priv,f_type,f_state)
        values(:p_table_name,:p_usr,'UPD',:p_type,:v_state)
        matching(f_table_name,f_usr,f_priv,f_type,f_state);
    if (p_upd=0) then
      delete from t_sys_privs where
        f_table_name = :p_table_name
        and f_usr = :p_usr
        and f_priv = 'UPD'
        and f_type = coalesce(:p_type,f_type)
        and f_state = :v_state;

    if (p_ins=1) then
      UPDATE OR INSERT INTO t_sys_privs(f_table_name,f_usr,f_priv,f_type,f_state)
        values(:p_table_name,:p_usr,'INS',:p_type,:v_state)
        matching(f_table_name,f_usr,f_priv,f_type,f_state);
    if (p_ins=0) then
      delete from t_sys_privs where
        f_table_name = :p_table_name
        and f_usr = :p_usr
        and f_priv = 'INS'
        and f_type = coalesce(:p_type,f_type)
        and f_state = :v_state;

    if (p_del=1) then
      UPDATE OR INSERT INTO t_sys_privs(f_table_name,f_usr,f_priv,f_type,f_state)
        values(:p_table_name,:p_usr,'DEL',:p_type,:v_state)
        matching(f_table_name,f_usr,f_priv,f_type,f_state);
    if (p_del=0) then
      delete from t_sys_privs where
        f_table_name = :p_table_name
        and f_usr = :p_usr
        and f_priv = 'DEL'
        and f_type = coalesce(:p_type,f_type)
        and f_state = :v_state;

  end
end^


CREATE OR ALTER PROCEDURE SP_CALC_DOC_OUT_PARTY (
    P_STR_DATE DATE,
    P_END_DATE DATE)
AS
declare variable V_ID bigint;
begin
  for select
    d.f_id
    from
    t_doc_out d
    where
      d.f_type in (1,2)
      and d.f_state>=3
      and d.f_date between :p_str_date and :p_end_date
    into :v_id do
  begin
    execute procedure SP_SET_PARTY_FOR_DOC_OUT(:v_id);
  end
end^


CREATE OR ALTER PROCEDURE SP_CALC_INVENTORY (
    F_INVENTORY_ID BIGINT)
AS
declare variable V_SKLAD bigint;
declare variable V_INVENTORY_DATE date;
declare variable V_GOOD bigint;
declare variable V_OST_PLAN float;
declare variable V_OST_FACT float;
begin
 delete from t_inventory_str where f_inventory=:f_inventory_id;
 select f_sklad,f_date_start from t_inventory where f_id=:f_inventory_id into :v_sklad,:v_inventory_date;
 for
   select distinct f_good
     from
       SP_T_REG_GOOD_S(:v_sklad,:v_inventory_date,null)
   union
   select distinct f_good
   from
     t_inventory_doc d
     inner join t_inventory_doc_str k on d.f_id=k.f_inventory_doc and d.f_inventory=:f_inventory_id
   into :v_good
 do
 begin
   select f_end_ost from
     SP_T_REG_GOOD_GET(:v_good,:v_inventory_date,:v_sklad)
     into :v_ost_plan;
   select sum(k.f_count)
     from
       t_inventory_doc d
       inner join t_inventory_doc_str k on d.f_id=k.f_inventory_doc and d.f_inventory=:f_inventory_id
     where k.f_good=:v_good
     into :v_ost_fact;
   insert into t_inventory_str(f_good,f_inventory,f_count_plan,f_count_fact)
     values(:v_good,:f_inventory_id,coalesce(:v_ost_plan,0),coalesce(:v_ost_fact,0));
 end
end^


CREATE OR ALTER PROCEDURE SP_CALC_PRICE (
    F_PRICE_ID BIGINT,
    F_START_DATE DATE)
AS
DECLARE VARIABLE F_PARENT BIGINT;
DECLARE VARIABLE F_DELTA FLOAT;
begin
  select f_parent_object,f_formula
  from t_nsi_price
  where
    f_id=:f_price_id
  into
    :f_parent,
    :f_delta;
  update t_price p set f_active=0 where
    f_id=:f_price_id
    and f_str_date=:f_start_date;
  if (f_parent>0) then
  begin
    EXECUTE PROCEDURE SP_CALC_PRICE_BY_PRICE(:f_parent, :f_start_date, :f_price_id, :f_delta);
  end
end^


CREATE OR ALTER PROCEDURE SP_CALC_PRICE_BY_DOC (
    DOC_ID BIGINT,
    START_DATE DATE,
    PRICE_ID BIGINT,
    CHACNGE_PRICE INTEGER,
    DOC_SOURCE INTEGER = 0)
AS
declare variable F_GOOD bigint;
declare variable F_CNT float;
declare variable F_PRICE_VAL float;
begin
  if (DOC_SOURCE = 0) then
  begin
    for select S.F_GOOD, sum(S.F_CNT), avg(S.F_PRICE_VAL)
        from T_DOC_IN_STR S
        where F_DOC_IN = :DOC_ID and
              S.F_PRICE_VAL is not null
        group by S.F_GOOD
        into :F_GOOD, :F_CNT, :F_PRICE_VAL
    do
    begin
      execute procedure SP_T_PRICE_SET(:F_GOOD, :PRICE_ID, :START_DATE,
          :F_PRICE_VAL + :F_PRICE_VAL * :CHACNGE_PRICE / 100);
      --      execute procedure sp_t_price_i(:f_good,:price_id, :start_date,:f_price_val+:f_price_val*:chacnge_price/100);
    end
  end
  if (DOC_SOURCE = 1) then
  begin
    for select S.F_GOOD, sum(S.F_CNT), avg(S.F_PRICE_VAL)
        from T_DOC_MOVE_STR S
        where F_DOC_MOVE = :DOC_ID and
              S.F_PRICE_VAL is not null
        group by S.F_GOOD
        into :F_GOOD, :F_CNT, :F_PRICE_VAL
    do
    begin
      execute procedure SP_T_PRICE_SET(:F_GOOD, :PRICE_ID, :START_DATE,
          :F_PRICE_VAL + :F_PRICE_VAL * :CHACNGE_PRICE / 100);
      --      execute procedure sp_t_price_i(:f_good,:price_id, :start_date,:f_price_val+:f_price_val*:chacnge_price/100);
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_CALC_PRICE_BY_PRICE (
    PARENT_ID BIGINT,
    START_DATE DATE,
    PRICE_ID BIGINT,
    CHACNGE_PRICE INTEGER)
AS
DECLARE VARIABLE F_ROUND_PRICE NUMERIC(15,3);
begin
  update t_price
  set f_active=0
  where f_price=:price_id and f_str_date<=:start_date and f_active=1;
  select f_round from t_nsi_price where f_id=:price_id into :f_round_price;
  insert into t_price(f_price,f_good,f_str_date,f_value,f_active)
  select
    :price_id,
    s.f_good,
    :start_date,
    (select f_result from sp_round((s.f_value+s.f_value*:chacnge_price/100),:f_round_price)),
    1
  from SP_T_PRICE_S(:parent_id) s;
end^


CREATE OR ALTER PROCEDURE SP_CHECK_CONTEXT_VAL (
    P_CONTEXT_NAME VARCHAR(60),
    P_CONTEXT_VAL VARCHAR(60) = null)
RETURNS (
    F_RESULT SMALLINT)
AS
declare variable V_CONTEXT_TYPE varchar(60);
declare variable V_CONTEXT_VAL varchar(60);
declare variable V_CURR_VAL varchar(60);
declare variable V_RES integer;
begin
  select first 1 F_CONTEXT_TYPE, F_CONTEXT_VAL
  from T_SYS_CONTEXT_VAL
  where F_CONTEXT_NAME = :P_CONTEXT_NAME
  into :V_CONTEXT_TYPE, :V_CONTEXT_VAL;
  if (P_CONTEXT_VAL is not null) then
    select RDB$SET_CONTEXT(:V_CONTEXT_TYPE, :P_CONTEXT_NAME, :P_CONTEXT_VAL)
    from RDB$DATABASE
    into :V_RES;
  if (V_CONTEXT_TYPE is not null) then
  begin
    select RDB$GET_CONTEXT(:V_CONTEXT_TYPE, :P_CONTEXT_NAME)
    from RDB$DATABASE
    into :V_CURR_VAL;
    if (V_CURR_VAL <> V_CONTEXT_VAL) then
      F_RESULT = 1;
    else
      F_RESULT = 0;
  end
  else
    F_RESULT = 1;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_CHECK_PRIVS (
    P_TABLE_NAME VARCHAR(60),
    P_STATE INTEGER,
    P_TYPE INTEGER,
    P_OPERATION VARCHAR(20))
RETURNS (
    F_PARAM_NAME VARCHAR(60),
    F_RESULT SMALLINT)
AS
declare variable V_CHECK_CONTEXT smallint = 0;
begin
  /* Procedure Text */
  if (user = 'SYSDBA') then
  begin
    F_PARAM_NAME = P_TABLE_NAME || '$' || P_OPERATION || '$TYPE_' || :P_TYPE || '$STATE_' || :P_STATE;
  end
  else
  begin
    F_PARAM_NAME='';
/*    select distinct F_TABLE_NAME || '$' || F_PRIV || '$TYPE_' || :P_TYPE || '$STATE_' || :P_STATE
    from T_SYS_PRIVS
    where F_TABLE_NAME = :P_TABLE_NAME and
          (F_USR in (user, 'PUBLIC')) and
          F_PRIV = :P_OPERATION and
          F_TYPE in (:P_TYPE, 'ANY') and
          F_STATE in (:P_STATE, 'ANY')
    into :F_PARAM_NAME;*/
  end
  if (F_PARAM_NAME is null) then
  begin
    F_RESULT = 0;
    execute procedure PR_EXEC_EXCEPTION(3);
  end
  else
  begin

    select F_RESULT
    from SP_CHECK_CONTEXT_VAL(:F_PARAM_NAME)
    into :V_CHECK_CONTEXT;
    if (V_CHECK_CONTEXT = 1) then
    begin
      F_RESULT = 1;
    end
    else
    begin
      post_event 'need_password';
      F_RESULT = 0;
    end
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_CHECK_SYS_PRIVS (
    F_TABLE VARCHAR(60))
RETURNS (
    F_RESULT VARCHAR(20),
    F_TYPE VARCHAR(20),
    F_STATE VARCHAR(20))
AS
begin
  if (user = 'SYSDBA') then
  begin
    F_STATE='ANY';
    F_TYPE='ANY';
    F_RESULT = 'INS';
    suspend;
    F_RESULT = 'SEL';
    suspend;
    F_RESULT = 'UPD';
    suspend;
    F_RESULT = 'DEL';
    suspend;
  end
  else
  begin
    for select distinct F_PRIV,f_type,f_state

        from T_SYS_PRIVS
        where F_TABLE_NAME = :F_TABLE and
              (upper(F_USR) in (user, 'PUBLIC'))
        into :F_RESULT,:f_type,:f_state
    do
    begin
      suspend;
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_COPY_IN2MOVE (
    F_DOC_IN BIGINT)
RETURNS (
    F_MOVE_DOC BIGINT)
AS
declare variable F_IN_ID bigint;
declare variable F_SKLAD bigint;
declare variable F_NUMBER varchar(60);
declare variable F_DATE date;
declare variable F_GOOD bigint;
declare variable F_PRICE_VAL numeric(15,3);
declare variable F_ID bigint;
declare variable F_CNT numeric(15,3);
begin
  if (f_doc_in is not null) then
  begin
    select
      F_ID,
      F_SKLAD,
      F_NUMBER,
      F_DATE,
      f_price
    from
      SP_T_DOC_IN_GET(:f_doc_in)
    into
      :f_in_id,
      :f_sklad,
      :f_number,
      :f_date,
      :f_id;

    select f_id from sp_t_doc_move_get(-10) into :f_move_doc;
    for
      select
        f_good,
        f_price_val,
        f_cnt
      from sp_t_doc_in_str_s(:f_in_id)
      into
        :f_good,
        :f_price_val,
        :f_cnt
    do
    begin
      execute procedure SP_T_DOC_move_STR_I(null,:f_move_doc,:f_good,null,:f_cnt,:f_price_val);
    end
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_COPY_IN2PRICE (
    F_DOC_IN BIGINT,
    F_CHANGE_PRICE INTEGER,
    F_PRICE BIGINT)
RETURNS (
    F_DOC_PRICE BIGINT)
AS
declare variable F_IN_ID bigint;
declare variable F_SKLAD bigint;
declare variable F_NUMBER varchar(60);
declare variable F_DATE date;
declare variable F_PRICE_ID bigint;
declare variable F_GOOD bigint;
declare variable F_PRICE_VAL numeric(15,3);
declare variable F_ROUND float;
declare variable F_CURR_PRICE numeric(15,3);
declare variable F_ID bigint;
begin
  if (F_DOC_IN is not null) then
  begin
    select F_ID, F_SKLAD, F_NUMBER, F_DATE, F_PRICE
    from SP_T_DOC_IN_GET(:F_DOC_IN)
    into :F_IN_ID, :F_SKLAD, :F_NUMBER, :F_DATE, :F_ID;

    select F_ID
    from SP_T_DOC_PRICE_GET(-10)
    into :F_PRICE_ID;
    F_ID = coalesce(F_PRICE, F_ID);
    select F_ROUND
    from SP_T_NSI_PRICE_GET(:F_ID)
    into :F_ROUND;
    update T_DOC_PRICE
    set F_NUM = :F_NUMBER,
        F_DATE = :F_DATE,
        F_PARENT = :F_IN_ID,
        F_PRICE = :F_ID,
        F_NACENKA = :F_CHANGE_PRICE
    where F_ID = :F_PRICE_ID;
    for select F_GOOD, F_PRICE_VAL
        from SP_T_DOC_IN_STR_S(:F_IN_ID)
        into :F_GOOD, :F_PRICE_VAL
    do
    begin
      F_CURR_PRICE = -1;
      if (f_change_price>0) then
        select f_result from sp_round(:f_price_val*(cast((cast(:f_change_price as numeric(15,3))+cast(100 as numeric(15,3)))/cast(100 as numeric(15,3)) as numeric(15,3))),:f_round) into :f_price_val;
      else
        select (select F_RESULT
              from SP_ROUND((:F_PRICE_VAL + :F_PRICE_VAL * F_FORMULA / 100), F_ROUND))
        from SP_T_NSI_PRICE_STR_S(:F_PRICE)
        where :F_PRICE_VAL between F_START_LINE and F_END_LINE
        into :F_PRICE_VAL;
      select F_VALUE
      from SP_T_PRICE_GET(:F_ID, :F_GOOD)
      into :F_CURR_PRICE;
      if (coalesce(F_CURR_PRICE, -1) <> F_PRICE_VAL) then
        execute procedure SP_T_DOC_PRICE_STR_I(:F_GOOD, :F_PRICE_VAL, :F_PRICE_ID);
    end
    F_DOC_PRICE = F_PRICE_ID;
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_COPY_MOVE2SPISAN (
    P_DOC_MOVE BIGINT)
RETURNS (
    F_MOVE_DOC BIGINT)
AS
declare variable F_IN_ID bigint;
declare variable F_SKLAD bigint;
declare variable F_NUMBER varchar(60);
declare variable F_DATE date;
declare variable F_GOOD bigint;
declare variable F_PRICE_VAL numeric(15,3);
declare variable F_ID bigint;
declare variable F_CNT numeric(15,3);
begin
  if (p_doc_move is not null) then
  begin
    select
      F_ID,
      F_SKLAD_to,
      F_NUMBER,
      F_DATE,
      f_price
    from
      SP_T_DOC_move_GET(:p_doc_move)
    into
      :f_in_id,
      :f_sklad,
      :f_number,
      :f_date,
      :f_id;
    select f_id from sp_t_doc_move_get(-10,2) into :f_move_doc;
    for
      select
        f_good,
        f_price_val,
        f_cnt
      from sp_t_doc_move_str_s(:f_in_id)
      into
        :f_good,
        :f_price_val,
        :f_cnt
    do
    begin
      execute procedure SP_T_DOC_move_STR_I(null,:f_move_doc,:f_good,null,:f_cnt,:f_price_val);
    end
    
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_COPY_PRICE2PRICE (
    P_SOURCE_PRICE BIGINT,
    P_PRICE BIGINT,
    P_CHANGE_PRICE NUMERIC(15,3),
    P_PARTNER_GOOD BIGINT)
AS
declare variable V_ROUND float;
declare variable V_PRICE_DOC bigint;
declare variable V_CURR_PRICE numeric(15,3);
declare variable V_PRICE_VAL numeric(15,3);
declare variable V_GOOD bigint;
begin
    select f_id from sp_t_doc_price_get(-10) into :v_price_doc;
    select f_round from SP_T_NSI_PRICE_GET(:p_source_price) into :v_round;
    update t_doc_price set f_num=f_id, f_date='now',f_price=:p_price ,f_nacenka=:p_change_price where f_id=:v_price_doc;
    for
        select f_id,(select f_value from SP_T_PRICE_GET(:p_source_price,g.f_id))
        from t_nsi_goods g where
            coalesce(f_partner,1)=coalesce(:p_partner_good,coalesce(g.f_partner,0))
        into :v_good,:v_curr_price
    do
    begin
      select f_result from sp_round(:v_curr_price*(cast((cast(:p_change_price as numeric(15,3))+cast(100 as numeric(15,3)))/cast(100 as numeric(15,3)) as numeric(15,3))),:v_round) into :v_price_val;
      if (v_curr_price<>v_price_val) then
        execute procedure SP_T_DOC_PRICE_STR_I(:v_good,:v_price_val,:v_price_doc);
     end
end^


CREATE OR ALTER PROCEDURE SP_CREATE_ARCHIVE_BASE (
    P_ARCH_NAME VARCHAR(60),
    P_ARCH_HOST VARCHAR(60),
    P_START_DATE DATE,
    P_END_DATE DATE)
AS
declare variable F_ID bigint;
declare variable F_SKLAD bigint;
declare variable F_PARTNER bigint;
declare variable F_DATE date;
declare variable F_TYPE bigint;
declare variable V_PRICE_ID bigint;
declare variable F_NUMBER varchar(60);
declare variable F_STATE integer;
declare variable V_ARCH_BASE varchar(60);
begin
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('ARCH_BASE')
  into :V_ARCH_BASE;
  /* */
  for select distinct F_PRICE
      from T_DOC_PRICE P
      where P.F_STATE >= 3 and
            P.F_DATE between :P_START_DATE and :P_END_DATE
      union
      select distinct F_PRICE
      from T_DOC_IN P
      where P.F_STATE >= 3 and
            P.F_DATE between :P_START_DATE and :P_END_DATE
      union
      select distinct F_PRICE
      from T_DOC_OUT P
      where P.F_STATE >= 3 and
            P.F_DATE between :P_START_DATE and :P_END_DATE
      union
      select distinct F_PRICE
      from T_DOC_MOVE P
      where P.F_STATE >= 3 and
            P.F_DATE between :P_START_DATE and :P_END_DATE
      into :V_PRICE_ID
  do
  begin
    if (V_PRICE_ID is not null) then
      execute procedure PR_EXEC_EXCEPTION(1);
  end

  /**/
  /*  for select
  f_id,f_sklad,f_partner,f_number,f_date,f_state,f_price,f_type
  from T_DOC_IN
  where f_date between :p_start_date and :p_end_date
  into :f_id,:f_sklad,:f_partner,:f_number,:f_date,:f_state,:f_price,:f_type do
  execute statement ('execute procedure sp_t_doc_in_i(?,?,?,?,?,?,?,?)')
    (:f_id,:f_sklad,:f_partner,:f_number,:f_date,:f_state,:f_price,:f_type)
    ON EXTERNAL :p_arch_name;*/

  /*       
  for
    select
      d.f_id,d.f_sklad,d.f_partner,d.f_number,d.f_date
      
    from t_doc_in d
    where
      d.f_state>=3
      and d.f_doc_sum=d.f_pay_sum
/* --------------------------------------------------*/
end^


CREATE OR ALTER PROCEDURE SP_DOC_OUT_CALC_SKIDKA (
    F_DOC_OUT INTEGER)
AS
declare variable V_SKIDKA bigint;
declare variable V_ROUND numeric(15,3);
declare variable V_SKIDKA_VAL numeric(15,3);
begin
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('OUT_DOC_SKIDKA')
  into :V_SKIDKA;
  select F_ROUND
  from T_NSI_SKIDKA
  where F_ID = :V_SKIDKA
  into :V_ROUND;
  select F_SKIDKA
  from SP_T_DOC_OUT_GET(:F_DOC_OUT)
  into :V_SKIDKA_VAL;
  update T_DOC_OUT_STR
  set F_PRICE_VAL = (F_PRICE_VAL_NSI) * (100 - coalesce(:V_SKIDKA_VAL, 0)) / 100.00
  where F_DOC_OUT = :F_DOC_OUT and
        F_CNT > 0;
  update T_DOC_OUT_STR
  set F_PRICE_VAL = (select F_RESULT
                     from SP_ROUND(F_PRICE_VAL, :V_ROUND))
  where F_DOC_OUT = :F_DOC_OUT and
        F_CNT > 0;
  update T_DOC_OUT_STR
  set F_PRICE_VAL = F_PRICE_VAL_NSI
  where F_DOC_OUT = :F_DOC_OUT and
        F_PRICE_VAL_NSI < F_PRICE_VAL and
        F_CNT > 0;
  update T_DOC_OUT_STR
  set F_PRICE_VAL = F_PRICE_VAL_NSI
  where F_DOC_OUT = :F_DOC_OUT and
        F_PRICE_VAL_NSI < 0 and
        F_CNT > 0;

end^


CREATE OR ALTER PROCEDURE SP_EXPORT_REG_GOODS (
    P_SKLAD INTEGER,
    P_DATE DATE,
    P_PRICE INTEGER)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
DECLARE VARIABLE F_GOOD_ID BIGINT;
begin
  select
    '<Document MoveType="DOC_MOVE" Id="100500" DocType="1">'||
    '<wbNumber>START_OST</wbNumber>'||
    '<wbDate>'||(select f_value from pr_date_to_str(:p_date))||'</wbDate>'||
--    '<wbSum>'||coalesce(f_doc_sum,coalesce((select sum(s.f_sum) from t_doc_move_str s where s.f_doc_move=g.f_id),0))||'</wbSum>'||
    '<Recipient>'||
    (select f_xml from sp_t_nsi_sklad_get(:p_sklad))||
    '</Recipient>'||
    '<Sender>'||
    (select f_xml from sp_t_nsi_sklad_get(:p_sklad))||
    '</Sender>'||
    (
    select
      case
        when coalesce(f_partner,0)>0 then
          (select f_xml from sp_t_nsi_partner_get(f_partner))
        else ''
      end
    from
     sp_t_nsi_sklad_get(:p_sklad)
     )||
    '<DocBody>'
  from rdb$database
  into :f_value;
  suspend;
  for select
    f_good,
    '<Pos>'||
    '<Price>'||(select f_result from sp_round(f_price_val,0.01))||'</Price>'||
    '<Kol>'||(select f_result from sp_round(f_end_ost,0.01))||'</Kol>'||
    '<Summ>'||(select f_result from sp_round(f_end_ost*f_price_val,0.01))||'</Summ>'
  from sp_t_reg_good_s(:p_sklad, :p_date, :p_price)
  where f_end_ost>0
  into
    :f_good_id,:f_value do
  begin
    suspend;
    for select f_value from SP_T_NSI_GOODS_XML(:f_good_id) into :f_value do
    begin
      suspend;
    end
    f_value='</Pos>';
    suspend;
  end
  f_value='</DocBody></Document>';
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_ALL_CURR_OST
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_NAME VARCHAR(255),
    F_OST VARCHAR(255))
AS
declare variable V_SKLAD bigint;
declare variable V_OST numeric(15,3);
declare variable V_GOOD bigint;
begin
  for select F_GOOD, F_SKLAD, F_END_OST
      from T_OST
      where f_sklad is not null
      order by F_GOOD, F_SKLAD
      into :V_GOOD, :V_SKLAD, :V_OST
  do
  begin
    if (coalesce(F_GOOD, 0) <> V_GOOD) then
    begin
      if (F_GOOD is not null) then
        suspend;
      F_GOOD = V_GOOD;
      select F_NAME, F_ARTICLE
      from T_NSI_GOODS
      where F_ID = :V_GOOD

      into :F_NAME, :F_ARTICLE;
      F_OST = V_SKLAD || '=' || V_OST || ascii_char(10);
    end
    else
    begin
      F_OST = F_OST || V_SKLAD || '=' || V_OST || ascii_char(10);
    end
  end
  if (F_GOOD is not null) then
    suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_DOC_BODY (
    P_DOC_NAME VARCHAR(60),
    P_DOC_ID BIGINT,
    P_SHOW_PHOTO SMALLINT = 0)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_GOOD_NAME VARCHAR(255),
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_SKLAD_OST NUMERIC(15,3))
AS
begin
  if (P_DOC_NAME = 'T_DOC_IN') then
  begin
    for select F_ID, F_GOOD, F_ARTICLE, F_GOOD_NAME, F_PRICE_VAL, F_CNT, F_SUM
        from SP_T_DOC_IN_STR_S(:P_DOC_ID)
        into :F_ID, :F_GOOD, :F_ARTICLE, :F_GOOD_NAME, :F_PRICE_VAL, :F_CNT, :F_SUM
    do
    begin
      f_memo=null;
      if (P_SHOW_PHOTO>0) then
        select f_memo from SP_T_NSI_GOODS_MMEDIA_S(:f_good) into :f_memo;
      suspend;
    end
  end
  if (P_DOC_NAME = 'T_DOC_OUT') then
  begin
    for select F_ID, F_GOOD, F_ARTICLE, F_GOOD_NAME, F_PRICE_VAL, F_CNT, F_SUM,F_SKLAD_OST
        from SP_T_DOC_OUT_STR_S(:P_DOC_ID)
        into :F_ID, :F_GOOD, :F_ARTICLE, :F_GOOD_NAME, :F_PRICE_VAL, :F_CNT, :F_SUM, :F_SKLAD_OST
    do
    begin
      f_memo=null;
      if (P_SHOW_PHOTO>0) then
        select f_memo from SP_T_NSI_GOODS_MMEDIA_S(:f_good) into :f_memo;
      suspend;
    end
  end
  if (P_DOC_NAME = 'T_DOC_MOVE') then
  begin
    for select F_ID, F_GOOD, F_ARTICLE, F_GOOD_NAME, F_PRICE_VAL, F_CNT, F_SUM, F_SKLAD_OST
        from SP_T_DOC_MOVE_STR_S(:P_DOC_ID)
        into :F_ID, :F_GOOD, :F_ARTICLE, :F_GOOD_NAME, :F_PRICE_VAL, :F_CNT, :F_SUM, :F_SKLAD_OST
    do
    begin
      f_memo=null;
      if (P_SHOW_PHOTO>0) then
        select f_memo from SP_T_NSI_GOODS_MMEDIA_S(:f_good) into :f_memo;
      suspend;
    end
  end

end^


CREATE OR ALTER PROCEDURE SP_GET_DOC_HEAD (
    P_DOC_NAME VARCHAR(60),
    P_DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_SENDER_NAME VARCHAR(255),
    F_RECIPIENT_NAME VARCHAR(255),
    F_PRICE BIGINT,
    F_STATE BIGINT,
    F_PRICE_NAME VARCHAR(255),
    F_STATE_NAME VARCHAR(255),
    F_TYPE_NAME VARCHAR(255),
    F_TYPE BIGINT)
AS
begin
  if (P_DOC_NAME = 'T_DOC_OUT') then
  begin
    if (exists(select 1
               from T_DOC_OUT
               where F_ID = :P_DOC_ID)) then
    begin
      select F_ID, F_DATE, F_NUMBER, F_SKLAD_NAME as F_SENDER, F_PARTNER_NAME as F_RECEPIENT, F_STATE_NAME,
             F_PRICE_NAME, F_STATE, F_TYPE, F_TYPE_NAME
      from SP_T_DOC_OUT_GET(:P_DOC_ID)
      into :F_ID, :F_DATE, :F_NUMBER, :F_SENDER_NAME, :F_RECIPIENT_NAME, :F_STATE_NAME, :F_PRICE_NAME, :F_STATE,
           :F_TYPE, :F_TYPE_NAME;
    end
  end
  if (P_DOC_NAME = 'T_DOC_IN') then
  begin
    if (exists(select 1
               from T_DOC_IN
               where F_ID = :P_DOC_ID)) then
    begin
      select F_ID, F_DATE, F_NUMBER, F_PARTNER_NAME as F_SENDER, F_SKLAD_NAME as F_RECEPIENT, F_STATE_NAME,
             F_PRICE_NAME, F_STATE, F_DOC_TYPE, F_TYPE_NAME
      from SP_T_DOC_IN_GET(:P_DOC_ID)
      into :F_ID, :F_DATE, :F_NUMBER, :F_SENDER_NAME, :F_RECIPIENT_NAME, :F_STATE_NAME, :F_PRICE_NAME, :F_STATE,
           :F_TYPE, :F_TYPE_NAME;
    end
  end
  if (P_DOC_NAME = 'T_DOC_MOVE') then
  begin
    if (exists(select 1
               from T_DOC_MOVE
               where F_ID = :P_DOC_ID)) then
    begin
      select F_ID, F_DATE, F_NUMBER, F_SKLAD_FROM_NAME as F_SENDER, F_SKLAD_TO_NAME as F_RECEPIENT, F_STATE_NAME,
             F_PRICE_NAME, F_STATE, F_TYPE, F_TYPE_NAME
      from SP_T_DOC_MOVE_GET(:P_DOC_ID)
      into :F_ID, :F_DATE, :F_NUMBER, :F_SENDER_NAME, :F_RECIPIENT_NAME, :F_STATE_NAME, :F_PRICE_NAME, :F_STATE,
           :F_TYPE, :F_TYPE_NAME;
    end
  end

  suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_DOC_NUM (
    F_SKLAD INTEGER)
RETURNS (
    F_RESULT VARCHAR(60))
AS
declare variable V_PREFIX varchar(2);
begin
  select f_prefix from sp_t_nsi_sklad_get(:f_sklad) into :v_prefix;
  f_result=GEN_ID(GEN_DOC_NUM,1);
  while (CHAR_LENGTH(f_result)<7) do
  begin
    f_result='0'||f_result;
  end
  f_result=coalesce(v_prefix,'')||f_result;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_DOC_NUM_BY_PARTY (
    V_PARTY_ID BIGINT)
RETURNS (
    F_NUMBERS VARCHAR(255))
AS
DECLARE VARIABLE P_NUMBER VARCHAR(60) CHARACTER SET WIN1251;
begin
  f_numbers='';
  for select distinct
    d.f_number
  from
  t_nsi_good_party p
  inner join t_doc_in d on p.f_date=d.f_date
  inner join t_doc_in_str s on d.f_id=s.f_doc_in and s.f_good=p.f_good
   where p.f_id=:v_party_id
   and d.f_type=1
    and d.f_state>=3
  into :p_number do
  begin
    f_numbers=f_numbers||p_number||';';
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_GOOD_CURR_OST (
    P_GOOD BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_NAME VARCHAR(255),
    F_OST VARCHAR(255))
AS
declare variable V_SKLAD bigint;
declare variable V_OST float;
begin
  select F_ID, F_NAME, F_ARTICLE
  from T_NSI_GOODS
  where F_ID = :P_GOOD
  into :F_GOOD, :F_NAME, :F_ARTICLE;

  for select F_SKLAD, F_END_OST
      from T_OST
      where F_GOOD = :P_GOOD
      and f_sklad is not null
      order by F_GOOD, F_SKLAD
      into :V_SKLAD, :V_OST
  do
  begin
    F_OST = coalesce(F_OST, '') || V_SKLAD || '=' || V_OST || ascii_char(10);
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_GOOD_MOOVE (
    F_GOOD BIGINT,
    F_START_DATE DATE,
    F_END_DATE DATE)
RETURNS (
    F_DOC_ID BIGINT,
    F_DOC_DATE DATE,
    F_DOC_NUM VARCHAR(60),
    F_IN_CNT NUMERIC(15,3),
    F_OUT_CNT NUMERIC(15,3),
    F_IN_SUM NUMERIC(15,3),
    F_OUT_SUM NUMERIC(15,3),
    F_PARTNER VARCHAR(60),
    F_PARTNER_ID BIGINT)
AS
declare variable F_SYS_ST bigint;
begin
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
  into :F_SYS_ST;
  select F_START_OST
  from SP_T_REG_GOOD_GET(:F_GOOD, :F_START_DATE, null)
  into :F_IN_CNT;
  F_IN_CNT = coalesce(F_IN_CNT, 0);
  F_PARTNER = '';
  suspend;
  for select F_ID, F_DATE, F_NUMBER, F_IN, F_OUT, F_ISUM, F_OSUM, F_PARTNER
      from (select DI.F_ID, DI.F_DATE, DI.F_NUMBER, DIS.F_CNT as F_IN, cast(null as numeric(5,3)) as F_OUT,
                   DIS.F_PRICE_VAL * DIS.F_CNT as F_ISUM, cast(null as numeric(5,3)) as F_OSUM, DI.F_PARTNER
            from T_DOC_IN DI
            inner join T_DOC_IN_STR DIS on DI.F_ID = DIS.F_DOC_IN and DIS.F_GOOD = :F_GOOD
            where DI.F_DATE between :F_START_DATE and :F_END_DATE and
                  DI.F_STATE >= :F_SYS_ST
            union all
            select DI.F_ID, DI.F_DATE, DI.F_NUMBER, cast(null as numeric(5,3)) as F_IN, DIS.F_CNT as F_OUT,
                   cast(null as numeric(5,3)) as F_ISUM, DIS.F_PRICE_VAL * DIS.F_CNT as F_OSUM, DI.F_PARTNER
            from T_DOC_OUT DI
            inner join T_DOC_OUT_STR DIS on DI.F_ID = DIS.F_DOC_OUT and DIS.F_GOOD = :F_GOOD
            where DI.F_DATE between :F_START_DATE and :F_END_DATE and
                  DI.F_STATE >= :F_SYS_ST) K
      order by F_DATE
      into :F_DOC_ID, :F_DOC_DATE, :F_DOC_NUM, :F_IN_CNT, :F_OUT_CNT, :F_IN_SUM, :F_OUT_SUM, :F_PARTNER_ID
  do
  begin
    if (F_PARTNER_ID is not null) then
    begin
      select F_NAME
      from SP_T_NSI_PARTNER_GET(:F_PARTNER_ID)
      into :F_PARTNER;
    end
    else
      F_PARTNER = null;
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_GET_GOOD_MOOVE_BY_STOCK (
    F_GOOD BIGINT,
    F_START_DATE DATE,
    F_END_DATE DATE,
    F_SKLAD BIGINT)
RETURNS (
    F_DOC_ID BIGINT,
    F_DOC_DATE DATE,
    F_DOC_NUM VARCHAR(60),
    F_IN_CNT NUMERIC(15,3),
    F_OUT_CNT NUMERIC(15,3),
    F_IN_SUM NUMERIC(15,3),
    F_OUT_SUM NUMERIC(15,3),
    F_PARTNER VARCHAR(60),
    F_PARTNER_ID BIGINT)
AS
declare variable F_SYS_ST bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_st;
  select F_START_OST from SP_T_REG_GOOD_GET(:f_good, :f_start_date,:f_sklad)
/*  select sum(r.f_end_ost) from t_reg_good r where r.f_good=:f_good
    and r.f_sklad=:f_sklad
    and r.f_date=
    (select max(f_date) from t_reg_good g where g.f_good=r.f_good
      and g.f_sklad=r.f_sklad
      and g.f_date<:f_start_date)*/
  into :f_in_cnt;
  f_in_cnt=coalesce(f_in_cnt, 0);
  f_partner='';
  suspend;
  for
    select f_id,f_date,f_number,f_in,f_out,f_isum,f_osum,f_partner,f_name
    from
    (
      select di.f_id,di.f_date,di.f_number,dis.f_cnt as f_in,cast(null as numeric(5,3)) as f_out,dis.f_price_val*dis.f_cnt as f_isum,cast(null as numeric(5,3)) as f_osum,di.f_partner,p.f_name
      from
        t_doc_in di
        inner join t_doc_in_str dis on di.f_id=dis.f_doc_in and dis.f_good=:f_good and di.f_sklad=:f_sklad
        left join t_nsi_partner p on di.f_partner=p.f_id
      where
        di.f_date between :f_start_date and :f_end_date
        and di.f_state>=:f_sys_st
      union all
      select di.f_id,di.f_date,di.f_number,cast(null as numeric(5,3)) as f_in,dis.f_cnt as f_out,cast(null as numeric(5,3)) as f_isum,dis.f_price_val*dis.f_cnt as f_osum,di.f_partner,p.f_name
      from
        t_doc_out di
        inner join t_doc_out_str dis on di.f_id=dis.f_doc_out and dis.f_good=:f_good and di.f_sklad=:f_sklad
        left join t_nsi_partner p on di.f_partner=p.f_id
      where
        di.f_date between :f_start_date and :f_end_date
        and di.f_state>=:f_sys_st
      union all
      select di.f_id,di.f_date,di.f_number,dis.f_cnt as f_in,cast(null as numeric(5,3)) as f_out,dis.f_price_val*dis.f_cnt as f_isum,cast(null as numeric(5,3)) as f_osum,null,p.f_name
      from
        t_doc_move di
        inner join t_doc_move_str dis on di.f_id=dis.f_doc_move and dis.f_good=:f_good and di.f_sklad_to=:f_sklad
        left join t_nsi_sklad p on di.f_sklad_from=p.f_id
      where
        di.f_date between :f_start_date and :f_end_date
        and di.f_state>=:f_sys_st
      union all
      select di.f_id,di.f_date,di.f_number,cast(null as numeric(5,3)) as f_in,dis.f_cnt as f_out,dis.f_price_val*dis.f_cnt as f_isum,cast(null as numeric(5,3)) as f_osum,null,p.f_name
      from
        t_doc_move di
        inner join t_doc_move_str dis on di.f_id=dis.f_doc_move and dis.f_good=:f_good and di.f_sklad_from=:f_sklad
        left join t_nsi_sklad p on di.f_sklad_to=p.f_id

      where
        di.f_date between :f_start_date and :f_end_date
        and di.f_state>=:f_sys_st

    )k
    order by f_date
    into
    :f_doc_id,
    :f_doc_date,
    :f_doc_num,
    :f_in_cnt,
    :f_out_cnt,
    :f_in_sum,
    :f_out_sum,
    :f_partner_id,
    :f_partner
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_GET_IN_BY_PERIOD (
    F_STR_DATE DATE,
    F_END_DATE DATE)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(255),
    F_NUM_OUT VARCHAR(20),
    F_DATE_OUT DATE,
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3))
AS
DECLARE VARIABLE F_SYS_STATE BIGINT;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_state;
  for select
    d.f_number,
    d.f_date,
    d.f_partner,
    s.f_good,
    s.f_cnt,
    s.f_price_val,
    s.f_sum
  from
    t_doc_in d
    inner join t_doc_in_str s on d.f_id=s.f_doc_in
  where
   d.f_date between :f_str_date and :f_end_date
   and d.f_state>=:f_sys_state
  into
    :f_num_out,
    :f_date_out,
    :f_partner,
    :f_good,
    :f_cnt,
    :f_price,
    :f_sum
  do
  begin
    select f_name,f_article,f_ed_izm_name from sp_t_nsi_goods_get(:f_good,null)
      into :f_good_name,:f_good_article,:f_good_ed_izm;
    select f_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_GET_NSI_DISCOUNT (
    F_NUMBER_IN VARCHAR(60))
RETURNS (
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3),
    F_CARD_ID BIGINT)
AS
begin
  select first 1 F_ID, F_DISCOUNT, f_number
  from T_NSI_DISCOUNT_CARD
  where F_NUMBER = :F_NUMBER_IN
  into :F_CARD_ID, :F_DISCOUNT, :f_number;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_OUT_BY_PERIOD (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    F_DOC_TYPE BIGINT = 0)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(255),
    F_NUM_OUT VARCHAR(20),
    F_DATE_OUT DATE,
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_INPUT_PRICE NUMERIC(15,3),
    F_INPUT_SUM NUMERIC(15,3))
AS
declare variable F_IN_PRICE bigint;
declare variable F_SYS_STATE bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_state;
  select param_value from sp_get_sys_param('DEFAULT_IN_PRICE') into :f_in_price;
  for select
    d.f_number,
    d.f_date,
    d.f_partner,
    s.f_good,
    s.f_cnt,
    s.f_price_val,
    s.f_sum
  from
    t_doc_out d
    inner join t_doc_out_str s on d.f_id=s.f_doc_out
  where
   d.f_date between :f_str_date and :f_end_date
   and d.f_state>=:f_sys_state
   and f_type in
   (select f_id from t_nsi_doc_out_types where (:f_doc_type=0) or (:f_doc_type=1 and f_id between 1 and 2) or (:f_doc_type=2 and f_id=3) )
  into
    :f_num_out,
    :f_date_out,
    :f_partner,
    :f_good,
    :f_cnt,
    :f_price,
    :f_sum
  do
  begin
    select f_name,f_article,f_ed_izm_name from sp_t_nsi_goods_get(:f_good,null)
      into :f_good_name,:f_good_article,:f_good_ed_izm;
    select f_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
    if (f_in_price>0) then
    begin
      select f_value from sp_t_price_get(:f_in_price,:f_good) into :f_input_price;
      f_input_sum=f_input_price*f_cnt;
    end
    else
    begin
      f_input_price=null;
      f_input_sum=null;
    end
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_GET_OUT_BY_PERIOD_BY_SKLAD (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    P_SKLAD BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_INPUT_PRICE NUMERIC(15,3),
    F_INPUT_SUM NUMERIC(15,3),
    F_SKIDKA_SUM NUMERIC(15,3),
    F_BACK_SUM NUMERIC(15,3),
    F_BACK_CNT NUMERIC(15,3))
AS
declare variable F_IN_PRICE bigint;
declare variable F_SYS_STATE bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_state;
  select param_value from sp_get_sys_param('DEFAULT_IN_PRICE') into :f_in_price;
  for
  select
    coalesce(sa.f_good,b.f_good),
    f_cnt_sale,
    f_price_sale,
    f_sum_sale,
    f_sum_skd,
    f_back_sum,
    f_back_cnt
  from
  (
  select
    s.f_good,
    sum(s.f_cnt) as f_cnt_sale,
    sum(s.f_sum)/sum(s.f_cnt) as f_price_sale,
    sum(s.f_sum) as f_sum_sale,
    sum((coalesce(s.f_price_val_nsi,s.f_price_val)-s.f_price_val)*s.f_cnt) as f_sum_skd
  from
    t_doc_out d
    inner join t_doc_out_str s on d.f_id=s.f_doc_out
  where
   d.f_date between :f_str_date and :f_end_date
   and d.f_state>=:f_sys_state
   and d.f_sklad=coalesce(:p_sklad,d.f_sklad)
   and d.f_type in (1,2)
  group by s.f_good
  ) sa
  full join
      (
    select
      s.f_good,
      sum(s.f_sum) as f_back_sum,
      sum(s.f_cnt) as f_back_cnt
    from
      t_doc_in d
      inner join t_doc_in_str s on d.f_id=s.f_doc_in and d.f_type=2
    where
     d.f_date between :f_str_date and :f_end_date
     and d.f_state>=:f_sys_state
     and d.f_sklad=coalesce(:p_sklad,d.f_sklad)
    group by s.f_good
    ) b
  on sa.f_good=b.f_good
  into
    :f_good,
    :f_cnt,
    :f_price,
    :f_sum,
    :f_skidka_sum,
    :f_back_sum,
    :f_back_cnt
  do
  begin
    select f_name,f_article,f_ed_izm_name from sp_t_nsi_goods_get(:f_good,null)
      into :f_good_name,:f_good_article,:f_good_ed_izm;
    if (f_in_price>0) then
    begin
      select f_value from sp_t_price_get(:f_in_price,:f_good) into :f_input_price;
      f_input_sum=f_input_price*f_cnt;
    end
    else
    begin
      f_input_price=null;
      f_input_sum=null;
    end
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_GET_OUT_BY_PRD_BY_SKLAD_EXT (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    P_SKLAD BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ED_IZM VARCHAR(60),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_INPUT_PRICE NUMERIC(15,3),
    F_INPUT_SUM NUMERIC(15,3),
    F_SKIDKA_SUM NUMERIC(15,3),
    F_BACK_SUM NUMERIC(15,3),
    F_BACK_CNT NUMERIC(15,3))
AS
declare variable F_IN_PRICE bigint;
declare variable F_SYS_STATE bigint;
begin
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :f_sys_state;
  select param_value from sp_get_sys_param('DEFAULT_IN_PRICE') into :f_in_price;
  for
  select
    coalesce(sa.f_good,b.f_good),
    f_cnt_sale,
    f_price_sale,
    f_sum_sale,
    f_sum_skd,
    f_back_sum,
    f_back_cnt
  from
  (
  select
    s.f_good,
    sum(s.f_cnt) as f_cnt_sale,
    sum(s.f_sum)/sum(s.f_cnt) as f_price_sale,
    sum(s.f_sum) as f_sum_sale,
    sum((coalesce(s.f_price_val_nsi,s.f_price_val)-s.f_price_val)*s.f_cnt) as f_sum_skd
  from
    t_doc_out d
    inner join t_doc_out_str s on d.f_id=s.f_doc_out
  where
   d.f_date between :f_str_date and :f_end_date
   and d.f_state>=:f_sys_state
   and d.f_sklad=coalesce(:p_sklad,d.f_sklad)
   and d.f_type in (1,2)
  group by s.f_good
  ) sa
  full join
      (
    select
      s.f_good,
      sum(s.f_sum) as f_back_sum,
      sum(s.f_cnt) as f_back_cnt
    from
      t_doc_in d
      inner join t_doc_in_str s on d.f_id=s.f_doc_in and d.f_type=2
    where
     d.f_date between :f_str_date and :f_end_date
     and d.f_state>=:f_sys_state
     and d.f_sklad=coalesce(:p_sklad,d.f_sklad)
    group by s.f_good
    ) b
  on sa.f_good=b.f_good
  into
    :f_good,
    :f_cnt,
    :f_price,
    :f_sum,
    :f_skidka_sum,
    :f_back_sum,
    :f_back_cnt
  do
  begin
    select f_name,f_article,f_ed_izm_name from sp_t_nsi_goods_get(:f_good,null)
      into :f_good_name,:f_good_article,:f_good_ed_izm;
    if (f_in_price>0) then
    begin
      select f_value from sp_t_price_get(:f_in_price,:f_good) into :f_input_price;
      f_input_sum=f_input_price*f_cnt;
    end
    else
    begin
      f_input_price=null;
      f_input_sum=null;
    end
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_GET_SOURCE_FOR_PRICE
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60))
AS
begin
  for select p.f_id,p.f_name from t_nsi_price p
    union
      select -1,'' from rdb$database
    into :f_id,:f_name do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_GET_SYS_PARAM (
    PARAM_NAME VARCHAR(60))
RETURNS (
    PARAM_VALUE VARCHAR(60))
AS
begin
  select f_value from t_sys_params where f_name=upper(:param_name) into :param_value;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_GET_USER_BUFFER (
    F_SKLAD BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_GOOD_NAME VARCHAR(100),
    F_CNT FLOAT,
    F_OST FLOAT)
AS
begin
  for select U.F_ID, U.F_GOOD, G.F_ARTICLE, G.F_NAME, U.F_CNT
      from T_USER_BUFER U
      inner join T_NSI_GOODS G on U.F_GOOD = G.F_ID
      where U.F_USER = current_user
      into :F_ID, :F_GOOD, :F_ARTICLE, :F_GOOD_NAME, :F_CNT
  do
  begin
    f_ost=0;
    select f_end_ost from t_ost
      where f_sklad=:f_sklad and f_good=:f_good into :f_ost;
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_IN (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_USER VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
begin
  select f_id from SP_T_DOC_IN_GET(-10,:f_doc_type) into :f_id;
  insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_DOC_IN',:f_ext_base,:f_ext_id,:f_id);
  if (not exists (select f_id from t_nsi_partner where f_id=:f_partner)) then
    f_partner=null;
  execute procedure sp_t_doc_in_u(:f_id,null, :f_partner,:f_number,:f_date,null,null,:f_user);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_IN_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
DECLARE VARIABLE F_IZM BIGINT;
begin
  f_good_id=0;
  if (exists(select first 1 f_id from t_nsi_goods where f_article=:f_article) ) then
  begin
    select first 1 f_id from t_nsi_goods where f_article=:f_article into :f_good_id;
  end

  if (not exists (select 1 from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm))) then
  begin
    f_izm=GEN_ID(GEN_T_NSI_ED_IZM_ID,1);
    execute procedure SP_T_NSI_ED_IZM_I(:f_izm,:f_ed_izm,:f_ed_izm);
  end
  else
    select f_id from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm) into :f_id;
  if (f_good_id<1) then
  begin
    select f_id
    from
      SP_T_NSI_GOODS_I(:f_name,null,:f_article,:f_izm)
    into :f_good_id;
    insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_NSI_GOODS',:f_ext_base,:f_ext_id,:f_good_id);
  end
  execute procedure SP_T_DOC_IN_STR_I(null, :f_doc_id,:f_good_id,:f_price,:f_count,null);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_MOVE (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_SKLAD BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_USER VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
declare variable V_SELF_SKLAD bigint;
declare variable V_IS_FILIAL smallint = 0;
declare variable V_DEF_PRICE bigint;
begin
  select f_id from SP_T_DOC_move_GET(-10) into :f_id;
  insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_DOC_MOVE',:f_ext_base,:f_ext_id,:f_id);
  select param_value from SP_GET_SYS_PARAM('default_sklad') into :v_self_sklad;
  select PARAM_VALUE
    from SP_GET_SYS_PARAM('IS_FILIAL')
    into :V_IS_FILIAL;
  if (v_is_filial = 1) then
  begin
    if (v_self_sklad is not null) then
      select f_price_in from sp_t_nsi_sklad_get(:v_self_sklad) into :v_def_price;
  end
  else
    select f_price_in from sp_t_nsi_sklad_get(:f_sklad) into :v_def_price;
  execute procedure sp_t_doc_move_u(:f_id,:f_date,:f_number,:f_sklad,:v_self_sklad, null,null,
    :v_def_price, null, null,null, :f_user);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_OUT (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_SKLAD BIGINT,
    F_DISCOUNT_CARD VARCHAR(60) = null,
    F_USER VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
begin
  select f_id from SP_T_DOC_out_GET(-10,:f_doc_type,:f_sklad) into :f_id;
  insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_DOC_out',:f_ext_base,:f_ext_id,:f_id);
  if (not exists (select f_id from t_nsi_partner where f_id=:f_partner)) then
    f_partner=null;
  execute procedure sp_t_doc_out_u(:f_id,:f_sklad, :f_partner,:f_number,:f_date,null,null,null,null,:f_discount_card,
    null, null,:f_user);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_OUT_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_PRICE NUMERIC(15,3),
    F_SKIDKA NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT,
    F_DESCR VARCHAR(255) = null)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
declare variable F_IZM bigint;
declare variable V_STR_ID bigint;
begin
  f_good_id=0;
  if (exists(select first 1 f_id from t_nsi_goods where f_article=:f_article) ) then
  begin
    select first 1 f_id from t_nsi_goods where f_article=:f_article into :f_good_id;
  end
  if (not exists (select 1 from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm))) then
  begin
    f_izm=GEN_ID(GEN_T_NSI_ED_IZM_ID,1);
    execute procedure SP_T_NSI_ED_IZM_I(:f_izm,:f_ed_izm,:f_ed_izm);
  end
  else
    select f_id from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm) into :f_id;
  if (f_good_id<1) then
  begin
    select f_id
    from
      SP_T_NSI_GOODS_I(:f_name,null,:f_article,:f_izm)
    into :f_good_id;
    insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_NSI_GOODS',:f_ext_base,:f_ext_id,:f_good_id);
  end
  v_str_id=gEN_ID(gen_t_doc_out_str_id,1);
  execute procedure SP_T_DOC_out_STR_I(:v_str_id, :f_doc_id,:f_good_id,null,:f_count,null,0,:f_descr);
  update t_doc_out_str set f_price_val=:f_price,f_price_val_nsi=:f_price+coalesce(:f_skidka/:f_count,0) where f_id=:v_str_id;
  /*execute procedure SP_T_DOC_out_STR_u(:v_str_id,null, null,:f_price,null,null);
  update t_doc_out_str set f_price_val=:f_price where f_id=:v_str_id;*/
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_PRICE (
    F_NUMBER VARCHAR(20),
    F_PRICE BIGINT,
    F_DATE DATE)
RETURNS (
    F_ID BIGINT)
AS
DECLARE VARIABLE F_STATE BIGINT;
begin
  /* Procedure Text */
  f_id=GEN_ID(GEN_t_doc_price_ID,1);
  select param_value from SP_GET_SYS_PARAM('out_doc_state') into :f_state;
  execute procedure SP_T_DOC_PRICE_I(:f_id, :f_number,'now',null,:f_state,:f_price);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_PRICE_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_PRICE NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
DECLARE VARIABLE F_IZM BIGINT;
begin
  f_good_id=0;
  if (exists(select first 1 f_id from t_nsi_goods where f_article=:f_article) ) then
  begin
    select first 1 f_id from t_nsi_goods where f_article=:f_article into :f_good_id;
  end

  if (not exists (select 1 from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm))) then
  begin
    f_izm=GEN_ID(GEN_T_NSI_ED_IZM_ID,1);
    execute procedure SP_T_NSI_ED_IZM_I(:f_izm,:f_ed_izm,:f_ed_izm);
  end
  else
    select f_id from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm) into :f_id;
  if (f_good_id<1) then
  begin
    select f_id
    from
      SP_T_NSI_GOODS_I(:f_name,null,:f_article,:f_izm)
    into :f_good_id;
    insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_NSI_GOODS',:f_ext_base,:f_ext_id,:f_good_id);
  end

  execute procedure SP_T_DOC_PRICE_STR_I(:f_good_id,:f_price,:f_doc_id);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_DOC_TEMPLATE (
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20),
    F_DOC_TYPE BIGINT,
    F_SKLAD BIGINT)
RETURNS (
    F_ID BIGINT)
AS
begin
  select f_id from SP_T_DOC_TEMPLATE_GET(-10) into :f_id;
  if (not exists (select f_id from t_nsi_partner where f_id=:f_partner)) then
    f_partner=null;
  execute procedure sp_t_doc_TEMPLATE_u(:f_id,:f_number,:f_date,null,null,:f_sklad,:f_partner);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_INVENTORY_DOC_STR (
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_EXT_ID VARCHAR(20),
    F_EXT_BASE BIGINT,
    F_DOC_ID BIGINT)
RETURNS (
    F_GOOD_ID BIGINT,
    F_ID BIGINT)
AS
DECLARE VARIABLE F_IZM BIGINT;
DECLARE VARIABLE V_STR_ID BIGINT;
begin
  f_good_id=0;
  if (exists(select first 1 f_id from t_nsi_goods where f_article=:f_article) ) then
  begin
    select first 1 f_id from t_nsi_goods where f_article=:f_article into :f_good_id;
  end
  if (not exists (select 1 from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm))) then
  begin
    f_izm=GEN_ID(GEN_T_NSI_ED_IZM_ID,1);
    execute procedure SP_T_NSI_ED_IZM_I(:f_izm,:f_ed_izm,:f_ed_izm);
  end
  else
    select f_id from t_nsi_ed_izm where upper(f_name)=upper(:f_ed_izm) into :f_id;
  if (f_good_id<1) then
  begin
    select f_id
    from
      SP_T_NSI_GOODS_I(:f_name,null,:f_article,:f_izm)
    into :f_good_id;
    insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_NSI_GOODS',:f_ext_base,:f_ext_id,:f_good_id);
  end
  v_str_id=gEN_ID(gen_t_inventory_doc_str_id,1);
  execute procedure SP_T_inventory_doc_STR_I(:v_str_id,:f_good_id,:f_count,:f_doc_id);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_DISCOUNT_CARD (
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
declare variable V_IS_FILIAL integer;
declare variable V_DISCOUNT_ID bigint;
begin
  select param_value from sp_get_sys_param('IS_FILIAL') into :v_is_filial;
  select f_card_id from SP_GET_NSI_DISCOUNT(:f_number) into :v_discount_id;
  if (v_discount_id is null) then
  begin
    select f_discount_id from sp_t_nsi_discount_create into :v_discount_id;
    execute procedure SP_T_NSI_DISCOUNT_CARD_U(:v_discount_id,:f_number,:f_discount);
  end
  else
  begin
    if (v_is_filial=1) then
    begin
      execute procedure SP_T_NSI_DISCOUNT_CARD_U(:v_discount_id,:f_number,:f_discount);
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_GOOD (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_PARTNER BIGINT,
    F_EXT_BASE BIGINT,
    F_DOP_INFO VARCHAR(10000) = null,
    F_BARTER SMALLINT = 0,
    F_PICTURE_NAME VARCHAR(60) = null)
RETURNS (
    F_GOOD_ID BIGINT)
AS
declare variable S varchar(60);
declare variable I integer;
declare variable F_SELF_ARTICLE varchar(20);
begin
  f_good_id=0;
  select OUT_STR from PR_CONVERT_CYR_STR(:f_article) into :f_self_article;
  if (exists(select first 1 f_id from t_nsi_goods where f_ext_article=:f_article) ) then
  begin
    select first 1 f_id from t_nsi_goods where f_ext_article=:f_article into :f_good_id;
  end
  else
  begin
    if (exists(select first 1 f_id from t_nsi_goods where f_article=:f_self_article) ) then
      select first 1 f_id from t_nsi_goods where f_article=:f_self_article into :f_good_id;
  end
  if (f_good_id<1) then
  begin

    i=0;
    s=f_self_article;
    while (exists(select f_id from t_nsi_goods where f_article=:s)) do
    begin
      i=i+1;
      s=f_self_article||'_'||i;
    end
    f_self_article=s;
    select f_id
    from
      SP_T_NSI_GOODS_I(:f_name,null,:f_self_article,null,:f_article)
    into :f_good_id;
    execute procedure sp_t_nsi_goods_u(:f_good_id,null,null, null,null,:f_dop_info,:f_barter);
    insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_NSI_GOODS',:f_ext_base,:f_id,:f_good_id);
  end
  if (exists (select f_id from t_nsi_partner where f_id=:f_partner)) then
    update t_nsi_goods set f_partner=:f_partner where f_id=:f_good_id;
  suspend;
  if (F_PICTURE_NAME is not null) then
  begin
    if (not exists(select 1 from t_nsi_goods_mmedia where f_good=:f_good_id)) then
      execute procedure sp_t_nsi_goods_mmedia_i(null,:f_good_id,:f_picture_name,null);
    else
      update t_nsi_goods_mmedia set f_name=:f_picture_name where f_good=:f_good_id;
  end
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_PARTNER (
    F_NAME VARCHAR(60),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_ADDRESS VARCHAR(255),
    F_EXT_BASE VARCHAR(20),
    F_EXT_ID VARCHAR(20))
RETURNS (
    F_ID BIGINT)
AS
begin
  f_id=null;
  select first 1 f_id
  from
  (
    select f_id
    from
      t_nsi_partner
    where
      f_name=upper(:f_name)
      and trim(coalesce(f_name,''))<>''
    union
    select f_id
    from
      t_nsi_partner
    where
      f_inn=:f_inn
      and trim(coalesce(f_inn,''))<>''
/*    union
    select f_self_id
    from
      t_sys_links s
    where
      f_table_name='T_NSI_PARTNER'
      and s.f_remote_id=:f_ext_id*/
    )
    into :f_id;
  if ((f_id is null) and (trim(coalesce(f_inn,''))<>'') and (trim(coalesce(f_name,''))<>'')) then
  begin
    f_id=GEN_ID(GEN_t_nsi_partner_ID,1);
    execute procedure sp_t_nsi_partner_i(:f_id,:f_name,:f_name,:f_address,:f_inn,:f_kpp);
    insert into t_sys_links(f_table_name,f_remote_base,f_remote_id,f_self_id) values('T_NSI_PARTNER',:f_ext_base,:f_ext_id,:f_id);
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_PRICE (
    F_PRICE_ID BIGINT,
    F_PRICE_NAME VARCHAR(60))
RETURNS (
    F_ID BIGINT)
AS
begin
  if (not exists(select f_id from t_nsi_price  where f_name=:f_price_name)) then
  begin
    f_id=GEN_ID(GEN_t_nsi_price_ID,1);
    insert into t_nsi_price(f_id,f_name) values (:f_id,:f_price_name);
    suspend;
  end
  else
  begin
    select first 1 f_id from t_nsi_price where f_name=:f_price_name and f_state=1 into :f_id;
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_IMPORT_NSI_SCANCODE (
    F_GOOD BIGINT,
    F_SCANCODE VARCHAR(20))
RETURNS (
    F_RESULT SMALLINT)
AS
begin
/*    if (exists (select 1 from t_nsi_scancode where f_value=:f_scancode and f_good<>:f_good)) then
    begin
      f_result=-1;
    end
    else
    begin*/
      if (not exists (select 1 from SP_T_NSI_SCANCODE_GET(:f_good) where f_value=:f_scancode)) then
        execute procedure SP_T_NSI_SCANCODE_I(null,:f_scancode,:f_good,1);
      f_result=1;
 --   end
    suspend;
end^


CREATE OR ALTER PROCEDURE SP_INVENTORY_MAKE_DOCS_BY_REZ (
    F_INVENTORY_ID BIGINT)
AS
declare variable V_MOVE_IN_DOC bigint;
declare variable V_MOVE_OUT_DOC bigint;
declare variable V_SKLAD bigint;
declare variable V_DATE date;
begin
  select coalesce(f_date_complete,'now'),f_sklad from t_inventory where f_id=:f_inventory_id
    into :v_date,:v_sklad;
  if (exists (select f_id from t_inventory_str where f_inventory=:f_inventory_id and coalesce(f_count_plan,0)>coalesce(f_count_fact,0))) then
  begin

    select f_Id from SP_T_DOC_MOVE_GET(-10) into :v_move_out_doc;
    update t_doc_move set f_type=2,
      f_sklad_to=null,f_sklad_from=:v_sklad,f_date=:v_date where f_id=:v_move_out_doc;
    insert into t_doc_move_str(f_doc_move,f_good,f_cnt)
    select :v_move_out_doc,f_good,(coalesce(f_count_plan,0)-coalesce(f_count_fact,0))
      from t_inventory_str where f_inventory=:f_inventory_id and coalesce(f_count_plan,0)>coalesce(f_count_fact,0);
  end

  if (exists (select f_id from t_inventory_str where f_inventory=:f_inventory_id and coalesce(f_count_plan,0)<coalesce(f_count_fact,0))) then
  begin
    select f_Id from SP_T_DOC_MOVE_GET(-10) into :v_move_in_doc;
    update t_doc_move set f_type=3,
      f_sklad_from=null,f_sklad_to=:v_sklad,f_date=:v_date where f_id=:v_move_in_doc;
    insert into t_doc_move_str(f_doc_move,f_good,f_cnt)
    select :v_move_in_doc,f_good,(coalesce(f_count_fact,0)-coalesce(f_count_plan,0))
      from t_inventory_str where f_inventory=:f_inventory_id and coalesce(f_count_plan,0)<coalesce(f_count_fact,0);
  end
end^


CREATE OR ALTER PROCEDURE SP_MAKE_PARTY_FROM_DOC_IN (
    P_DOC_IN BIGINT)
AS
declare variable V_GOOD bigint;
declare variable V_DATE date;
declare variable V_CNT numeric(15,3);
declare variable V_PARTY_ID bigint;
declare variable V_PRICE numeric(15,3);
declare variable V_DOC_STR_ID integer;
begin
  for select S.F_ID, D.F_DATE, S.F_GOOD, S.F_CNT, S.F_PRICE_VAL, S.F_GOOD_PARTY
      from T_DOC_IN D
      inner join T_DOC_IN_STR S on D.F_ID = S.F_DOC_IN
      where D.F_ID = :P_DOC_IN
      into :V_DOC_STR_ID, :V_DATE, :V_GOOD, :V_CNT, :V_PRICE, :V_PARTY_ID
  do
  begin
    if (V_PARTY_ID is null) then
    begin
      select F_ID
      from SP_T_NSI_GOOD_PARTY_CREATE(:V_GOOD, :V_DATE, :V_CNT, :V_PRICE)
      into :V_PARTY_ID;
      update T_DOC_IN_STR
      set F_GOOD_PARTY = :V_PARTY_ID
      where F_ID = :V_DOC_STR_ID;
    end
    else
      update T_NSI_GOOD_PARTY
      set F_CNT = :V_CNT,
          F_PRICE = :V_PRICE
      where F_ID = :V_PARTY_ID;

  end
end^


CREATE OR ALTER PROCEDURE SP_MAKE_PARTY_FROM_DOC_MOVE (
    P_DOC_MOVE BIGINT)
AS
declare variable V_GOOD bigint;
declare variable V_DATE date;
declare variable V_CNT numeric(15,3);
declare variable V_PARTY_ID bigint;
declare variable V_PRICE numeric(15,3);
declare variable V_DOC_STR_ID integer;
begin
  for select S.F_ID, D.F_DATE, S.F_GOOD, S.F_CNT, S.F_PRICE_VAL, S.F_GOOD_PARTY
      from T_DOC_move D
      inner join T_DOC_move_STR S on D.F_ID = S.F_DOC_move
      where D.F_ID = :P_DOC_move
      into :V_DOC_STR_ID, :V_DATE, :V_GOOD, :V_CNT, :V_PRICE, :V_PARTY_ID
  do
  begin
    if (V_PARTY_ID is null) then
    begin
      select F_ID
      from SP_T_NSI_GOOD_PARTY_CREATE(:V_GOOD, :V_DATE, :V_CNT, :V_PRICE)
      into :V_PARTY_ID;
      update T_DOC_move_STR
      set F_GOOD_PARTY = :V_PARTY_ID
      where F_ID = :V_DOC_STR_ID;
    end
    else
      update T_NSI_GOOD_PARTY
      set F_CNT = f_cnt + :V_CNT,
          F_PRICE = :V_PRICE
      where F_ID = :V_PARTY_ID;

  end
end^


CREATE OR ALTER PROCEDURE SP_MONEY_IN_AUTO (
    F_MONEY BIGINT,
    F_SUM NUMERIC(15,3) = -1)
AS
declare variable V_PAY_SUM numeric(15,3);
declare variable V_DOC_OUT bigint;
declare variable V_PARTNER bigint;
declare variable V_DOC_SUM numeric(15,3);
declare variable V_MONEY_TYPE integer;
begin
  select
    f_partner,
    case
      when :f_sum>1 then :f_sum
      else (f_summa-coalesce(f_doc_sum,0))
    end,
    case
      when F_TYPE=2 then 2
      else 1
    end
  from sp_t_money_in_get(:f_money,null) into :v_partner,:v_pay_sum,:v_money_type;
  for
    select
      f_id,
      f_doc_sum-coalesce(f_pay_sum,0)
    from
      t_doc_out
    where
      (f_doc_sum-coalesce(f_pay_sum,0))>0 and
      f_partner=:v_partner
      and f_date>=cast( '10.01.2012' as date)
      and f_state>=3
      and coalesce(F_MONEY_TYPE,:v_money_type)=:v_money_type
    order by
      f_date
    into
      :v_doc_out,
      :v_doc_sum
  do
  begin
    if (v_doc_sum>v_pay_sum) then
    begin
      v_doc_sum=v_pay_sum;
      v_pay_sum=0;
    end
    else
      v_pay_sum=v_pay_sum-v_doc_sum;
    --f_pay=v_pay_sum;
    --suspend;
    if (v_doc_sum>0) then
      execute procedure SP_T_MONEY_IN_STR_I(null, :v_doc_out,:f_money,:v_doc_sum);
    if (v_pay_sum=0) then
      exit;
  end
end^


CREATE OR ALTER PROCEDURE SP_MONEY_OUT_AUTO (
    F_MONEY BIGINT,
    F_SUM NUMERIC(15,3) = -1)
AS
declare variable V_PAY_SUM numeric(15,3);
declare variable V_DOC_OUT bigint;
declare variable V_PARTNER bigint;
declare variable V_DOC_SUM numeric(15,3);
begin
  select
    f_partner,
    case
      when :f_sum>1 then :f_sum
      else (f_summa-coalesce(f_doc_sum,0))
    end
  from sp_t_money_out_get(:f_money,null) into :v_partner,:v_pay_sum;
  for
    select
      f_id,
      f_doc_sum-coalesce(f_pay_sum,0)
    from
      t_doc_in
    where
      (f_doc_sum-coalesce(f_pay_sum,0))>0 and
      f_partner=:v_partner
      and f_state>0
    order by
      f_date
    into
      :v_doc_out,
      :v_doc_sum
  do
  begin
    if (v_doc_sum>v_pay_sum) then
    begin
      v_doc_sum=v_pay_sum;
      v_pay_sum=0;
    end
    else
      v_pay_sum=v_pay_sum-v_doc_sum;
    --f_pay=v_pay_sum;
    --suspend;
    if (v_doc_sum>0) then
      execute procedure SP_T_MONEY_out_STR_I(null, :v_doc_out,:f_money,:v_doc_sum);
    if (v_pay_sum=0) then
      exit;
  end
end^


CREATE OR ALTER PROCEDURE SP_MOVE_GOODS_MMEDIA
AS
declare variable V_ID bigint;
declare variable V_GOOD bigint;
declare variable V_NAME varchar(60);
declare variable V_PHOTO blob sub_type 0 segment size 80;
declare variable V_CH_DATE timestamp = 'NOW';
declare variable V_DEST varchar(60);
declare variable V_START date;
declare variable V_END date;
declare variable V_DEST_ID bigint;
declare variable V_USER varchar(60);
declare variable V_PASSWD varchar(60);
begin
  for select F_ID, F_DATE_FROM, F_DATE_TO, F_HOST || ':' || F_BASE, F_USER, f_PASSWORD
      from T_SYS_SOURCE_DBASE
      into :V_DEST_ID, :V_START, :V_END, :V_DEST, :v_user,:v_passwd
  do
  begin
    for select F_ID, F_NAME, F_GOOD, F_MEMO, F_CH_DATE
        from T_NSI_GOODS_MMEDIA
        where F_CH_DATE between :V_START and :V_END
        into :V_ID, :V_NAME, :V_GOOD, :V_PHOTO, :V_CH_DATE
    do
    begin
      execute statement ('execute procedure SP_T_NSI_GOODS_MMEDIA_I(:f_id,:f_good,:f_name,:f_memo,:f_ch_date)')
        (f_id := v_id, f_good:=v_good, f_name:=v_name, f_memo:=v_photo, f_ch_date:=v_ch_date)
        ON EXTERNAL :v_dest
        as user :v_user password :v_passwd;
      insert into t_nsi_goods_mmedia_map(f_good,f_mmedia,f_source)
        values(:v_good,:v_id, :v_dest_id);
      execute procedure sp_t_nsi_goods_mmedia_d(:v_id);
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_RECALC_PARTY_OST (
    P_GOOD BIGINT)
AS
declare variable V_PARTY bigint;
declare variable V_CNT numeric(15,3);
declare variable V_PARTY_DATE integer;
begin
  /* Procedure Text */
  for select f_id,f_cnt,f_date from t_nsi_good_party
  where f_good=:p_good
  order by f_date
  into :v_party,:v_cnt,:v_party_date do
  begin

  end

end^


CREATE OR ALTER PROCEDURE SP_REFRESH_T_OST
AS
declare variable V_SKLAD bigint;
begin
  delete from T_OST;
  for select F_ID
      from T_NSI_SKLAD where f_state=1
      into :V_SKLAD
  do
  begin
    insert into T_OST (F_GOOD, F_SKLAD, F_DATE, F_END_OST)
    select F_GOOD, F_SKLAD, F_DATE, F_END_OST
    from SP_T_REG_GOOD_S(:V_SKLAD, current_date, null,null, 0)
    where f_good is not null;
  end
end^


CREATE OR ALTER PROCEDURE SP_ROUND (
    F_VALUE FLOAT,
    F_RND FLOAT)
RETURNS (
    F_RESULT NUMERIC(10,3))
AS
DECLARE VARIABLE I NUMERIC(10,3);
DECLARE VARIABLE J BIGINT;
DECLARE VARIABLE N BIGINT;
DECLARE VARIABLE CNT INTEGER;
DECLARE VARIABLE K BIGINT;
DECLARE VARIABLE P NUMERIC(10,3);
begin
  f_result=0;
  cnt=1;
  k=cast(f_rnd as integer);
  p=f_rnd;
  while (k<>p) do
  begin
    cnt=cnt*10;
    p=p*10;
    k=p;
  end
  J=f_value*cnt;
  I=J/p;
  N=J/p;
  while (N<>I) do
  begin
    J=J+1;
    I=J/p;
    N=J/p;
  end
  f_result=cast(J as numeric(10,3))/cnt;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_SET_PARTY_FOR_DOC_OUT (
    P_DOC_OUT BIGINT)
AS
declare variable V_ID bigint;
declare variable V_GOOD bigint;
declare variable V_DATE date;
declare variable V_CNT numeric(15,3);
declare variable V_PARTY_CNT numeric(15,3);
declare variable V_PARTY_ID bigint;
begin
  for select
    ds.f_id,ds.f_good,d.f_date,ds.f_cnt
    from
    t_doc_out d
    inner join t_doc_out_str ds on d.f_id=ds.f_doc_out
    where
--      d.f_type in (1,2)
--      and d.f_state>=3
      d.f_id=:p_doc_out
    into :v_id,:v_good,:v_date,:v_cnt do
  begin
    for select
    n.f_id,n.f_cnt-sum(coalesce(p.f_cnt,0))
      from
        t_nsi_good_party n
        left outer join t_doc_out_str_party p
        on n.f_id = p.f_party
      where f_good=:v_good
      and f_date<=:v_date
      group by n.f_id,n.f_date,n.f_cnt
      having n.f_cnt-sum(coalesce(p.f_cnt,0))>0
      order by n.f_date

    into :v_party_id,:v_party_cnt do
    begin
      if (v_party_cnt>=v_cnt) then
        insert into t_doc_out_str_party(f_doc_out_str,f_party,f_cnt)
          values(:v_id,:v_party_id,:v_cnt);
      else
        insert into t_doc_out_str_party(f_doc_out_str,f_party,f_cnt)
          values(:v_id,:v_party_id,:v_party_cnt);
      v_cnt = v_cnt-v_party_cnt;
      if (v_cnt <= 0) then
      leave;
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_SET_PRICE_FROM_NSI (
    F_PRICE BIGINT,
    F_DOC BIGINT)
AS
DECLARE VARIABLE GOOD_ID BIGINT;
DECLARE VARIABLE DOC_STR_ID BIGINT;
DECLARE VARIABLE PRICE_VAL NUMERIC(15,3);
begin
  for
  select
    f_id,
    f_good
  from sp_t_doc_in_str_s(:f_doc)
  into
    :doc_str_id,
    :good_id do
  begin
    price_val=0;
    select f_value from sp_t_price_get(:f_price,:good_id) into :price_val;
    if (coalesce(price_val,0)>0) then
      update t_doc_in_str set f_price_val=:price_val where f_id=:doc_str_id;
  end
end^


CREATE OR ALTER PROCEDURE SP_SET_SYS_CONTEXT (
    P_CONTEXT_NAME D_STR,
    P_CONTEXT_VAL D_STR)
AS
declare variable V_CONTEXT_VAL D_STR;
declare variable V_RES integer;
begin

  select F_CONTEXT_VAL
  from T_SYS_CONTEXT_VAL
  where F_CONTEXT_NAME = :P_CONTEXT_NAME
  into :V_CONTEXT_VAL;
  if (P_CONTEXT_VAL = V_CONTEXT_VAL) then
    select RDB$SET_CONTEXT('USER_SESSION', :P_CONTEXT_NAME,1) from rdb$database into :v_res;
  else
    execute procedure PR_EXEC_EXCEPTION(8);

  --  suspend;
end^


CREATE OR ALTER PROCEDURE SP_SET_SYS_PARAM (
    PARAM_NAME VARCHAR(60),
    PARAM_VALUE VARCHAR(60),
    OVERWRITE SMALLINT = 0)
AS
begin
  if (exists (select 1 from t_sys_params where f_name=upper(:param_name))) then
  begin
    if (overwrite=1) then
      update t_sys_params set f_value=:param_value where f_name=upper(:param_name);
  end
  else
      insert into t_sys_params(f_name,f_value) values (upper(:param_name),:param_value);
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_D (
    F_ID BIGINT)
AS
declare variable V_SYS_ST bigint;
declare variable V_CHECK_ZAPAS bigint;
BEGIN
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :v_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :v_check_zapas;
  if (not exists(select f_id from t_doc_in where f_id=:f_id and f_state>=:v_sys_st and :v_check_zapas=1)) then
    update t_doc_in set f_state=-1 WHERE (F_ID = :F_ID);
  else
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_GET (
    DOC_ID BIGINT,
    DOC_TYPE BIGINT = 0)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PARTNER_NAME VARCHAR(60),
    F_PARTNER_KPP VARCHAR(20),
    F_PARTNER_INN VARCHAR(20),
    F_STATE_NAME VARCHAR(60),
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD_INN VARCHAR(20),
    F_SKLAD_F_NAME VARCHAR(100),
    F_SKLAD_KPP VARCHAR(20),
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_DOC_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_USER VARCHAR(60),
    F_TYPE_NAME VARCHAR(255))
AS
begin
  if (DOC_ID = -10) then
  begin
    F_ID = gen_id(GEN_T_DOC_IN_ID, 1);
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('default_sklad')
    into :F_SKLAD;
    F_DATE = 'now';
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('in_doc_state')
    into :F_STATE;
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('default_in_price')
    into :F_PRICE;
    if (DOC_TYPE < 1) then
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('IN_DOC_TYPE')
      into :F_DOC_TYPE;
    else
      F_DOC_TYPE = DOC_TYPE;
    select F_NAME, coalesce(F_PRICE_IN, :F_PRICE)
    from SP_T_NSI_SKLAD_GET(:F_SKLAD)
    into :F_SKLAD_NAME, :F_PRICE;
    select F_NAME
    from SP_T_NSI_PRICE_GET(:F_PRICE)
    into :F_PRICE_NAME;
    if (F_NUMBER is null) then
      select F_RESULT
      from SP_GET_DOC_NUM(:F_SKLAD)
      into :F_NUMBER;
    F_USER = current_user;
    execute procedure SP_T_DOC_IN_I(:F_ID, :F_SKLAD, null, :F_NUMBER, :F_DATE, :F_STATE, :F_PRICE, :F_DOC_TYPE);
  end
  else
  begin
    select F_ID, F_SKLAD, F_PARTNER, F_NUMBER, F_DATE, F_STATE, F_PRICE, F_TYPE, F_DOC_SUM, F_USER
    from T_DOC_IN
    where F_ID = :DOC_ID
    into :F_ID, :F_SKLAD, :F_PARTNER, :F_NUMBER, :F_DATE, :F_STATE, :F_PRICE, :F_DOC_TYPE, :F_DOC_SUM, :F_USER;
    /*    if (not exists(select 1 from sp_check_sys_privs('T_DOC_IN') where f_RESULT='SEL' and (f_type='ANY' or f_type=:f_doc_type ) and (f_state='ANY' or f_state=:f_state))) then
      EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);*/
    if (coalesce(F_PARTNER, -1) > 0) then
      select F_NAME, F_INN, F_KPP
      from SP_T_NSI_PARTNER_GET(:F_PARTNER)
      into :F_PARTNER_NAME, :F_PARTNER_INN, :F_PARTNER_KPP;
    if (coalesce(F_SKLAD, -1) > 0) then
      select F_NAME, F_PARTNER_KPP, F_PARTNER_INN, F_PARTNER_NAME
      from SP_T_NSI_SKLAD_GET(:F_SKLAD)
      into :F_SKLAD_NAME, :F_SKLAD_KPP, :F_SKLAD_INN, :F_SKLAD_F_NAME;
    if (coalesce(F_PRICE, -1) > 0) then
      select F_NAME
      from SP_T_NSI_PRICE_GET(:F_PRICE)
      into :F_PRICE_NAME;
  end
  select F_NAME
  from SP_T_NSI_STATE_GET(:F_STATE)
  into :F_STATE_NAME;
  select F_NAME
  from SP_T_NSI_DOC_IN_TYPES_GET(:F_DOC_TYPE)
  into :F_TYPE_NAME;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_DOC_TYPE BIGINT)
AS
BEGIN
  INSERT INTO T_DOC_IN (
    F_ID,
    F_SKLAD,
    F_PARTNER,
    F_NUMBER,
    F_DATE,
    F_STATE,
    f_price,
    f_type)
  VALUES (
    :F_ID,
    :F_SKLAD,
    :F_PARTNER,
    :F_NUMBER,
    :F_DATE,
    :F_STATE,
    :f_price,
    :f_doc_type);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_S (
    P_DOC_TYPE BIGINT = -1,
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_DOC_COUNT FLOAT,
    F_DOC_SUM NUMERIC(15,3),
    F_SKLAD_NAME VARCHAR(60),
    F_PARTNER_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_DOC_TYPE BIGINT,
    F_DOC_TYPE_NAME VARCHAR(60),
    F_USER VARCHAR(60),
    F_PAY_SUM NUMERIC(15,3))
AS
BEGIN
  FOR SELECT F_ID,
             F_SKLAD,
             F_PARTNER,
             F_NUMBER,
             F_DATE,
             d.F_STATE,
             f_doc_count,
             f_doc_sum,
             d.f_type,
             f_user,
             d.f_pay_sum
      FROM T_DOC_IN d,
        SP_CHECK_SYS_PRIVS('T_DOC_IN') p
      where
        (d.f_type=:p_doc_type
        or coalesce(:p_doc_type,-1)<0)
        and d.f_state>0
        and f_date between coalesce(:str_date,f_date) and coalesce(:end_date, f_date)
        and p.f_result = 'SEL'
        and iif(p.f_type='ANY',d.f_type,p.f_type)=d.f_type
        and iif(p.f_state='ANY',d.f_state,p.f_state)=d.f_state
      INTO :F_ID,
           :F_SKLAD,
           :F_PARTNER,
           :F_NUMBER,
           :F_DATE,
           :F_STATE,
           :f_doc_count,
           :f_doc_sum,
           :f_doc_type,
           :f_user,
           :f_pay_sum
  DO
  BEGIN
    if (coalesce(f_partner,-1)>0) then
        select f_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
    else
        f_partner_name=null;
    if (coalesce(f_state,-1)>0) then
        select f_name from sp_t_nsi_state_get(:f_state) into :f_state_name;
    else
        f_state_name=null;
    if (coalesce(f_sklad,-1)>0) then
        select f_name from sp_t_nsi_sklad_get(:f_sklad) into :f_sklad_name;
    else
        f_sklad_name=null;
    select f_name from SP_T_NSI_DOC_IN_TYPES_GET(:f_doc_type) into :f_doc_type_name;
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_DOC_IN_STR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_I (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT FLOAT,
    F_SUM FLOAT)
AS
declare variable V_PRICE_ID bigint;
declare variable V_DOC_TYPE bigint;
declare variable V_DOC_OUT_STR_ID bigint;
declare variable V_CNT_OUT float;
declare variable V_CNT_IN float;
declare variable V_CNT_DOC float;
declare variable V_PRICE_VAL numeric(15,3);
declare variable V_DATE date;
declare variable V_PARTNER bigint;
declare variable V_TOTAL_CNT float;
begin
  if (f_cnt=0) then
    f_cnt = 1;
  if (exists(select 1
             from T_DOC_IN
             where F_ID = :F_DOC_IN)) then
  begin
    select F_PRICE, F_DOC_TYPE, F_DATE, F_PARTNER
    from SP_T_DOC_IN_GET(:F_DOC_IN, null)
    into :V_PRICE_ID, :V_DOC_TYPE, :V_DATE, :V_PARTNER;
    if (F_PRICE_VAL is null) then
      select F_VALUE
      from SP_T_PRICE_GET(:V_PRICE_ID, :F_GOOD)
      into :F_PRICE_VAL;

  end
  if (V_DOC_TYPE = 1 or V_DOC_TYPE = 3) then
  begin
    if (exists(select 1
               from T_DOC_IN_STR
               where F_DOC_IN = :F_DOC_IN and
                     F_GOOD = :F_GOOD and
                     f_price_val = :f_price_val )) then
    begin
      update T_DOC_IN_STR
      set F_CNT = F_CNT + coalesce(:F_CNT, 1)
      where F_DOC_IN = :F_DOC_IN and
            F_GOOD = :F_GOOD;
    end
    else
    begin
      insert into T_DOC_IN_STR (F_ID, F_DOC_IN, F_GOOD, F_PRICE_VAL, F_CNT)
      values (:F_ID, :F_DOC_IN, :F_GOOD, :F_PRICE_VAL, coalesce(:F_CNT, 1));
    end
  end
  if (V_DOC_TYPE = 2) then
  begin
    V_TOTAL_CNT = coalesce(F_CNT,1);
    if (f_cnt=0) then
      v_total_cnt = 1;
    for select DS.F_ID, DS.F_CNT, DS.F_PRICE_VAL
        from T_DOC_OUT D
        inner join T_DOC_OUT_STR DS on D.F_ID = DS.F_DOC_OUT and D.F_PARTNER = :V_PARTNER and DS.F_GOOD = :F_GOOD
        where D.F_DATE <= :V_DATE and
              D.F_TYPE in (1,2) and
              D.F_STATE >= 3
        order by D.F_DATE desc
        into :V_DOC_OUT_STR_ID, :V_CNT_OUT, :V_PRICE_VAL
    do
    begin
      select coalesce(sum(F_CNT),0)
      from T_DOC_IN_STR S
      where S.F_DOC_OUT_STR = :V_DOC_OUT_STR_ID
      into :V_CNT_IN;
      V_CNT_DOC = V_CNT_OUT - V_CNT_IN;
      if ((V_CNT_DOC < V_TOTAL_CNT) and
          (V_CNT_DOC > 0)) then
      begin
        F_CNT = V_CNT_DOC;
        V_TOTAL_CNT = V_TOTAL_CNT - F_CNT;
      end
      if ((V_CNT_DOC >= V_TOTAL_CNT) and (V_TOTAL_CNT>0)) then
      begin
        F_CNT = V_TOTAL_CNT;
        V_TOTAL_CNT = V_TOTAL_CNT - F_CNT;
      end
      if (V_CNT_DOC > 0) then
      begin
        if (exists(select 1
                   from T_DOC_IN_STR
                   where F_DOC_IN = :F_DOC_IN and
                         F_GOOD = :F_GOOD and
                         F_DOC_OUT_STR = :V_DOC_OUT_STR_ID)) then
        begin
          update T_DOC_IN_STR
          set F_CNT = F_CNT + coalesce(:F_CNT, 1)
          where F_DOC_IN = :F_DOC_IN and
                F_GOOD = :F_GOOD and
                F_DOC_OUT_STR = :V_DOC_OUT_STR_ID;
        end
        else
        begin
          insert into T_DOC_IN_STR (F_ID, F_DOC_IN, F_GOOD, F_PRICE_VAL, F_CNT, F_DOC_OUT_STR)
          values (:F_ID, :F_DOC_IN, :F_GOOD, :V_PRICE_VAL, coalesce(:F_CNT, 1), :V_DOC_OUT_STR_ID);
        end
      end
      if (V_TOTAL_CNT <= 0) then
        leave;
    end

    if (V_TOTAL_CNT > 0) then
    begin
      if (exists(select 1
                 from T_DOC_IN_STR
                 where F_DOC_IN = :F_DOC_IN and
                       F_GOOD = :F_GOOD
                       and F_DOC_OUT_STR is null)) then
      begin
        update T_DOC_IN_STR
        set F_CNT = F_CNT + coalesce(:V_TOTAL_CNT, 1)
        where F_DOC_IN = :F_DOC_IN and
              F_GOOD = :F_GOOD and
              F_DOC_OUT_STR is null;
      end
      else
      begin
        insert into T_DOC_IN_STR (F_ID, F_DOC_IN, F_GOOD, F_PRICE_VAL, F_CNT)
        values (:F_ID, :F_DOC_IN, :F_GOOD, :F_PRICE_VAL, coalesce(:V_TOTAL_CNT, 1));
      end
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_S (
    DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_SKLAD_OST FLOAT,
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_GOOD_PARTNER BIGINT,
    F_OLD_PRICE_VAL NUMERIC(15,3),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_ICON BIGINT)
AS
declare variable V_PRICE bigint;
declare variable V_PRICE_DATE date;
declare variable V_DOC_DATE date;
declare variable V_SKLAD bigint;
begin
  if (DOC_ID is not null) then
    select F_PRICE, F_DATE, F_SKLAD
    from SP_T_DOC_IN_GET(:DOC_ID)
    into :V_PRICE, :V_DOC_DATE, :V_SKLAD;
  if (V_DOC_DATE is not null) then
  begin
    V_PRICE_DATE = V_DOC_DATE - 1;
  end
  for select F_ID, F_DOC_IN, F_GOOD, F_PRICE_VAL, F_CNT, F_SUM
      from T_DOC_IN_STR
      where F_DOC_IN = :DOC_ID
      into :F_ID, :F_DOC_IN, :F_GOOD, :F_PRICE_VAL, :F_CNT, :F_SUM
  do
  begin
    if (coalesce(F_GOOD, -1) > 0) then
    begin
      select F_END_OST
      from SP_T_REG_GOOD_GET(:F_GOOD, :V_DOC_DATE, :V_SKLAD)
      into :F_SKLAD_OST;
      select F_NAME, F_ARTICLE, F_ED_IZM_NAME, F_ED_IZM_SHORT_NAME, F_SCANCODE, F_DOP_INFO, F_PARTNER,
             F_GOODS_GRP_COLOR
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_ARTICLE, :F_ED_IZM_NAME, :F_ED_IZM_SHORT_NAME, :F_SCANCODE, :F_GOOD_DOP_INFO,
           :F_GOOD_PARTNER, :F_GOOD_GRP_COLOR;
      if (V_PRICE is not null) then
        if (V_PRICE_DATE is not null) then
        begin
          select F_VALUE
          from SP_T_PRICE_GET(:V_PRICE, :F_GOOD, :V_PRICE_DATE)
          into :F_OLD_PRICE_VAL;
        end
      if (exists(select 1
                 from T_DOC_IN_STR
                 where F_DOC_IN = :DOC_ID and
                       F_GOOD = :F_GOOD and
                       F_PRICE_VAL <> :F_PRICE_VAL)) then
        F_ICON = 1;
      else
        F_ICON = 0;
    end
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_S_BY_CNT (
    DOC_ID BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
DECLARE VARIABLE DOC_CNT INTEGER;
BEGIN
  FOR SELECT F_ID,
             F_DOC_IN,
             F_GOOD,
             F_PRICE_val,
             F_CNT,
             F_SUM
      FROM T_DOC_IN_STR
      where
        f_doc_in=:doc_id
      INTO :F_ID,
           :F_DOC_IN,
           :F_GOOD,
           :F_PRICE_val,
           :F_CNT,
           :F_SUM
  DO
  BEGIN
    doc_cnt=0;
    if (coalesce(f_good,-1)>0) then
      select f_name,f_article,f_ed_izm_name,f_ed_izm_short_name,f_scancode,f_dop_info from sp_t_nsi_goods_get(:f_good,null)
        into :f_good_name,:f_article,:f_ed_izm_name,:f_ed_izm_short_name,:f_scancode,:f_good_dop_info;
    doc_cnt=coalesce(cnt,F_CNT);
    while (doc_cnt>0) do
    begin
      SUSPEND;
      doc_cnt=doc_cnt-1;
    end
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_STR_U (
    F_ID BIGINT,
    F_DOC_IN BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_SUM NUMERIC(15,3))
AS
BEGIN
  UPDATE T_DOC_IN_STR
  SET F_DOC_IN = :F_DOC_IN,
      F_GOOD = :F_GOOD,
      F_PRICE_val = :F_PRICE_val,
      F_CNT = :F_CNT
--      F_SUM = :F_SUM
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_IN_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_USER VARCHAR(60) = null)
AS
BEGIN
  UPDATE T_DOC_IN
  SET F_SKLAD = coalesce(:F_SKLAD,f_sklad),
      F_PARTNER = coalesce(:F_PARTNER,f_partner),
      F_NUMBER = coalesce(:F_NUMBER,f_number),
      F_DATE = coalesce(:F_DATE,f_date),
      F_STATE = coalesce(:F_STATE,f_state),
      f_price = coalesce(:f_price,f_price),
      f_user = coalesce(:f_user, f_user)
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_INVENTORY_STR_S_BY_CNT (
    INVENTORY_DOC BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_CNT FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
declare variable DOC_CNT integer;
BEGIN
  FOR SELECT F_ID,
             F_GOOD,
             F_count
      FROM T_inventory_DOC_STR
      where
        f_inventory_doc=:inventory_doc
      INTO :F_ID,
           :F_GOOD,
           :F_CNT
  DO
  BEGIN
    doc_cnt=0;
    if (coalesce(f_good,-1)>0) then
      select f_name,f_article,f_ed_izm_name,f_ed_izm_short_name,f_scancode,f_dop_info from sp_t_nsi_goods_get(:f_good,null)
        into :f_good_name,:f_article,:f_ed_izm_name,:f_ed_izm_short_name,:f_scancode,:f_good_dop_info;
    doc_cnt=coalesce(cnt,F_CNT);
    while (doc_cnt>0) do
    begin
      SUSPEND;
      doc_cnt=doc_cnt-1;
    end
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_D (
    F_ID BIGINT)
AS
declare variable V_SYS_ST bigint;
declare variable V_CHECK_ZAPAS bigint;
BEGIN
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :v_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :v_check_zapas;
  if (not exists(select f_id from t_doc_move where f_id=:f_id and f_state>=:v_sys_st and :v_check_zapas=1)) then
    update t_doc_move set f_state=-1 WHERE (F_ID = :F_ID);
  else
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_GET (
    DOC_ID BIGINT,
    DOC_TYPE BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60),
    F_SKLAD_FROM_NAME VARCHAR(60),
    F_SKLAD_FROM_INN VARCHAR(20),
    F_SKLAD_FROM_F_NAME VARCHAR(100),
    F_SKLAD_FROM_KPP VARCHAR(20),
    F_SKLAD_TO_NAME VARCHAR(60),
    F_SKLAD_TO_INN VARCHAR(20),
    F_SKLAD_TO_F_NAME VARCHAR(100),
    F_SKLAD_TO_KPP VARCHAR(20),
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_DOC_SUM NUMERIC(15,3),
    F_TYPE BIGINT,
    F_DOP_INFO VARCHAR(10000),
    F_USER VARCHAR(60),
    F_TYPE_NAME VARCHAR(255))
AS
begin
  if (DOC_ID = -10) then
  begin
    F_ID = gen_id(GEN_T_DOC_MOVE_ID, 1);
    if (DOC_TYPE < 3) then
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('default_sklad')
      into :F_SKLAD_FROM;
    else
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('default_sklad')
      into :F_SKLAD_TO;
    F_DATE = 'now';
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('move_doc_state')
    into :F_STATE;
    if (not exists(select F_ID
                   from T_NSI_DOC_MOVE_TYPES
                   where F_ID = :DOC_TYPE)) then
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('MOVE_DOC_TYPE')
      into :F_TYPE;
    else
      F_TYPE = :DOC_TYPE;
    if (DOC_TYPE = 1) then
      select F_NAME, coalesce(F_PRICE_OUT, :F_PRICE)
      from SP_T_NSI_SKLAD_GET(:F_SKLAD_FROM)
      into :F_SKLAD_FROM_NAME, :F_PRICE;
    if (DOC_TYPE = 2) then
      select F_NAME, coalesce(F_PRICE_IN, :F_PRICE)
      from SP_T_NSI_SKLAD_GET(:F_SKLAD_FROM)
      into :F_SKLAD_FROM_NAME, :F_PRICE;
    if (DOC_TYPE = 3) then
      select F_NAME, coalesce(F_PRICE_IN, :F_PRICE)
      from SP_T_NSI_SKLAD_GET(:F_SKLAD_TO)
      into :F_SKLAD_to_NAME, :F_PRICE;
    select F_NAME
    from SP_T_NSI_PRICE_GET(:F_PRICE)
    into :F_PRICE_NAME;
    if (F_NUMBER is null) then
      select F_RESULT
      from SP_GET_DOC_NUM(:F_SKLAD_FROM)
      into :F_NUMBER;
    F_USER = current_user;
    execute procedure SP_T_DOC_MOVE_I(:F_ID, :F_DATE, :F_NUMBER, :F_SKLAD_FROM, :f_sklad_to, :F_STATE, null, :F_PRICE, :F_TYPE,
        null);
  end
  else
  begin
    select F_ID, F_SKLAD_FROM, F_SKLAD_TO, F_NUMBER, F_DATE, F_STATE, F_PRICE, F_DOC_SUM, F_DOP_INFO, F_TYPE, F_USER
    from T_DOC_MOVE
    where F_ID = :DOC_ID
    into :F_ID, :F_SKLAD_FROM, :F_SKLAD_TO, :F_NUMBER, :F_DATE, :F_STATE, :F_PRICE, :F_DOC_SUM, :F_DOP_INFO, :F_TYPE,
         :F_USER;
    /*    if (not exists(select 1 from sp_check_sys_privs('T_DOC_MOVE') where f_RESULT='SEL' and (f_type='ANY' or f_type=:f_type ) and (f_state='ANY' or f_state=:f_state))) then
      EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);*/
    if (coalesce(F_SKLAD_FROM, -1) > 0) then
      select F_NAME, F_PARTNER_KPP, F_PARTNER_INN, F_PARTNER_NAME
      from SP_T_NSI_SKLAD_GET(:F_SKLAD_FROM)
      into :F_SKLAD_FROM_NAME, :F_SKLAD_FROM_KPP, :F_SKLAD_FROM_INN, :F_SKLAD_FROM_F_NAME;
    else
    begin
      F_SKLAD_FROM_NAME = null;
      F_SKLAD_FROM_KPP = null;
      F_SKLAD_FROM_INN = null;
      F_SKLAD_FROM_F_NAME = null;
    end
    if (coalesce(F_SKLAD_TO, -1) > 0) then
      select F_NAME, F_PARTNER_KPP, F_PARTNER_INN, F_PARTNER_NAME
      from SP_T_NSI_SKLAD_GET(:F_SKLAD_TO)
      into :F_SKLAD_TO_NAME, :F_SKLAD_TO_KPP, :F_SKLAD_TO_INN, :F_SKLAD_TO_F_NAME;
    else
    begin
      F_SKLAD_TO_NAME = null;
      F_SKLAD_TO_KPP = null;
      F_SKLAD_TO_INN = null;
      F_SKLAD_TO_F_NAME = null;
    end
    if (coalesce(F_PRICE, -1) > 0) then
      select F_NAME
      from SP_T_NSI_PRICE_GET(:F_PRICE)
      into :F_PRICE_NAME;
    else
      F_PRICE_NAME = null;
  end
  select F_NAME
  from SP_T_NSI_STATE_GET(:F_STATE)
  into :F_STATE_NAME;
  select F_NAME
  from SP_T_NSI_DOC_MOVE_TYPES_GET(:F_TYPE)
  into :F_TYPE_NAME;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_I (
    F_ID BIGINT,
    F_DATE DATE,
    F_NUMBER VARCHAR(20),
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_STATE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_PRICE BIGINT,
    F_TYPE BIGINT,
    F_DOC_COUNT NUMERIC(15,3))
AS
BEGIN
  INSERT INTO T_DOC_MOVE (
    F_ID,
    F_DATE,
    F_NUMBER,
    F_SKLAD_FROM,
    F_SKLAD_TO,
    F_STATE,
    F_DOC_SUM,
    F_PRICE,
    F_TYPE,
    F_DOC_COUNT)
  VALUES (
    :F_ID,
    :F_DATE,
    :F_NUMBER,
    :F_SKLAD_FROM,
    :F_SKLAD_TO,
    :F_STATE,
    :F_DOC_SUM,
    :F_PRICE,
    :F_TYPE,
    :F_DOC_COUNT);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_S (
    F_DOC_TYPE BIGINT = null,
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_DATE DATE,
    F_NUMBER VARCHAR(20),
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(100),
    F_DOC_SUM NUMERIC(15,3),
    F_PRICE BIGINT,
    F_TYPE BIGINT,
    F_TYPE_NAME VARCHAR(60),
    F_DOC_COUNT NUMERIC(15,3),
    F_SKLAD_FROM_NAME VARCHAR(60),
    F_SKLAD_TO_NAME VARCHAR(60),
    F_USER VARCHAR(60),
    F_DEFAULT_PROPERTY VARCHAR(60),
    F_DOP_INFO VARCHAR(10000),
    F_PRICE_NAME VARCHAR(60))
AS
declare variable P_PROPERTY bigint;
BEGIN
  select PARAM_VALUE from sp_get_sys_param('DEF_PROP_DOC_MOVE') into :p_property;
  FOR SELECT F_ID,
             F_DATE,
             F_NUMBER,
             F_SKLAD_FROM,
             F_SKLAD_TO,
             d.F_STATE,
             F_DOC_SUM,
             F_PRICE,
             d.F_TYPE,
             F_DOC_COUNT,
             f_dop_info,
             F_USER
      FROM T_DOC_MOVE d,
        SP_CHECK_SYS_PRIVS('T_DOC_MOVE') p
      where d.f_state>0
        and p.f_RESULT='SEL'
        and iif(p.f_type='ANY',d.f_type,p.f_type)=d.f_type
        and iif(p.f_state='ANY',d.f_state,p.f_state)=d.f_state
        and d.f_type=coalesce(:f_doc_type,d.f_type)
        and f_date between coalesce(:str_date,f_date) and coalesce(:end_date,f_date)
      INTO :F_ID,
           :F_DATE,
           :F_NUMBER,
           :F_SKLAD_FROM,
           :F_SKLAD_TO,
           :F_STATE,
           :F_DOC_SUM,
           :F_PRICE,
           :F_TYPE,
           :F_DOC_COUNT,
           :f_dop_info,
           :F_USER
  DO
  BEGIN
    if (coalesce(f_price,0)>0) then
    begin
      select f_name from sp_t_nsi_price_get(:f_price) into :f_price_name;
    end
    if (coalesce(f_sklad_from,-1)>0) then
      select f_name from sp_t_nsi_sklad_get(:f_sklad_from) into :f_sklad_from_name;
    else
      f_sklad_from_name=null;
    if (coalesce(f_sklad_to,-1)>0) then
      select f_name from sp_t_nsi_sklad_get(:f_sklad_to) into :f_sklad_to_name;
    else
      f_sklad_to_name=null;
    if (f_state is null) then
      f_state_name=null;
    else
    begin
      select f_name from SP_T_NSI_STATE_GET(:f_state) into :f_state_name;
    end
    if (f_type is null) then
      f_type_name=null;
    else
      select f_name from SP_T_NSI_DOC_MOVE_TYPES_get(:f_type) into :f_type_name;
    select f_value from SP_T_DOC_PROPERTYES_S(:f_id,3)
      where F_PROPERTY_ID = :p_property
      into :f_default_property;

    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_DOC_MOVE_STR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_I (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_DESCR VARCHAR(255) = null)
AS
declare variable V_PRICE_ID bigint;
begin
  if (exists(select 1
             from T_DOC_MOVE
             where F_ID = :F_DOC_MOVE)) then
  begin
    select F_PRICE
    from SP_T_DOC_MOVE_GET(:F_DOC_MOVE)
    into :V_PRICE_ID;
    if (F_PRICE_VAL is null) then
      select F_VALUE
      from SP_T_PRICE_GET(:V_PRICE_ID, :F_GOOD)
      into :F_PRICE_VAL;
  end
  if (exists(select 1
             from T_DOC_MOVE_STR
             where F_DOC_MOVE = :F_DOC_MOVE and
                   F_GOOD = :F_GOOD)) then
  begin
    update T_DOC_MOVE_STR
    set F_CNT = F_CNT + coalesce(:F_CNT, 1)
    where F_DOC_MOVE = :F_DOC_MOVE and
          F_GOOD = :F_GOOD;
  end
  else
    insert into T_DOC_MOVE_STR (F_ID, F_DOC_MOVE, F_GOOD, F_PRICE, F_CNT, F_PRICE_VAL, F_DESCR)
    values (:F_ID, :F_DOC_MOVE, :F_GOOD, :F_PRICE, coalesce(:F_CNT, 1), :F_PRICE_VAL, :F_DESCR);
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_S (
    F_DOC_MOVE_IN BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_DOP_INFO VARCHAR(10000),
    F_SCANCODE VARCHAR(20),
    F_ED_IZM_SHORT_NAME VARCHAR(60),
    F_ED_IZM_NAME VARCHAR(60),
    F_ARTICLE VARCHAR(20),
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_SUM NUMERIC(18,6),
    F_GOOD_PARTNER BIGINT,
    F_SKLAD_OST FLOAT,
    F_SKLAD_TO_OST FLOAT,
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_DESCR VARCHAR(255))
AS
declare variable F_DOC_STATE bigint;
declare variable V_SKLAD_FROM bigint;
declare variable V_DATE date;
declare variable V_SKLAD_TO bigint;
begin
  select F_SKLAD_FROM, F_SKLAD_TO, F_DATE, F_STATE
  from T_DOC_MOVE
  where F_ID = :F_DOC_MOVE_IN
  into :V_SKLAD_FROM, :V_SKLAD_TO, :V_DATE, :F_DOC_STATE;
  for select F_ID, F_DOC_MOVE, F_GOOD, F_PRICE, F_CNT, F_PRICE_VAL, F_SUM, F_DESCR
      from T_DOC_MOVE_STR
      where F_DOC_MOVE = :F_DOC_MOVE_IN
      into :F_ID, :F_DOC_MOVE, :F_GOOD, :F_PRICE, :F_CNT, :F_PRICE_VAL, :F_SUM, :F_DESCR
  do
  begin

    if (exists(select 1
               from T_NSI_GOODS
               where F_ID = :F_GOOD)) then
    begin
      select F_NAME, F_ARTICLE, F_ED_IZM_NAME, F_ED_IZM_SHORT_NAME, F_SCANCODE, F_DOP_INFO, F_PARTNER,
             F_GOODS_GRP_COLOR
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_ARTICLE, :F_ED_IZM_NAME, :F_ED_IZM_SHORT_NAME, :F_SCANCODE, :F_GOOD_DOP_INFO,
           :F_GOOD_PARTNER, :F_GOOD_GRP_COLOR;
    end
    else
      F_GOOD_NAME = null;
    select F_END_OST
    from SP_T_REG_GOOD_GET(:F_GOOD, :V_DATE, :V_SKLAD_FROM)
    into :F_SKLAD_OST;
    F_SKLAD_OST=coalesce(F_SKLAD_OST,0);
    if (exists(select PARAM_VALUE
               from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
               where PARAM_VALUE > :F_DOC_STATE)) then
      F_SKLAD_OST = coalesce(F_SKLAD_OST,0) - F_CNT;
    select F_END_OST
    from SP_T_REG_GOOD_GET(:F_GOOD, :V_DATE, :V_SKLAD_TO)
    into :F_SKLAD_TO_OST;
--    F_SKLAD_TO_OST = coalesce(F_SKLAD_TO_OST,0);
    if (exists(select PARAM_VALUE
               from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
               where PARAM_VALUE <= :F_DOC_STATE)) then
      F_SKLAD_TO_OST = coalesce(F_SKLAD_TO_OST,0) - F_CNT;

    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_S_BY_CNT (
    MOVE_DOC BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_DESCR VARCHAR(255))
AS
declare variable DOC_CNT integer;
begin
  for select F_ID, F_DOC_MOVE, F_GOOD, F_PRICE_VAL, F_CNT, F_SUM, F_DESCR
      from T_DOC_MOVE_STR
      where F_DOC_MOVE = :MOVE_DOC
      into :F_ID, :F_DOC_MOVE, :F_GOOD, :F_PRICE_VAL, :F_CNT, :F_SUM, :F_DESCR
  do
  begin
    DOC_CNT = 0;
    if (coalesce(F_GOOD, -1) > 0) then
      select F_NAME, F_ARTICLE, F_ED_IZM_NAME, F_ED_IZM_SHORT_NAME, F_SCANCODE, F_DOP_INFO
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_ARTICLE, :F_ED_IZM_NAME, :F_ED_IZM_SHORT_NAME, :F_SCANCODE, :F_GOOD_DOP_INFO;
    DOC_CNT = coalesce(CNT, F_CNT);
    while (DOC_CNT > 0) do
    begin
      suspend;
      DOC_CNT = DOC_CNT - 1;
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_STR_U (
    F_ID BIGINT,
    F_DOC_MOVE BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_DESCR VARCHAR(255))
AS
begin
  update T_DOC_MOVE_STR
  set F_DOC_MOVE = :F_DOC_MOVE,
      F_GOOD = :F_GOOD,
      F_PRICE = :F_PRICE,
      F_CNT = :F_CNT,
      F_PRICE_VAL = :F_PRICE_VAL,
      F_DESCR = :F_DESCR
  where (F_ID = :F_ID);
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_MOVE_U (
    F_ID BIGINT,
    F_DATE DATE,
    F_NUMBER VARCHAR(20),
    F_SKLAD_FROM BIGINT,
    F_SKLAD_TO BIGINT,
    F_STATE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_PRICE BIGINT,
    F_TYPE BIGINT,
    F_DOC_COUNT NUMERIC(15,3),
    F_DOP_INFO VARCHAR(10000) = null,
    F_USER VARCHAR(60) = null)
AS
BEGIN
  if (f_sklad_to is not null) then
    UPDATE T_DOC_MOVE  l
    SET
      F_SKLAD_TO = :F_SKLAD_TO
    WHERE (F_ID = :F_ID and coalesce(F_SKLAD_TO,-1)<>:f_sklad_to);
  if (f_sklad_from is not null) then
    UPDATE T_DOC_MOVE
    SET
      F_SKLAD_from = :F_SKLAD_from
    WHERE (F_ID = :F_ID and coalesce(F_SKLAD_from,-1) <>:f_sklad_from);
  update
    T_DOC_MOVE
  set f_price=:f_price
  where coalesce(f_price,0)<>coalesce(:f_price,f_price)
    and f_id=:f_id;
  UPDATE T_DOC_MOVE
  SET F_DATE = :F_DATE
  WHERE (F_ID = :F_ID) and f_date<>coalesce(:f_date,f_date);

  UPDATE T_DOC_MOVE
  SET
      F_NUMBER = :F_NUMBER
  WHERE (F_ID = :F_ID) and f_number<>coalesce(:f_number,f_number);

  update t_doc_move
  set f_dop_info=:f_dop_info
  where f_id=:f_id
  and coalesce(f_dop_info,'')<>coalesce(:f_dop_info,'');

  if (f_user is not null) then
    update
      T_DOC_MOVE
    set F_USER=:F_USER
    where f_id=:f_id;
    
  update
    T_DOC_MOVE
  set F_STATE=:F_STATE
  where F_STATE<>coalesce(:F_STATE,F_STATE)
    and f_id=:f_id;


END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_D (
    F_ID BIGINT)
AS
declare variable V_SYS_ST bigint;
declare variable V_CHECK_ZAPAS bigint;
declare variable V_REMOVE_MONEY bigint;
declare variable V_MONEY_ID bigint;
begin
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
  into :V_SYS_ST;
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CHECK_ZAPAS')
  into :V_CHECK_ZAPAS;
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('REMOVE_MONEY_WITH_DOC')
  into :V_REMOVE_MONEY;
  if (not exists(select F_ID
                 from T_DOC_OUT
                 where F_ID = :F_ID and
                       F_STATE >= :V_SYS_ST and
                       :V_CHECK_ZAPAS = 1)) then
    if (not exists(select F_ID
                   from SP_T_MONEY_IN_STR_S_DOC(:F_ID)) or (V_REMOVE_MONEY = 1)) then
    begin
      for select F_ID
          from SP_T_MONEY_IN_STR_S_DOC(:F_ID)
          into :V_MONEY_ID
      do
      begin
        execute procedure sp_t_money_in_str_d(:V_MONEY_ID);
      end
      update T_DOC_OUT
      set F_STATE = -1
      where (F_ID = :F_ID);
    end
    else
      execute procedure PR_EXEC_EXCEPTION(4);

  else
    execute procedure PR_EXEC_EXCEPTION(1);
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_GET (
    DOC_ID BIGINT,
    DOC_TYPE BIGINT = 1,
    DOC_SKLAD BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_PAYDATE_PLAN DATE,
    F_DOC_SUM NUMERIC(15,3),
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_PARTNER_NAME VARCHAR(60),
    F_PARTNER_ADRES VARCHAR(255),
    F_PARTNER_INN VARCHAR(20),
    F_PARTNER_KPP VARCHAR(20),
    F_PARTNER_BANK VARCHAR(60),
    F_PARTNER_BANK_ADRES VARCHAR(255),
    F_PARTNER_BANK_RSCH VARCHAR(20),
    F_PARTNER_BANK_KSCH VARCHAR(20),
    F_PARTNER_BANK_BIK VARCHAR(20),
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD_ADRES VARCHAR(255),
    F_SKLAD_F_NAME VARCHAR(60),
    F_SKLAD_U_ADRES VARCHAR(255),
    F_SKLAD_INN VARCHAR(20),
    F_SKLAD_KPP VARCHAR(20),
    F_SKLAD_BANK VARCHAR(255),
    F_SKLAD_BANK_ADRES VARCHAR(255),
    F_SKLAD_BANK_RSCH VARCHAR(20),
    F_SKLAD_BANK_KSCH VARCHAR(20),
    F_SKLAD_BANK_BIK VARCHAR(20),
    F_SKIDKA INTEGER,
    F_PAY_SUM NUMERIC(15,3),
    F_TYPE BIGINT,
    F_TYPE_NAME VARCHAR(60),
    F_DISCOUNT_CARD VARCHAR(60),
    F_USER VARCHAR(60),
    F_PROPERTY_1 VARCHAR(255))
AS
declare variable V_PAYCHECK_DAY bigint;
begin
  if (DOC_ID = -10) then
  begin

    F_ID = gen_id(GEN_T_DOC_OUT_ID, 1);
    if (not exists(select F_ID
                   from T_NSI_SKLAD
                   where F_ID = :DOC_SKLAD)) then
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('default_sklad')
      into :F_SKLAD;
    else
      F_SKLAD = :DOC_SKLAD;
    F_DATE = 'now';
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('out_doc_state')
    into :F_STATE;
    if (doc_type < 3 ) then
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('default_out_price')
      into :F_PRICE;
    else
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('default_in_price')
      into :F_PRICE;


    select F_NAME, coalesce(iif(:doc_type < 3,F_PRICE_OUT,f_price_in), :F_PRICE)
    from SP_T_NSI_SKLAD_GET(:F_SKLAD)
    into :F_SKLAD_NAME, :F_PRICE;
    select F_NAME
    from SP_T_NSI_PRICE_GET(:F_PRICE)
    into :F_PRICE_NAME;
    if (F_NUMBER is null) then
      select F_RESULT
      from SP_GET_DOC_NUM(:F_SKLAD)
      into :F_NUMBER;
    if (DOC_TYPE = 2) then
      select F_PARTNER_ROZN
      from T_NSI_SKLAD
      where F_ID = :F_SKLAD
      into :F_PARTNER;
/*    select PARAM_VALUE
    from SP_GET_SYS_PARAM('PAY_CHECK_DAY')
    into :V_PAYCHECK_DAY;
    F_PAYDATE_PLAN = F_DATE + coalesce(V_PAYCHECK_DAY, 0);*/
    F_USER = current_user;
    F_TYPE = :DOC_TYPE;
    execute procedure SP_T_DOC_OUT_I(:F_ID, :F_SKLAD, :F_PARTNER, :F_NUMBER, :F_DATE, :F_STATE, :F_PRICE,
        :F_PAYDATE_PLAN, :DOC_TYPE);
  end
  else
  begin
    select F_ID, F_SKLAD, F_PARTNER, F_NUMBER, F_DATE, F_STATE, F_PRICE, F_DOC_SUM, F_SKIDKA,
           --        0,
           F_PAY_SUM, F_PAYDATE_PLAN, F_TYPE, F_DISCOUNT_CARD, F_USER
    from T_DOC_OUT
    where F_ID = :DOC_ID
    into :F_ID, :F_SKLAD, :F_PARTNER, :F_NUMBER, :F_DATE, :F_STATE, :F_PRICE, :F_DOC_SUM, :F_SKIDKA, :F_PAY_SUM,
         :F_PAYDATE_PLAN, :F_TYPE, :F_DISCOUNT_CARD, :F_USER;
  end
/*  if (not exists(select 1
                 from SP_CHECK_SYS_PRIVS('T_DOC_OUT')
                 where F_RESULT = 'SEL' and
                       (F_TYPE = 'ANY' or F_TYPE = :F_TYPE) and
                       (F_STATE = 'ANY' or F_STATE = :F_STATE))) then
    execute procedure PR_EXEC_EXCEPTION(3);*/
  if (coalesce(F_PARTNER, -1) > 0) then
    select F_NAME, F_INN, F_KPP, F_U_ADDRES, F_BANK, F_BANK_ADRES, F_BANK_RSCH, F_BANK_KSCH, F_BANK_BIK
    from SP_T_NSI_PARTNER_GET(:F_PARTNER)
    into :F_PARTNER_NAME, :F_PARTNER_INN, :F_PARTNER_KPP, :F_PARTNER_ADRES, :F_PARTNER_BANK, :F_PARTNER_BANK_ADRES,
         :F_PARTNER_BANK_RSCH, :F_PARTNER_BANK_KSCH, :F_PARTNER_BANK_BIK;
  if (coalesce(F_SKLAD, -1) > 0) then
    select F_NAME, F_ADDRES, F_PARTNER_NAME, F_PARTNER_ADRES, F_PARTNER_INN, F_PARTNER_KPP, F_PARTNER_BANK,
           F_PARTNER_BANK_ADRES, F_PARTNER_BANK_KSCH, F_PARTNER_BANK_RSCH, F_PARTNER_BANK_BIK
    from SP_T_NSI_SKLAD_GET(:F_SKLAD)
    into :F_SKLAD_NAME, :F_SKLAD_ADRES, :F_SKLAD_F_NAME, :F_SKLAD_U_ADRES, :F_SKLAD_INN, :F_SKLAD_KPP, :F_SKLAD_BANK,
         :F_SKLAD_BANK_ADRES, :F_SKLAD_BANK_KSCH, :F_SKLAD_BANK_RSCH, :F_SKLAD_BANK_BIK;
  if (coalesce(F_PRICE, -1) > 0) then
    select F_NAME
    from SP_T_NSI_PRICE_GET(:F_PRICE)
    into :F_PRICE_NAME;
  select F_NAME
  from SP_T_NSI_STATE_GET(:F_STATE)
  into :F_STATE_NAME;
  select F_NAME
  from SP_T_NSI_DOC_OUT_TYPES_GET(:F_TYPE)
  into :F_TYPE_NAME;
  select F_VALUE
  from SP_T_DOC_PROPERTYES_S(:DOC_ID, 2)
  where F_PROPERTY_ID = 1
  into :F_PROPERTY_1;
  F_PROPERTY_1 = coalesce(F_PROPERTY_1, 0);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PAYDATE_PLAN DATE,
    F_DOC_TYPE BIGINT = 1)
AS
BEGIN
  INSERT INTO T_DOC_OUT (
    F_ID,
    F_SKlAD,
    F_PARTNER,
    F_NUMBER,
    F_DATE,
    F_STATE,
    f_price,
    f_paydate_plan,
    f_type)
  VALUES (
    :F_ID,
    :F_SKlAD,
    :F_PARTNER,
    :F_NUMBER,
    :F_DATE,
    :F_STATE,
    :F_PRICE,
    :f_paydate_plan,
    :f_doc_type);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_MAKE_PAY (
    F_DOC_ID BIGINT,
    F_MONEY_TYPE BIGINT = 1,
    F_SUM INTEGER = -1)
RETURNS (
    F_MONEY_IN_ID BIGINT)
AS
DECLARE VARIABLE V_SKLAD BIGINT;
DECLARE VARIABLE V_PARTNER BIGINT;
DECLARE VARIABLE V_DATE DATE;
DECLARE VARIABLE V_NUMBER VARCHAR(20) CHARACTER SET WIN1251;
DECLARE VARIABLE V_SUMMA NUMERIC(15,3);
DECLARE VARIABLE V_STATE BIGINT;
begin
  v_date='now';
  select f_partner,f_sklad,f_number,
    case 
      when :f_sum>0 then :f_sum
      else f_doc_sum
    end
  from sp_t_doc_out_get(:f_doc_id) into :v_partner,:v_sklad,:v_number,:v_summa;
  f_money_in_id=GEN_ID(GEN_t_money_in_ID,1);
  select param_value from SP_GET_SYS_PARAM('in_pay_state') into :v_state;
  execute procedure SP_T_MONEY_IN_I(:f_money_in_id,:v_sklad,v_partner,null,:v_number,'now',:v_state,:v_summa,:f_money_type);
  execute procedure sp_t_money_in_str_i(null,:f_doc_id,:f_money_in_id,:v_summa);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_S (
    DOC_TYPE INTEGER = -1,
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PAYDATE_PLAN DATE,
    F_STATE BIGINT,
    F_DOC_COUNT FLOAT,
    F_DOC_SUM NUMERIC(15,3),
    F_STATE_NAME VARCHAR(60),
    F_SKLAD_NAME VARCHAR(60),
    F_PARTNER_NAME VARCHAR(60),
    F_DOC_SKIDKA NUMERIC(15,3),
    F_DOC_SKIDKA_PERCENT NUMERIC(15,3),
    F_PRICE_NAME VARCHAR(60),
    F_PRICE BIGINT,
    F_PAY_SUM NUMERIC(15,3),
    F_PAY_TYPE BIGINT,
    F_USER VARCHAR(60),
    F_PROPERTY_1 VARCHAR(255))
AS
BEGIN
  FOR SELECT F_ID,
             F_SKlAD,
             F_PARTNER,
             F_NUMBER,
             F_DATE,
             f_paydate_plan,
             d.F_STATE,
             f_doc_count,
             f_doc_sum,
             f_skidka,
             f_price,
             f_pay_sum,
             f_money_type,
             f_user
      FROM T_DOC_OUT d,
        SP_CHECK_SYS_PRIVS('T_DOC_OUT') p
      where
        p.f_result = 'SEL'
        and iif(p.f_type='ANY',d.f_type,p.f_type)=d.f_type
        and iif(p.f_state='ANY',d.f_state,p.f_state)=d.f_state
        and (d.f_type=:doc_type or
        coalesce(:doc_type,-1)<0)
        and d.f_state>0
        and f_date between :str_date and :end_date
      INTO :F_ID,
           :F_SKlAD,
           :F_PARTNER,
           :F_NUMBER,
           :F_DATE,
           :f_paydate_plan,
           :F_STATE,
           :f_doc_count,
           :f_doc_sum,
           :f_doc_skidka_percent,
           :f_price,
           :f_pay_sum,
           :f_pay_type,
           :f_user
  DO
  BEGIN
    if (f_sklad is not null) then
      select F_name from sp_t_nsi_sklad_get(:f_sklad) into :f_sklad_name;
    else
      f_sklad_name=null;
    if (f_state is not null) then
      select F_name from sp_t_nsi_state_get(:f_state) into :f_state_name;
    else
      f_state_name=null;
    if (f_partner is not null) then
      select F_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
    else
      f_partner_name=null;
    if (f_price is not null) then
      select f_name from sp_t_nsi_price_get(:f_price) into :f_price_name;
    else
      f_price_name=null;
/*    if (f_doc_skidka_percent>0) then
    begin*/
      select sum((coalesce(f_price_val_nsi,f_price_val)-f_price_val)*f_cnt) from t_doc_out_str where f_doc_out=:f_id into :f_doc_skidka;
--      f_doc_skidka=f_doc_sum/(100-f_doc_skidka_percent)*f_doc_skidka_percent;
/*    end
    else
      f_doc_skidka=0;*/
      f_property_1 = null;
      select f_value from sp_t_doc_propertyes_s(:f_id, 2) where f_property_id=1 into :f_property_1;
      f_property_1=coalesce(f_property_1,0);
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_SET_DEF_PROP (
    P_DOC_IN BIGINT)
AS
declare variable V_PARTNER bigint;
declare variable V_PROPERTY varchar(255);
declare variable V_VALUE varchar(255);
declare variable V_PROPERTY_ID bigint;
begin
  select F_PARTNER
  from SP_T_DOC_OUT_GET(:P_DOC_IN)
  into :V_PARTNER;
  for select F_INFO, F_VALUE
      from SP_T_NSI_PARTNER_INFO_S(:V_PARTNER)
      into :V_PROPERTY, :V_VALUE
  do
  begin
    V_PROPERTY_ID=null;
    select F_ID
    from T_NSI_DOC_PROPERTY
    where F_NAME = :V_PROPERTY
    into :V_PROPERTY_ID;
    if (V_PROPERTY_ID is not null) then
      execute procedure SP_T_DOC_PROPERTYES_SET(:P_DOC_IN, 2, :V_PROPERTY_ID, :V_VALUE);
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_DOC_OUT_STR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_GET (
    P_DOC_ID BIGINT,
    P_GOOD_ID BIGINT,
    P_DOC_STR_ID BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT FLOAT,
    F_SUM NUMERIC(15,3),
    F_GOOD_NAME VARCHAR(255),
    F_PRICE_VAL NUMERIC(15,3),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SKLAD_OST FLOAT,
    F_SKIDKA NUMERIC(15,3),
    F_GOOD_PARNER BIGINT,
    F_DESCR VARCHAR(255))
AS
declare variable F_SKLAD bigint;
declare variable F_DATE date;
declare variable F_DOC_STATE bigint;
declare variable F_SKIDKA_PERCENT integer;
BEGIN
  select f_sklad, f_date, f_state, f_skidka
  from sp_t_doc_out_get(:p_doc_id)
  into
    :f_sklad,
    :f_date,
    :f_doc_state,
    :f_skidka_percent;
  FOR SELECT first 1 F_ID,
             F_DOC_out,
             F_GOOD,
             F_PRICE,
             F_CNT,
             F_SUM,
             F_PRICE_VAL,
             F_CNT*(coalesce(F_PRICE_VAL_NSI,F_PRICE_VAL)-F_PRICE_VAL),
             f_descr
--             f_sum/(100-coalesce(:f_skidka_percent,0))*coalesce(:f_skidka_percent,0)
      FROM T_DOC_out_STR
      where
        f_doc_out=:p_doc_id
        and ( f_good = :p_good_id )
      INTO :F_ID,
           :F_DOC_out,
           :F_GOOD,
           :F_PRICE,
           :F_CNT,
           :F_SUM,
           :F_PRICE_VAL,
           :f_skidka,
           :f_descr
  DO
  BEGIN
    if (coalesce(f_good,-1)>0) then
    begin
      select f_name,f_article,f_ed_izm_name,f_ed_izm_short_name,f_partner from sp_t_nsi_goods_get(:f_good,null)
        into :f_good_name,:f_article,:f_ed_izm_name,:f_ed_izm_short_name,:f_good_parner;
      select f_end_ost from sp_t_reg_good_get(:f_good,:f_date,:f_sklad) into :f_sklad_ost;
      if (not exists(select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') where param_value<=:f_doc_state)) then
        f_sklad_ost=f_sklad_ost-f_cnt;
    end
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_GET_PARTY (
    P_DOC_OUT BIGINT)
RETURNS (
    F_GOOD BIGINT,
    F_ARTICLE VARCHAR(60),
    F_GOOD_NAME VARCHAR(255),
    F_CNT BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_PARTY_ID BIGINT,
    F_PARTY_DATE DATE,
    F_PARTY_PRICE BIGINT,
    F_NUMBERS VARCHAR(255))
AS
DECLARE VARIABLE V_CNT BIGINT;
DECLARE VARIABLE V_STR_ID BIGINT;
DECLARE VARIABLE V_IN_PRICE BIGINT;
begin
  select PARAM_VALUE from SP_GET_SYS_PARAM('DEFAULT_IN_PRICE') into :v_in_price;
  for
    select
       s.f_id,s.f_good_name,s.f_article,f_price_val,s.f_cnt,s.f_good
    from
        sp_t_doc_out_str_s(:p_doc_out) s
    into :v_str_id,:f_good_name,:f_article,:f_price_val,:v_cnt,:f_good
  do
  begin
    for select f_party,f_cnt
      from T_DOC_OUT_STR_PARTY
      where f_doc_out_str=:v_str_id
      into :f_party_id,:f_cnt
    do begin
      v_cnt = v_cnt - f_cnt;
      select f_numbers from SP_GET_DOC_NUM_BY_PARTY(:f_party_id) into :f_numbers;
      select f_price,f_date from t_nsi_good_party where f_id=:f_party_id into :f_party_price,:f_party_date;
      suspend;
    end
    if (v_cnt > 0) then
    begin
      f_cnt=v_cnt;
      f_party_id=null;
      f_numbers=null;
      f_party_date=null;
      select f_value from SP_T_PRICE_GET(:v_in_price,:f_good) into :f_party_price;
      suspend;
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_I (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_SKD NUMERIC(15,3) = 0,
    F_DESCR VARCHAR(255) = null,
    F_BARTER SMALLINT = 0)
AS
declare variable V_PRICE numeric(15,3);
declare variable V_PRICE_VAL numeric(15,3);
declare variable F_SKIDKA integer;
declare variable V_ROUND numeric(15,3);
declare variable V_PRICE_VAL_SK numeric(15,3);
declare variable V_SKIDKA_ID bigint;
declare variable V_SKIDKA_ROUND numeric(15,3);
declare variable V_CNT float;
declare variable V_BARTER smallint = 0;
BEGIN
  select param_value from sp_get_sys_param('OUT_DOC_SKIDKA') into :V_SKIDKA_id;
  select f_round from t_nsi_skidka where f_id=:v_skidka_id into :v_skidka_round;
  select coalesce(f_barter,0) from sp_t_nsi_goods_get(:f_good,null) into :v_barter;

  select coalesce(f_skidka,0),coalesce(f_price,0) from sp_t_doc_out_get(:f_doc_out) into :f_skidka,:v_price;
  if (v_price>0) then
  begin
    select f_value from SP_T_PRICE_GET(:v_price,:f_good) into :v_price_val;
    select f_round from sp_t_nsi_price_get(:v_price) into :v_round;
  end
  else
  begin
    v_price_val=f_price;
  end
  v_cnt=coalesce(f_cnt,1);
  if (v_barter=0) then
    v_cnt =abs(v_cnt);
  if ((f_barter = 1) and (v_barter=1)) then
    v_cnt=v_cnt*(-1);
  if (coalesce(f_skd,0)=0) then
    v_price_val_sk=v_price_val*(100-f_skidka)/100.00;
  else
  begin
    v_price_val=f_price+coalesce(:f_skd/:f_cnt,0);
    v_price_val_sk=f_price;
  end
  if (v_price_val_sk<>v_price_val) then
    select f_result from sp_round(:v_price_val_sk,:v_skidka_round) into :v_price_val_sk;
  if (exists(select 1 from T_DOC_OUT_STR where
      f_doc_out=:F_DOC_OUT and F_GOOD=:F_GOOD)) then
  begin
    update T_DOC_OUT_STR
    set F_CNT=--:v_cnt,
      F_CNT+coalesce(:F_CNT,1),
      f_descr=iif(:f_descr is null, f_descr,coalesce(f_descr, '')||:f_descr||';')
    where f_doc_out=:F_DOC_OUT and F_GOOD=:F_GOOD;
  end
  else
  begin
    INSERT INTO T_DOC_OUT_STR (
      F_ID,
      F_DOC_OUT,
      F_GOOD,
--      F_PRICE,
      F_CNT,
      f_price_val,
      f_price_val_nsi,
      f_descr)
    VALUES (
      :F_ID,
      :F_DOC_OUT,
      :F_GOOD,
--      :v_price,
      coalesce(:v_cnt,1),
      :v_price_val_sk,
      :v_price_val,
      :f_descr
      );
   end
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_S (
    DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_CNT FLOAT,
    F_SUM NUMERIC(15,3),
    F_GOOD_NAME VARCHAR(255),
    F_PRICE_VAL NUMERIC(15,3),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SKLAD_OST FLOAT,
    F_SKIDKA NUMERIC(15,3),
    F_GOOD_PARNER BIGINT,
    F_DESCR VARCHAR(255),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
declare variable F_SKLAD bigint;
declare variable F_DATE date;
declare variable F_DOC_STATE bigint;
declare variable F_SKIDKA_PERCENT integer;
declare variable F_OST_STATE integer;
begin
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
  into :F_OST_STATE;
  /*  select F_SKLAD, F_DATE, F_STATE, F_SKIDKA
  from T_DOC_OUT
  where F_ID = :DOC_ID
  into :F_SKLAD, :F_DATE, :F_DOC_STATE, :F_SKIDKA_PERCENT;
  for select F_ID, F_DOC_OUT, F_GOOD, F_PRICE, F_CNT, F_SUM, F_PRICE_VAL,
             F_CNT * (coalesce(F_PRICE_VAL_NSI, F_PRICE_VAL) - F_PRICE_VAL), F_DESCR
             --             f_sum/(100-coalesce(:f_skidka_percent,0))*coalesce(:f_skidka_percent,0)
      from T_DOC_OUT_STR
      where F_DOC_OUT = :DOC_ID
      into :F_ID, :F_DOC_OUT, :F_GOOD, :F_PRICE, :F_CNT, :F_SUM, :F_PRICE_VAL, :F_SKIDKA, :F_DESCR
  do
  begin
    if (coalesce(F_GOOD, -1) > 0) then
    begin
      select F_NAME, F_ARTICLE, F_ED_IZM_NAME, F_ED_IZM_SHORT_NAME, F_PARTNER, F_GOODS_GRP_COLOR
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_ARTICLE, :F_ED_IZM_NAME, :F_ED_IZM_SHORT_NAME, :F_GOOD_PARNER, :F_GOOD_GRP_COLOR;
      select F_END_OST
      from SP_T_REG_GOOD_GET(:F_GOOD, :F_DATE, :F_SKLAD)
      into :F_SKLAD_OST;
      if (not exists(select PARAM_VALUE
                     from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
                     where PARAM_VALUE <= :F_DOC_STATE)) then
        F_SKLAD_OST = F_SKLAD_OST - F_CNT;
    end
    suspend;
  end*/

  for select S.F_ID, S.F_DOC_OUT, S.F_GOOD, S.F_PRICE, S.F_CNT, S.F_SUM, S.F_PRICE_VAL,
             S.F_CNT * (coalesce(S.F_PRICE_VAL_NSI, S.F_PRICE_VAL) - S.F_PRICE_VAL), S.F_DESCR, D.F_SKLAD, D.F_DATE,
             D.F_STATE, D.F_SKIDKA /*,G.F_NAME, G.F_ARTICLE, G.F_PARTNER, I.F_NAME, I.F_SHORT_NAME,
             GR.F_COLOR*/
             /*      case
      when d.f_state >= :f_ost_state then
      (select F_END_OST
      from T_REG_GOOD as R
      where R.F_GOOD = s.F_GOOD and
        R.F_DATE = (select max(f_date) from t_reg_good where f_good=r.f_good
         and f_sklad=r.f_sklad and f_date <= d.f_date)
        and R.F_SKLAD = d.F_SKLAD)
      else
      (select F_END_OST
      from T_REG_GOOD as R
      where R.F_GOOD = s.F_GOOD and
        R.F_DATE = (select max(f_date) from t_reg_good where f_good=r.f_good
         and f_sklad=r.f_sklad and f_date <= d.f_date)
        and R.F_SKLAD = d.F_SKLAD) - s.f_cnt
      end*/
      from T_DOC_OUT D
      inner join T_DOC_OUT_STR S on D.F_ID = S.F_DOC_OUT
      /*      inner join T_NSI_GOODS G on S.F_GOOD = G.F_ID
      left join T_NSI_ED_IZM I on G.F_ED_IZM = I.F_ID
      left join T_NSI_GOODS_GRP GR on G.F_GOODS_GRP = GR.F_ID*/
      where D.F_ID = :DOC_ID
      into :F_ID, :F_DOC_OUT, :F_GOOD, :F_PRICE, :F_CNT, :F_SUM, :F_PRICE_VAL, :F_SKIDKA, :F_DESCR, :F_SKLAD, :F_DATE,
           :F_DOC_STATE, :F_SKIDKA_PERCENT /*, :F_GOOD_NAME, :F_ARTICLE, :F_GOOD_PARNER, :F_ED_IZM_NAME,
           :F_ED_IZM_SHORT_NAME, :F_GOOD_GRP_COLOR*/
           /*, :F_SKLAD_OST*/
  do
  begin

    select F_NAME, F_ARTICLE, F_ED_IZM_NAME, F_ED_IZM_SHORT_NAME, F_GOODS_GRP_COLOR, F_PARTNER, F_DOP_INFO
    from SP_T_NSI_GOODS_GET(:F_GOOD, null)
    into :F_GOOD_NAME, :F_ARTICLE, :F_ED_IZM_NAME, :F_ED_IZM_SHORT_NAME, :F_GOOD_GRP_COLOR, :F_GOOD_PARNER,
         :F_GOOD_DOP_INFO;

    select F_END_OST
    from SP_T_REG_GOOD_GET(:F_GOOD, :F_DATE, :F_SKLAD)
    into :F_SKLAD_OST;
    if (not exists(select PARAM_VALUE
                   from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
                   where PARAM_VALUE <= :F_DOC_STATE)) then
      F_SKLAD_OST = F_SKLAD_OST - F_CNT;
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_S_BY_CNT (
    DOC_OUT BIGINT,
    CNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_DESCR VARCHAR(255))
AS
declare variable DOC_CNT integer;
BEGIN
  FOR SELECT F_ID,
             F_DOC_out,
             F_GOOD,
             F_PRICE_val,
             F_CNT,
             F_SUM,
             f_descr
      FROM T_DOC_out_STR
      where
        f_doc_out=:doc_out
      INTO :F_ID,
           :F_DOC_out,
           :F_GOOD,
           :F_PRICE_val,
           :F_CNT,
           :F_SUM,
           :f_descr
  DO
  BEGIN
    doc_cnt=0;
    if (coalesce(f_good,-1)>0) then
      select f_name,f_article,f_ed_izm_name,f_ed_izm_short_name,f_scancode,f_dop_info from sp_t_nsi_goods_get(:f_good,null)
        into :f_good_name,:f_article,:f_ed_izm_name,:f_ed_izm_short_name,:f_scancode,:f_good_dop_info;
    doc_cnt=coalesce(cnt,F_CNT);
    while (doc_cnt>0) do
    begin
      SUSPEND;
      doc_cnt=doc_cnt-1;
    end
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_STR_U (
    F_ID BIGINT,
    F_DOC_OUT BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT FLOAT,
    F_SUM NUMERIC(15,3),
    F_DESCR VARCHAR(255) = null)
AS
declare variable V_BARTER smallint = 0;
BEGIN
  select coalesce(f_barter,0) from sp_t_nsi_goods_get(:f_good,null) into :v_barter;
  if (v_barter=0) then
    f_cnt=abs(f_cnt);
  if (f_cnt>0) then
    UPDATE T_DOC_OUT_STR
    SET F_DOC_OUT = coalesce(:F_DOC_OUT,f_doc_out),
      F_GOOD = coalesce(:F_GOOD,f_good),
      F_PRICE_VAL = coalesce(:F_PRICE_VAL,f_price_val),
      F_CNT = coalesce(:F_CNT,f_cnt),
      f_descr=:f_descr
--      F_SUM = :F_SUM
    WHERE (F_ID = :F_ID);
  else
    UPDATE T_DOC_OUT_STR
    SET F_DOC_OUT = coalesce(:F_DOC_OUT,f_doc_out),
      F_GOOD = coalesce(:F_GOOD,f_good),
      F_PRICE_VAL = F_PRICE_VAL_nsi,
      F_CNT = coalesce(:F_CNT,f_cnt),
      f_descr=:f_descr
--      F_SUM = :F_SUM
    WHERE (F_ID = :F_ID);

END^


CREATE OR ALTER PROCEDURE SP_T_DOC_OUT_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_PAYDATE_PLAN DATE,
    F_STATE BIGINT,
    F_PRICE INTEGER,
    F_SKIDKA INTEGER,
    F_DISCOUNT_CARD VARCHAR(60) = null,
    F_I_TYPE BIGINT = null,
    F_PROPERTY_1 VARCHAR(255) = null,
    F_USER VARCHAR(60) = null)
AS
declare variable F_OLD_SKLAD bigint;
declare variable F_OLD_PARTNER bigint;
declare variable F_OLD_NUMBER varchar(20);
declare variable F_OLD_DATE date;
declare variable F_OLD_PAYDATE_PLAN date;
declare variable F_OLD_STATE bigint;
declare variable F_OLD_PRICE bigint;
declare variable F_OLD_SKIDKA numeric(15,3);
declare variable F_TYPE bigint;
declare variable F_SYS_STATE bigint;
declare variable F_MONEY_DOC bigint;
declare variable F_OLD_PROPERTY_1 varchar(255);
declare variable V_PARAM_VAL varchar(60);
declare variable V_PAY_DATE bigint;
declare variable V_PAYCHECK_DAY bigint;
begin
  select F_SKLAD, F_PARTNER, F_NUMBER, F_DATE, F_PAYDATE_PLAN, F_STATE, F_PRICE, F_SKIDKA, F_TYPE, F_PROPERTY_1
  from SP_T_DOC_OUT_GET(:F_ID)
  into :F_OLD_SKLAD, :F_OLD_PARTNER, :F_OLD_NUMBER, :F_OLD_DATE, :F_OLD_PAYDATE_PLAN, :F_OLD_STATE, :F_OLD_PRICE,
       :F_OLD_SKIDKA, :F_TYPE, :F_OLD_PROPERTY_1;
  if (F_DISCOUNT_CARD is not null) then
  begin
    update T_DOC_OUT
    set F_DISCOUNT_CARD = :F_DISCOUNT_CARD
    where (F_ID = :F_ID) and
          F_DISCOUNT_CARD <> :F_DISCOUNT_CARD;
  end
  if (F_SKLAD is not null and
      F_SKLAD <> F_OLD_SKLAD) then
    update T_DOC_OUT
    set F_SKLAD = :F_SKLAD
    where F_ID = :F_ID;

  if (F_PARTNER is not null and
      F_PARTNER <> coalesce(F_OLD_PARTNER, 0)) then
  begin
    update T_DOC_OUT
    set F_PARTNER = :F_PARTNER
    where F_ID = :F_ID;
    execute procedure SP_T_DOC_OUT_SET_DEF_PROP(:F_ID);
    select F_PAY_DAY
    from SP_T_NSI_PARTNER_CARD_GET(:F_PARTNER, :F_DATE)
    into :V_PAY_DATE;
    if (coalesce(V_PAY_DATE, 0) > 0) then
    begin
      F_PAYDATE_PLAN = F_DATE + V_PAY_DATE;
    end
    else
    begin
/*      select PARAM_VALUE
      from SP_GET_SYS_PARAM('PAY_CHECK_DAY')
      into :V_PAYCHECK_DAY;
      F_PAYDATE_PLAN = F_DATE + coalesce(V_PAYCHECK_DAY, 0);*/
      F_PAYDATE_PLAN = 'now';
    end
  end

  if (F_NUMBER is not null and
      F_NUMBER <> F_OLD_NUMBER) then
    update T_DOC_OUT
    set F_NUMBER = :F_NUMBER
    where F_ID = :F_ID;
  if (F_DATE is not null and
      F_DATE <> F_OLD_DATE) then
    update T_DOC_OUT
    set F_DATE = :F_DATE
    where F_ID = :F_ID;
  if (F_PAYDATE_PLAN is not null and
      (F_PAYDATE_PLAN <> F_OLD_PAYDATE_PLAN or F_OLD_PAYDATE_PLAN is null)) then
    update T_DOC_OUT
    set F_PAYDATE_PLAN = :F_PAYDATE_PLAN
    where F_ID = :F_ID;
  if (/*F_PRICE is not null and*/
      coalesce(F_PRICE, 0) <> coalesce(F_OLD_PRICE, 0)) then
    update T_DOC_OUT
    set F_PRICE = :F_PRICE
    where F_ID = :F_ID;
  if (F_SKIDKA is not null and
      F_SKIDKA <> coalesce(F_OLD_SKIDKA, 0)) then
    update T_DOC_OUT
    set F_SKIDKA = :F_SKIDKA
    where F_ID = :F_ID;
  if (coalesce(:F_PROPERTY_1, 0) <> coalesce(:F_OLD_PROPERTY_1, 0)) then
    execute procedure SP_T_DOC_PROPERTYES_SET(:F_ID, 2, 1, :F_PROPERTY_1);
  if (F_TYPE = 2) then
  begin
    select PARAM_VALUE
    from SP_GET_SYS_PARAM('MAKE_PAY_FOR_ROZN')
    into :V_PARAM_VAL;
    if (V_PARAM_VAL = 1) then
    begin
      select PARAM_VALUE
      from SP_GET_SYS_PARAM('CHANGE_SKLAD_OST_STATE')
      into :F_SYS_STATE;
      if (F_STATE = F_SYS_STATE and
          F_STATE > F_OLD_STATE) then
      begin
        select F_MONEY_IN_ID
        from SP_T_DOC_OUT_MAKE_PAY(:F_ID)
        into :F_MONEY_DOC;
      end
    end
  end
  if (coalesce(F_USER, '') <> '') then
    update T_DOC_OUT
    set F_USER = :F_USER
    where F_ID = :F_ID;
  if (F_STATE is not null and
      F_STATE <> F_OLD_STATE) then
    update T_DOC_OUT
    set F_STATE = :F_STATE
    where F_ID = :F_ID;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_D (
    F_ID BIGINT)
AS
declare variable V_SYS_ST bigint;
declare variable V_CHECK_ZAPAS bigint;
BEGIN
  select param_value from sp_get_sys_param('CHANGE_SKLAD_OST_STATE') into :v_sys_st;
  select param_value from sp_get_sys_param('CHECK_ZAPAS') into :v_check_zapas;
  if (not exists(select f_id from T_DOC_PRICE where f_id=:f_id and f_state>=:v_sys_st and :v_check_zapas=1)) then
    update T_DOC_PRICE set f_state=-1 WHERE (F_ID = :F_ID);
  else
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(1);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_GET (
    F_PRICE_DOC BIGINT,
    F_PARENT_PRICE_DOC BIGINT = null)
RETURNS (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_USER VARCHAR(60))
AS
BEGIN
  if (f_price_doc =-10) then
  begin
    f_id=GEN_ID(GEN_t_doc_price_ID,1);
    f_date='now';
    select param_value from SP_GET_SYS_PARAM('out_doc_state') into :f_state;
    f_num=f_id;
    f_user=current_user;
    execute procedure sp_t_doc_price_i(:f_id,:f_num,:f_date,:f_parent_price_doc,:f_state,:f_price);
  end
  else
  begin
    SELECT F_ID,
             F_NUM,
             F_DATE,
             F_PARENT,
             F_StATE,
             F_PRICE,
             F_USER
    FROM T_DOC_PRICE
    where
      f_id=:f_price_doc
    INTO :F_ID,
         :F_NUM,
         :F_DATE,
         :F_PARENT,
         :F_StATE,
         :F_PRICE,
         :F_USER;
    select f_name from sp_t_nsi_price_get(coalesce(:f_price,-1)) into :f_price_name;
    select f_name from sp_t_nsi_state_get(coalesce(:f_state,-1)) into :f_state_name;
  end
  SUSPEND;
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_I (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_SATE BIGINT,
    F_PRICE BIGINT)
AS
BEGIN
  INSERT INTO T_DOC_PRICE (
    F_ID,
    F_NUM,
    F_DATE,
    F_PARENT,
    F_STATE,
    F_PRICE)
  VALUES (
    :F_ID,
    :F_NUM,
    :F_DATE,
    :F_PARENT,
    :F_SATE,
    :F_PRICE);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60),
    F_STATE_NAME VARCHAR(60),
    F_NACENKA NUMERIC(15,3),
    F_USER VARCHAR(60))
AS
BEGIN
  FOR SELECT F_ID,
             F_NUM,
             F_DATE,
             F_PARENT,
             d.F_StATE,
             F_PRICE,
             f_nacenka,
             f_user
      FROM T_DOC_PRICE d,
        SP_CHECK_SYS_PRIVS('T_DOC_PRICE') p
      where
        f_date between coalesce(:str_date,f_date) and coalesce(:end_date,f_date)
        and d.f_state > 0
        and p.f_result = 'SEL'
        and iif(p.f_state='ANY',d.f_state,p.f_state)=d.f_state

      INTO :F_ID,
           :F_NUM,
           :F_DATE,
           :F_PARENT,
           :F_StATE,
           :F_PRICE,
           :f_nacenka,
           :f_user
  DO
  BEGIN
    if (f_price is not null) then
      select f_name from sp_t_nsi_price_get(:f_price) into :f_price_name;
    else
      f_price_name=null;
    if (f_state is not null) then
      select f_name from sp_t_nsi_state_get(:f_state) into :f_state_name;
    else
      f_state_name=null;
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_DOC_PRICE_STR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_I (
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_DOC_PRICE BIGINT)
AS
BEGIN
  INSERT INTO T_DOC_PRICE_STR (
    F_GOOD,
    F_PRICE,
    F_DOC_PRICE)
  VALUES (
    :F_GOOD,
    :F_PRICE,
    :F_DOC_PRICE);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_S (
    F_DOC_PRICE_ID INTEGER)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_DOC_PRICE BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ARTICLE VARCHAR(20),
    F_OLD_PRICE NUMERIC(15,3),
    F_SKLAD_OST NUMERIC(15,3))
AS
declare variable F_SKLAD bigint;
declare variable F_DATE date;
begin
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('default_sklad')
  into :F_SKLAD;
  select F_DATE
  from T_DOC_PRICE
  where F_ID = :F_DOC_PRICE_ID
  into :F_DATE;
  for select F_ID, F_GOOD, F_PRICE, F_DOC_PRICE, F_OLD_PRICE
      from T_DOC_PRICE_STR
      where F_DOC_PRICE = :F_DOC_PRICE_ID
      into :F_ID, :F_GOOD, :F_PRICE, :F_DOC_PRICE, :F_OLD_PRICE
  do
  begin
    F_SKLAD_OST=0;
    select F_NAME, F_ARTICLE
    from SP_T_NSI_GOODS_GET(coalesce(:F_GOOD, -1), null)
    into :F_GOOD_NAME, :F_GOOD_ARTICLE;
    select F_END_OST
    from SP_T_REG_GOOD_GET(:F_GOOD, :F_DATE, :F_SKLAD)
    into :F_SKLAD_OST;
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_STR_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE NUMERIC(15,3),
    F_DOC_PRICE BIGINT)
AS
BEGIN
  UPDATE T_DOC_PRICE_STR
  SET F_GOOD = :F_GOOD,
      F_PRICE = :F_PRICE,
      F_DOC_PRICE = :F_DOC_PRICE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PRICE_U (
    F_ID BIGINT,
    F_NUM VARCHAR(20),
    F_DATE DATE,
    F_PARENT BIGINT,
    F_STATE BIGINT,
    F_PRICE BIGINT)
AS
BEGIN
  UPDATE T_DOC_PRICE
  SET F_NUM = :F_NUM,
      F_DATE = :F_DATE,
      F_PARENT = :F_PARENT,
      F_STATE = :F_STATE,
      F_PRICE = :F_PRICE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_PROPERTYES_S (
    P_DOC BIGINT,
    P_MOVETYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_PROPERTY_ID BIGINT,
    F_PROPERTY_NAME VARCHAR(255),
    F_VALUE VARCHAR(255))
AS
begin
  for select P.F_ID, P.F_PROPERTY, N.F_NAME, P.F_VALUE
      from T_DOC_PROPERTY P
      inner join T_NSI_DOC_PROPERTY N on P.F_PROPERTY = N.F_ID
      where P.F_DOC = :P_DOC and
            P.F_DOC_MOVETYPE = :P_MOVETYPE
      into :F_ID, :F_pROpERTY_ID, :F_PROPERTY_NAME, :F_VALUE
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_PROPERTYES_SET (
    P_DOC_ID BIGINT,
    P_DOC_MOVETYPE BIGINT,
    P_PROPERTY_ID BIGINT,
    P_VALUE VARCHAR(255))
AS
begin
  if (not exists(select 1
                 from T_DOC_PROPERTY
                 where F_DOC = :P_DOC_ID and
                       F_DOC_MOVETYPE = :P_DOC_MOVETYPE and
                       F_PROPERTY = :P_PROPERTY_ID)) then
  begin
    insert into T_DOC_PROPERTY (F_DOC, F_DOC_MOVETYPE, F_PROPERTY, F_VALUE)
    values (:P_DOC_ID, :P_DOC_MOVETYPE, :P_PROPERTY_ID, :P_VALUE);
  end
  else
  begin
    update T_DOC_PROPERTY
    set F_VALUE = :P_VALUE
    where F_DOC = :P_DOC_ID and
          F_DOC_MOVETYPE = :P_DOC_MOVETYPE and
          F_PROPERTY = :P_PROPERTY_ID
          and coalesce(f_value,0)<>:p_value;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_D (
    DOC_ID BIGINT)
AS
begin
  /* Procedure Text */
  update t_doc_template set f_state=-1 where f_id=:doc_id;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_GET (
    DOC_ID BIGINT = -10)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_AUTHOR VARCHAR(60),
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60),
    F_PRICE BIGINT,
    F_PRICE_NAME VARCHAR(60))
AS
begin
  if (DOC_ID = -10) then
  begin
    F_ID = gen_id(GEN_T_DOC_TEMPLATE_ID, 1);
    execute procedure SP_T_DOC_TEMPLATE_I(:F_ID, null, null, null);
  end
  else
    F_ID = DOC_ID;
  select F_NUMBER, F_DATE, F_AUTHOR, F_STATE, F_PRICE
  from T_DOC_TEMPLATE
  where F_ID = :F_ID
  into :F_NUMBER, :F_DATE, :F_AUTHOR, :F_STATE, :F_PRICE;
  select F_NAME
  from SP_T_NSI_STATE_GET(:F_STATE)
  into :F_STATE_NAME;
  select F_NAME
  from SP_T_NSI_PRICE_GET(:F_PRICE)
  into :F_PRICE_NAME;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_I (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT)
AS
begin
  insert into t_doc_template (
    f_id,
    f_number,
    f_date,
    f_state)
  values (
    :f_id,
    :f_number,
    :f_date,
    :f_state);
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_AUTHOR VARCHAR(60),
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60))
AS
begin
  /* Procedure Text */
  for select F_ID, F_NUMBER, F_DATE, F_AUTHOR, F_STATE
      from T_DOC_TEMPLATE
      where F_STATE > 0 and
            (F_DATE between coalesce(:STR_DATE, F_DATE) and coalesce(:END_DATE, F_DATE))
      into :F_ID, :F_NUMBER, :F_DATE, :F_AUTHOR, :F_STATE
  do
  begin
    select F_NAME
    from SP_T_NSI_STATE_GET(:F_STATE)
    into :F_STATE_NAME;

    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_D (
    F_ID BIGINT)
AS
begin
  delete from T_DOC_TEMPLATE_STR
  where F_ID = :F_ID;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_I (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_DESCR VARCHAR(255) = null)
AS
declare variable V_PRICE bigint;
declare variable V_PRICE_VAL numeric(15,3);
begin
  if (not exists(select 1
                 from T_DOC_TEMPLATE_STR
                 where F_GOOD = :F_GOOD and
                       F_DOC_TEMPLATE = :F_DOC_TEMPLATE)) then
  begin
    select coalesce(F_PRICE, 0)
    from SP_T_DOC_TEMPLATE_GET(:F_DOC_TEMPLATE)
    into :V_PRICE;
    if (V_PRICE > 0) then
    begin
      select F_VALUE
      from SP_T_PRICE_GET(:V_PRICE, :F_GOOD)
      into :V_PRICE_VAL;
    end
    else
    begin
      V_PRICE_VAL = F_PRICE_VAL;
    end

    insert into T_DOC_TEMPLATE_STR (F_ID, F_DOC_TEMPLATE, F_GOOD, F_PRICE_VAL, F_CNT, f_descr)
    values (:F_ID, :F_DOC_TEMPLATE, :F_GOOD, :V_PRICE_VAL, coalesce(:F_CNT, 1),:f_descr);
  end
  else
    update T_DOC_TEMPLATE_STR
    set F_CNT = coalesce(F_CNT, 0) + coalesce(:F_CNT, 1)
    where F_GOOD = :F_GOOD and
          F_DOC_TEMPLATE = :F_DOC_TEMPLATE;
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_S (
    P_TEMPLATE_DOC BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(60),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(20),
    F_GOOD_DOP_INFO VARCHAR(255),
    F_GOOD_PARTNER BIGINT,
    F_CNT NUMERIC(15,3),
    F_PRICE_VAL NUMERIC(15,3),
    F_SUM NUMERIC(15,3),
    F_OST_SKLAD_DEF NUMERIC(15,3),
    F_DESCR VARCHAR(255),
    F_GOOD_GRP_COLOR VARCHAR(60))
AS
declare variable V_DATE date;
declare variable V_SKLAD bigint;
begin
  select F_DATE
  from T_DOC_TEMPLATE
  where F_ID = :P_TEMPLATE_DOC
  into :V_DATE;
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('default_sklad')
  into :V_SKLAD;

  for select F_ID, F_DOC_TEMPLATE, F_GOOD, F_CNT, F_PRICE_VAL, F_SUM, F_DESCR
      from T_DOC_TEMPLATE_STR
      where F_DOC_TEMPLATE = :P_TEMPLATE_DOC
      into :F_ID, :F_DOC_TEMPLATE, :F_GOOD, :F_CNT, :F_PRICE_VAL, :F_SUM, :F_DESCR
  do
  begin
    if (coalesce(F_GOOD, 0) > 0) then
      select F_NAME, F_ARTICLE, F_ED_IZM_NAME, F_ED_IZM_SHORT_NAME, F_SCANCODE, F_DOP_INFO, F_PARTNER,
             F_GOODS_GRP_COLOR
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_ARTICLE, :F_ED_IZM_NAME, :F_ED_IZM_SHORT_NAME, :F_SCANCODE, :F_GOOD_DOP_INFO,
           :F_GOOD_PARTNER, :F_GOOD_GRP_COLOR;
    select F_END_OST
    from SP_T_REG_GOOD_GET(:F_GOOD, :V_DATE, :V_SKLAD)
    into :F_OST_SKLAD_DEF;

    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_S_BY_CNT (
    DOC_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL FLOAT,
    F_CNT FLOAT,
    F_SUM FLOAT,
    F_GOOD_NAME VARCHAR(255),
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_GOOD_DOP_INFO VARCHAR(255))
AS
declare variable DOC_CNT integer;
BEGIN
  FOR SELECT F_ID,
             F_DOC_template,
             F_GOOD,
             F_PRICE_val,
             F_CNT,
             F_SUM
      FROM t_doc_template_str
      where
        f_doc_template=:doc_id
      INTO :F_ID,
           :F_DOC_template,
           :F_GOOD,
           :F_PRICE_val,
           :F_CNT,
           :F_SUM
  DO
  BEGIN
    doc_cnt=0;
    if (coalesce(f_good,-1)>0) then
      select f_name,f_article,f_ed_izm_name,f_ed_izm_short_name,f_scancode,f_dop_info from sp_t_nsi_goods_get(:f_good,null)
        into :f_good_name,:f_article,:f_ed_izm_name,:f_ed_izm_short_name,:f_scancode,:f_good_dop_info;
    doc_cnt=coalesce(f_cnt,1);
    while (doc_cnt>0) do
    begin
      SUSPEND;
      doc_cnt=doc_cnt-1;
    end
  END
END^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_STR_U (
    F_ID BIGINT,
    F_DOC_TEMPLATE BIGINT,
    F_GOOD BIGINT,
    F_PRICE_VAL NUMERIC(15,3),
    F_CNT NUMERIC(15,3),
    F_DESCR VARCHAR(255))
AS
begin
    update T_DOC_TEMPLATE_STR
    set F_CNT = coalesce(:F_CNT, 1)
    where F_id = :F_id and f_cnt<>:f_cnt;
    update T_DOC_TEMPLATE_STR
    set F_price_val = :f_price_val
    where f_id=:f_id and F_price_val <> :f_price_val;
    update T_DOC_TEMPLATE_STR
    set F_good = :f_good
    where f_id=:f_id and F_good <> :f_good;
    update T_DOC_TEMPLATE_STR
    set F_descr = :f_descr
    where f_id=:f_id and coalesce(F_descr,'') <> coalesce(:f_descr,'');

end^


CREATE OR ALTER PROCEDURE SP_T_DOC_TEMPLATE_U (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DATE DATE,
    F_STATE BIGINT,
    F_PRICE BIGINT,
    F_SKLAD BIGINT = null,
    F_PARTNER BIGINT = null)
AS
begin
  if (f_number is not null) then
    update t_doc_template set f_number=:f_number where f_id=:f_id and f_number<>:f_number;
  if (f_date is not null) then
    update t_doc_template set f_date=:f_date where f_id=:f_id and f_date<>:f_date;
  if (f_state is not null) then
    update t_doc_template set f_state=:f_state where f_id=:f_id and f_state<>:f_state;
  if (f_price is not null) then
    update t_doc_template set f_price=:f_price where f_id=:f_id and coalesce(f_price,0)<>:f_price;
  if (f_sklad is not null) then
    update t_doc_template set f_sklad=:f_sklad where f_id=:f_id and coalesce(f_sklad,0)<>:f_sklad;
  if (f_partner is not null) then
    update t_doc_template set f_partner=:f_partner where f_id=:f_id and coalesce(f_partner,0)<>:f_partner;

end^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_INVENTORY
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_INVENTORY_DOC
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_GET (
    F_INVENTORY_DOC BIGINT,
    F_INV BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60))
AS
BEGIN
  if (f_inventory_doc = -10 ) then
  begin
    f_id=GEN_ID(GEN_t_inventory_doc_ID,1);
    f_number=f_id;
    select param_value from SP_GET_SYS_PARAM('inventory_doc_state') into :f_state;
    execute procedure sp_t_inventory_doc_i(:f_id,:f_number, :f_manager,null,:f_inv,:f_state);
  end

  SELECT F_ID,
             F_NUMBER,
             F_MANAGER,
             F_DOC_COUNT,
             F_INVENTORY,
             F_STATE
      FROM T_INVENTORY_DOC
      where
        f_id=:f_inventory_doc
      INTO :F_ID,
           :F_NUMBER,
           :F_MANAGER,
           :F_DOC_COUNT,
           :F_INVENTORY,
           :F_STATE;
    if (f_state is not null) then
    begin
      select f_name from t_nsi_state where f_id=:f_state into :f_state_name;
    end
    SUSPEND;
    f_state=null;
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_I (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  INSERT INTO T_INVENTORY_DOC (
    F_ID,
    F_NUMBER,
    F_MANAGER,
    F_DOC_COUNT,
    F_INVENTORY,
    F_STATE)
  VALUES (
    :F_ID,
    :F_NUMBER,
    :F_MANAGER,
    :F_DOC_COUNT,
    :F_INVENTORY,
    :F_STATE);
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_S (
    F_INV BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT,
    F_STATE_NAME VARCHAR(60))
AS
BEGIN
  FOR SELECT F_ID,
             F_NUMBER,
             F_MANAGER,
             F_DOC_COUNT,
             F_INVENTORY,
             F_STATE
      FROM T_INVENTORY_DOC
      where
        f_inventory=:f_inv
      INTO :F_ID,
           :F_NUMBER,
           :F_MANAGER,
           :F_DOC_COUNT,
           :F_INVENTORY,
           :F_STATE
  DO
  BEGIN
    if (f_state is not null) then
    begin
      select f_name from t_nsi_state where f_id=:f_state into :f_state_name;
    end
    SUSPEND;
    f_state=null;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_INVENTORY_DOC_STR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_I (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_COUNT NUMERIC(15,3),
    F_INVENTORY_DOC BIGINT)
AS
BEGIN
  if (exists (select f_id from t_inventory_doc_str where f_good=:f_good and f_inventory_doc=:f_inventory_doc)) then
  begin
    update t_inventory_doc_str set f_count=coalesce(f_count,0)+coalesce(:f_count,1)
      where f_good=:f_good and f_inventory_doc=:f_inventory_doc;
  end
  else
  begin
    INSERT INTO T_INVENTORY_DOC_STR (
        F_ID,
        F_GOOD,
        F_COUNT,
        F_INVENTORY_DOC)
    VALUES (
        :F_ID,
        :F_GOOD,
        coalesce(:F_COUNT,1),
        :F_INVENTORY_DOC);
  end
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_S (
    F_INV_DOC BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_COUNT NUMERIC(15,3),
    F_INVENTORY_DOC BIGINT)
AS
BEGIN
  FOR SELECT s.F_ID,
             s.F_GOOD,
             g.f_article,
             g.f_name,
             s.F_COUNT,
             s.F_INVENTORY_DOC
      FROM
        T_INVENTORY_DOC_STR s
        inner join t_nsi_goods g on s.f_good=g.f_id
      where
        f_inventory_doc=:f_inv_doc
      INTO :F_ID,
           :F_GOOD,
           :f_good_article,
           :f_good_name,
           :F_COUNT,
           :F_INVENTORY_DOC
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_STR_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_COUNT NUMERIC(15,3),
    F_INVENTORY_DOC BIGINT)
AS
BEGIN
  UPDATE T_INVENTORY_DOC_STR
  SET F_GOOD = :F_GOOD,
      F_COUNT = :F_COUNT,
      F_INVENTORY_DOC = :F_INVENTORY_DOC
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_DOC_U (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_MANAGER VARCHAR(100),
    F_DOC_COUNT NUMERIC(15,3),
    F_INVENTORY BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  UPDATE T_INVENTORY_DOC
  SET F_NUMBER = :F_NUMBER,
      F_MANAGER = :F_MANAGER,
      F_STATE = :F_STATE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_GET (
    F_INVENTORY BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  if (f_inventory=-10 ) then
  begin
    f_id=GEN_ID(GEN_t_inventory_ID,1);
    f_number=f_id;
    select param_value from SP_GET_SYS_PARAM('default_sklad') into :f_sklad;
    execute procedure sp_t_inventory_i(:f_id,:f_number, :f_date_start,null,:f_sklad,:f_state);
  end

  SELECT F_ID,
             F_NUMBER,
             F_DATE_START,
             F_DATE_COMPLETE,
             F_SKLAD,
             F_STATE
      FROM T_INVENTORY
      where
        f_id=:f_inventory
      INTO :F_ID,
           :F_NUMBER,
           :F_DATE_START,
           :F_DATE_COMPLETE,
           :F_SKLAD,
           :F_STATE;
    if (f_sklad is not null) then
    begin
      select f_name from sp_t_nsi_sklad_get(:f_sklad) into :f_sklad_name;
    end
    SUSPEND;
    f_sklad=null;
end^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_I (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  INSERT INTO T_INVENTORY (
    F_ID,
    F_NUMBER,
    F_DATE_START,
    F_DATE_COMPLETE,
    F_SKLAD,
    F_STATE)
  VALUES (
    :F_ID,
    :F_NUMBER,
    :F_DATE_START,
    :F_DATE_COMPLETE,
    :F_SKLAD,
    :F_STATE);
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_S
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD_NAME VARCHAR(60),
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  FOR SELECT F_ID,
             F_NUMBER,
             F_DATE_START,
             F_DATE_COMPLETE,
             F_SKLAD,
             F_STATE
      FROM T_INVENTORY
      INTO :F_ID,
           :F_NUMBER,
           :F_DATE_START,
           :F_DATE_COMPLETE,
           :F_SKLAD,
           :F_STATE
  DO
  BEGIN
    if (f_sklad is not null) then
    begin
      select f_name from sp_t_nsi_sklad_get(:f_sklad) into :f_sklad_name;
    end
    SUSPEND;
    f_sklad_name=null;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_STR_S (
    F_INV BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_NAME VARCHAR(255),
    F_COUNT_PLAN NUMERIC(15,3),
    F_COUNT_FACT NUMERIC(15,3),
    F_INVENTORY BIGINT)
AS
BEGIN
  FOR SELECT b.F_ID,
             b.F_GOOD,
             g.f_article,
             g.f_name,
             b.F_COUNT_PLAN,
             b.F_COUNT_FACT,
             b.F_INVENTORY
      FROM T_INVENTORY_STR b
        inner join t_nsi_goods g on b.F_good=g.f_id
      where
        b.f_inventory=:f_inv
      INTO :F_ID,
           :F_GOOD,
           :f_good_article,
           :f_good_name,
           :F_COUNT_PLAN,
           :F_COUNT_FACT,
           :F_INVENTORY
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_INVENTORY_U (
    F_ID BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE_START DATE,
    F_DATE_COMPLETE DATE,
    F_SKLAD BIGINT,
    F_STATE BIGINT)
AS
BEGIN
  UPDATE T_INVENTORY
  SET F_NUMBER = :F_NUMBER,
      F_DATE_START = :F_DATE_START,
      F_DATE_COMPLETE = :F_DATE_COMPLETE,
      F_SKLAD = :F_SKLAD,
      F_STATE = :F_STATE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_MONEY_in
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_GET (
    F_MONEY_IN BIGINT,
    F_MONEY_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_USER VARCHAR(60))
AS
BEGIN
  f_id=f_money_in;
  if (f_id=-10) then
  begin
    f_id=GEN_ID(GEN_t_money_in_ID,1);
    select param_value from SP_GET_SYS_PARAM('in_pay_state') into :f_state;
    select param_value from SP_GET_SYS_PARAM('default_sklad') into :f_sklad;
    f_date='now';
    f_number=f_id;
    execute procedure SP_T_MONEY_in_I(:f_id,:f_sklad,null,null,:f_number,:f_date,:f_state,0,:f_money_type);
  end
    FOR SELECT F_ID,
             F_SKLAD,
             F_PARTNER,
             F_BANK,
             f_number, 
             F_DATE,
             F_STATE,
             F_SUMMA,
             F_TYPE,
             f_doc_sum,
             f_user
      FROM T_MONEY_in
      where
        f_id=:f_id
      INTO :F_ID,
           :F_SKLAD,
           :F_PARTNER,
           :F_BANK,
           :f_number,
           :F_DATE,
           :F_STATE,
           :F_SUMMA,
           :F_TYPE,
           :f_doc_sum,
           :f_user
    DO
    BEGIN
      if (f_partner is null) then
        f_partner_name=null;
      else
      begin
        select f_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
      end
      if (f_bank is null) then
        f_bank_name=null;
      else
      begin
        select f_name from sp_t_nsi_bank_get(:f_bank) into :f_bank_name;
      end
      if (f_type is null) then
        f_type_name=null;
      else
      begin
        select f_name from sp_t_nsi_money_in_types_get(:f_type) into :f_type_name;
      end
      if (f_state is null) then
        f_state_name=null;
      else
      begin
        select f_name from SP_T_NSI_STATE_GET(:f_state) into :f_state_name;
      end
      SUSPEND;
    END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT)
AS
BEGIN
  INSERT INTO T_MONEY_IN (
    F_ID,
    F_SKLAD,
    F_PARTNER,
    F_BANK,
    f_number, 
    F_DATE,
    F_STATE,
    F_SUMMA,
    F_TYPE)
  VALUES (
    :F_ID,
    :F_SKLAD,
    :F_PARTNER,
    :F_BANK,
    :f_number, 
    :F_DATE,
    :F_STATE,
    :F_SUMMA,
    :F_TYPE);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_USER VARCHAR(60))
AS
BEGIN
  FOR SELECT F_ID,
             F_SKLAD,
             F_PARTNER,
             F_BANK,
             f_number, 
             F_DATE,
             d.F_STATE,
             F_SUMMA,
             d.F_TYPE,
             f_doc_sum,
             f_user
      FROM T_MONEY_IN d,
        SP_CHECK_SYS_PRIVS('T_MONEY_IN') p
      where
        f_date between coalesce(:str_date,f_date) and coalesce(:end_date, f_date)
        and p.f_result = 'SEL'
        and iif(p.f_type='ANY',d.f_type,p.f_type)=d.f_type
        and iif(p.f_state='ANY',d.f_state,p.f_state)=d.f_state

      order by f_date
      INTO :F_ID,
           :F_SKLAD,
           :F_PARTNER,
           :F_BANK,
           :f_number,
           :F_DATE,
           :F_STATE,
           :F_SUMMA,
           :F_TYPE,
           :f_doc_sum,
           :f_user
  DO
  BEGIN
    if (f_partner is null) then
      f_partner_name=null;
    else
    begin
      select f_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
    end
    if (f_bank is null) then
      f_bank_name=null;
    else
    begin
      select f_name from sp_t_nsi_bank_get(:f_bank) into :f_bank_name;
    end
    if (f_type is null) then
      f_type_name=null;
    else
    begin
      select f_name from sp_t_nsi_money_in_types_get(:f_type) into :f_type_name;
    end
    if (f_state is null) then
      f_state_name=null;
    else
    begin
      select f_name from SP_T_NSI_STATE_GET(:f_state) into :f_state_name;
    end
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_MONEY_IN_STR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_I (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
declare variable P_DOC_SUM numeric(15,3);
declare variable P_PAY_SUM numeric(15,3);
declare variable P_SUM numeric(15,3);
BEGIN
  p_sum=f_summa;
  if (coalesce(p_sum, 0)=0) then
  begin
    select f_pay_sum,f_doc_sum from sp_t_doc_out_get(:f_doc) into :p_pay_sum,:p_doc_sum;
    if (p_doc_sum>p_pay_sum) then
      p_sum=p_doc_sum-p_pay_sum;
  end
  INSERT INTO T_MONEY_IN_STR (
    F_ID,
    F_DOC,
    F_MONEY,
    F_SUMMA)
  VALUES (
    :F_ID,
    :F_DOC,
    :F_MONEY,
    :P_SUM);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_S (
    F_MONEY_IN BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  FOR SELECT F_ID,
             F_DOC,
             F_MONEY,
             F_SUMMA
      FROM T_MONEY_IN_STR
      where
        f_money=:f_money_in
      INTO :F_ID,
           :F_DOC,
           :F_MONEY,
           :F_SUMMA
  DO
  BEGIN
    if (coalesce(f_doc,-1)<1) then
    begin
      f_doc_info=null;
    end
    else
    begin
      select '  '||f_number||'  '||(select f_value from PR_DATE_TO_STR(f_date))||';  '||
        f_doc_sum||';  "'||f_partner_name||'"'
      from SP_T_DOC_OUT_GET(:f_doc) into :f_doc_info;
    end
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_S_DOC (
    F_DOC_OUT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  FOR SELECT F_ID,
             F_DOC,
             F_MONEY,
             F_SUMMA
      FROM T_MONEY_IN_STR
      where
        f_doc=:f_doc_out
      INTO :F_ID,
           :F_DOC,
           :F_MONEY,
           :F_SUMMA
  DO
  BEGIN
    if (coalesce(f_money,-1)<1) then
    begin
      f_doc_info=null;
    end
    else
    begin
      select '  '||f_number||'  '||(select f_value from PR_DATE_TO_STR(f_date))||';  '||
        f_summa||';  "'||f_partner_name||'"'
      from SP_T_MONEY_IN_GET(:f_money,null) into :f_doc_info;
    end
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_STR_U (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
BEGIN
  UPDATE T_MONEY_IN_STR
  SET F_DOC = :F_DOC,
      F_MONEY = :F_MONEY,
      F_SUMMA = :F_SUMMA
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_IN_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT)
AS
BEGIN
  UPDATE T_MONEY_IN
  SET F_SKLAD = :F_SKLAD,
      F_PARTNER = :F_PARTNER,
      F_BANK = :F_BANK,
      F_NUMBER = :F_NUMBER,
      F_DATE = :F_DATE,
      F_STATE = :F_STATE,
      F_SUMMA = :F_SUMMA,
      F_TYPE = :F_TYPE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_MONEY_OUT
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_GET (
    F_MONEY_IN BIGINT,
    F_MONEY_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_DOC_SUM NUMERIC(15,3),
    F_DOP_INFO VARCHAR(10000),
    F_USER VARCHAR(60))
AS
BEGIN
  f_id=f_money_in;
  if (f_id=-10) then
  begin
    f_id=GEN_ID(GEN_t_money_out_ID,1);
    select param_value from SP_GET_SYS_PARAM('in_pay_state') into :f_state;
    select param_value from SP_GET_SYS_PARAM('default_sklad') into :f_sklad;
    f_date='now';
    f_number=f_id;
    execute procedure SP_T_MONEY_OUT_I(:f_id,:f_sklad,null,null,:f_number,:f_date,:f_state,0,:f_money_type);
  end
    FOR SELECT F_ID,
             F_SKLAD,
             F_PARTNER,
             F_BANK,
             f_number, 
             F_DATE,
             F_STATE,
             F_SUMMA,
             F_TYPE,
             f_doc_sum,
             f_dop_info,
             f_user
      FROM T_MONEY_OUT
      where
        f_id=:f_id
      INTO :F_ID,
           :F_SKLAD,
           :F_PARTNER,
           :F_BANK,
           :f_number,
           :F_DATE,
           :F_STATE,
           :F_SUMMA,
           :F_TYPE,
           :f_doc_sum,
           :f_dop_info,
           :f_user
    DO
    BEGIN
      if (f_partner is null) then
        f_partner_name=null;
      else
      begin
        select f_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
      end
      if (f_bank is null) then
        f_bank_name=null;
      else
      begin
        select f_name from sp_t_nsi_bank_get(:f_bank) into :f_bank_name;
      end
      if (f_type is null) then
        f_type_name=null;
      else
      begin
        select f_name from sp_t_nsi_money_in_types_get(:f_type) into :f_type_name;
      end
      if (f_state is null) then
        f_state_name=null;
      else
      begin
        select f_name from SP_T_NSI_STATE_GET(:f_state) into :f_state_name;
      end
      SUSPEND;
    END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_I (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT)
AS
BEGIN
  INSERT INTO T_MONEY_OUT (
    F_ID,
    F_SKLAD,
    F_PARTNER,
    F_BANK,
    f_number, 
    F_DATE,
    F_STATE,
    F_SUMMA,
    F_TYPE)
  VALUES (
    :F_ID,
    :F_SKLAD,
    :F_PARTNER,
    :F_BANK,
    :f_number, 
    :F_DATE,
    :F_STATE,
    :F_SUMMA,
    :F_TYPE);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_S (
    STR_DATE DATE = null,
    END_DATE DATE = null)
RETURNS (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(100),
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(100),
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE_NAME VARCHAR(100),
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE_NAME VARCHAR(100),
    F_TYPE BIGINT,
    F_USER VARCHAR(60))
AS
BEGIN
  FOR SELECT F_ID,
             F_SKLAD,
             F_PARTNER,
             F_BANK,
             f_number, 
             F_DATE,
             d.F_STATE,
             F_SUMMA,
             d.F_TYPE,
             f_user
      FROM T_MONEY_OUT d,
        SP_CHECK_SYS_PRIVS('T_MONEY_OUT') p
      where
        f_date between coalesce(:str_date,f_date) and coalesce(:end_date,f_date)
        and p.f_result = 'SEL'
        and iif(p.f_type='ANY',d.f_type,p.f_type)=d.f_type
        and iif(p.f_state='ANY',d.f_state,p.f_state)=d.f_state
      order by f_date
      INTO :F_ID,
           :F_SKLAD,
           :F_PARTNER,
           :F_BANK,
           :f_number,
           :F_DATE,
           :F_STATE,
           :F_SUMMA,
           :F_TYPE,
           :f_user
  DO
  BEGIN
    if (f_partner is null) then
      f_partner_name=null;
    else
    begin
      select f_name from sp_t_nsi_partner_get(:f_partner) into :f_partner_name;
    end
    if (f_bank is null) then
      f_bank_name=null;
    else
    begin
      select f_name from sp_t_nsi_bank_get(:f_bank) into :f_bank_name;
    end
    if (f_type is null) then
      f_type_name=null;
    else
    begin
      select f_name from sp_t_nsi_money_in_types_get(:f_type) into :f_type_name;
    end
    if (f_state is null) then
      f_state_name=null;
    else
    begin
      select f_name from SP_T_NSI_STATE_GET(:f_state) into :f_state_name;
    end
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_MONEY_OUT_STR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_I (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
BEGIN
  INSERT INTO T_MONEY_OUT_STR (
    F_ID,
    F_DOC,
    F_MONEY,
    F_SUMMA)
  VALUES (
    :F_ID,
    :F_DOC,
    :F_MONEY,
    :F_SUMMA);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_S (
    F_MONEY_IN BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  FOR SELECT F_ID,
             F_DOC,
             F_MONEY,
             F_SUMMA
      FROM T_MONEY_OUT_STR
      where
        f_money=:f_money_in
      INTO :F_ID,
           :F_DOC,
           :F_MONEY,
           :F_SUMMA
  DO
  BEGIN
    if (coalesce(f_doc,-1)<1) then
    begin
      f_doc_info=null;
    end
    else
    begin
      select '  '||f_number||'  '||(select f_value from PR_DATE_TO_STR(f_date))||';  '||
        f_doc_sum||';  "'||f_partner_name||'"'
      from SP_T_DOC_IN_GET(:f_doc) into :f_doc_info;
    end
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_S_DOC (
    F_DOC_OUT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT,
    F_DOC_INFO VARCHAR(255))
AS
BEGIN
  FOR SELECT F_ID,
             F_DOC,
             F_MONEY,
             F_SUMMA
      FROM T_MONEY_out_STR
      where
        f_doc=:f_doc_out
      INTO :F_ID,
           :F_DOC,
           :F_MONEY,
           :F_SUMMA
  DO
  BEGIN
    if (coalesce(f_money,-1)<1) then
    begin
      f_doc_info=null;
    end
    else
    begin
      select '  '||f_number||'  '||(select f_value from PR_DATE_TO_STR(f_date))||';  '||
        f_summa||';  "'||f_partner_name||'"'
      from SP_T_MONEY_out_GET(:f_money,null) into :f_doc_info;
    end
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_STR_U (
    F_ID BIGINT,
    F_DOC BIGINT,
    F_MONEY BIGINT,
    F_SUMMA FLOAT)
AS
BEGIN
  UPDATE T_MONEY_OUT_STR
  SET F_DOC = :F_DOC,
      F_MONEY = :F_MONEY,
      F_SUMMA = :F_SUMMA
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_MONEY_OUT_U (
    F_ID BIGINT,
    F_SKLAD BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_NUMBER VARCHAR(20),
    F_DATE DATE,
    F_STATE BIGINT,
    F_SUMMA FLOAT,
    F_TYPE BIGINT,
    F_DOP_INFO VARCHAR(10000))
AS
BEGIN
  UPDATE T_MONEY_OUT
  SET F_SKLAD = :F_SKLAD,
      F_PARTNER = :F_PARTNER,
      F_BANK = :F_BANK,
      F_NUMBER = :F_NUMBER,
      F_DATE = :F_DATE,
      F_STATE = :F_STATE,
      F_SUMMA = :F_SUMMA,
      F_TYPE = :F_TYPE,
      f_dop_info = :f_dop_info
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_D (
    F_ID BIGINT)
AS
BEGIN
  update T_NSI_BANK set f_state =-1
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_GET (
    F_BANK_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20),
    F_XML VARCHAR(10000))
AS
BEGIN
  if (f_bank_id=-10) then
  begin
    f_id=GEN_ID(GEN_t_nsi_bank_ID,1);
    execute procedure SP_T_NSI_BANK_i(:f_id,null, null, null, null, null, null, null);
  end
  else
  begin
    f_id=f_bank_id;
  end
  SELECT F_NAME,
    F_U_NAME,
    F_U_ADDRES,
    F_INN,
    F_KPP,
    F_K_SCH,
    f_bik
  FROM T_NSI_BANK
  where
    f_id=:f_id
  INTO :F_NAME,
    :F_U_NAME,
    :F_U_ADDRES,
    :F_INN,
    :F_KPP,
    :F_K_SCH,
    :F_BIK;
  f_xml='<T_NSI_BANK>'||
    '<f_id>'||f_id||'</f_id>'||
    '<f_name><![CDATA['||f_name||']]></f_name>'||
    '<f_u_name><![CDATA['||f_u_name||']]></f_u_name>'||
    '<f_u_addres><![CDATA['||coalesce(f_u_addres,'')||']]></f_u_addres>'||
    '<f_inn>'||coalesce(f_inn,'')||'</f_inn>'||
    '<f_kpp>'||coalesce(f_kpp, '')||'</f_kpp>'||
    '<f_k_sch>'||coalesce(f_k_sch,'')||'</f_k_sch>'||
    '<f_bik>'||coalesce(f_bik,'')||'</f_bik>'||
    '</T_NSI_BANK>';
  SUSPEND;
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20))
AS
BEGIN
  INSERT INTO T_NSI_BANK (
    F_ID,
    F_NAME,
    F_U_NAME,
    F_U_ADDRES,
    F_INN,
    F_KPP,
    F_K_SCH,
    f_bik)
  VALUES (
    :F_ID,
    :F_NAME,
    :F_U_NAME,
    :F_U_ADDRES,
    :F_INN,
    :F_KPP,
    :F_K_SCH,
    :F_BIK);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20))
AS
BEGIN
    FOR SELECT F_ID,
             F_NAME,
             F_U_NAME,
             F_U_ADDRES,
             F_INN,
             F_KPP,
             F_K_SCH,
             f_bik
      FROM T_NSI_BANK
      where
        f_state=1
      INTO :F_ID,
           :F_NAME,
           :F_U_NAME,
           :F_U_ADDRES,
           :F_INN,
           :F_KPP,
           :F_K_SCH,
           :F_BIK
    DO
    BEGIN
      SUSPEND;
    END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_BANK_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_K_SCH VARCHAR(60),
    F_BIK VARCHAR(20))
AS
BEGIN
  UPDATE T_NSI_BANK
  SET F_NAME = :F_NAME,
      F_U_NAME = :F_U_NAME,
      F_U_ADDRES = :F_U_ADDRES,
      F_INN = :F_INN,
      F_KPP = :F_KPP,
      F_K_SCH = :F_K_SCH,
      f_bik = :f_bik
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CARD_GET (
    P_DISCOUNT BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
begin
  if (p_discount = -10) then
    select f_discount_id,f_discount,f_number
    from sp_t_nsi_discount_create
    into :F_ID, :F_NUMBER, :F_DISCOUNT;
  else
    select F_ID, F_NUMBER, F_DISCOUNT
      from T_NSI_DISCOUNT_CARD
      where
        f_id = :p_discount
      into :F_ID, :F_NUMBER, :F_DISCOUNT;
    suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CARD_S
RETURNS (
    F_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
begin
  for select F_ID, F_NUMBER, F_DISCOUNT
      from T_NSI_DISCOUNT_CARD
      into :F_ID, :F_NUMBER, :F_DISCOUNT
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CARD_U (
    F_NSI_DISCOUNT BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
begin
  /* Procedure Text */
  if (f_number is not null) then
    update t_nsi_discount_card set f_number=:f_number where f_id=:f_nsi_discount and coalesce(f_number,'')<>:f_number;
  if (f_discount is not null) then
    update t_nsi_discount_card set f_discount=:f_discount where f_id=:f_nsi_discount and coalesce(f_discount,0)<>:f_discount;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_DISCOUNT_CREATE
RETURNS (
    F_DISCOUNT_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3))
AS
begin
  F_DISCOUNT_ID = gen_id(GEN_T_NSI_DISCOUNT_CARD_ID, 1);
  insert into T_NSI_DISCOUNT_CARD (F_ID)
  values (:F_DISCOUNT_ID);
  select F_NUMBER, F_DISCOUNT
  from T_NSI_DISCOUNT_CARD
  where F_ID = :F_DISCOUNT_ID
  into :F_NUMBER, :F_DISCOUNT;
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_IN_TYPES_GET (
    F_ID BIGINT)
RETURNS (
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  FOR SELECT
             F_NAME,
             F_DESCR
      FROM T_NSI_DOC_IN_TYPES
      where
        f_id=:F_ID
      INTO
           :F_NAME,
           :F_DESCR
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_IN_TYPES_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_DESCR
      FROM T_NSI_DOC_IN_TYPES
      INTO :F_ID,
           :F_NAME,
           :F_DESCR
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_MOVE_TYPES_GET (
    F_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_DESCR
      FROM T_NSI_DOC_MOVE_TYPES
      where
        f_id=:f_type
      INTO :F_ID,
           :F_NAME,
           :F_DESCR
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_MOVE_TYPES_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_DESCR
      FROM T_NSI_DOC_MOVE_TYPES
      INTO :F_ID,
           :F_NAME,
           :F_DESCR
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_OUT_TYPES_GET (
    F_ID BIGINT)
RETURNS (
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  FOR SELECT
             F_NAME,
             F_DESCR
      FROM T_NSI_DOC_out_TYPES
      where
        f_id=:F_ID
      INTO
           :F_NAME,
           :F_DESCR
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_DOC_PROPERTY_S
RETURNS (
    F_ID TYPE OF COLUMN T_NSI_DOC_PROPERTY.F_ID,
    F_NAME TYPE OF COLUMN T_NSI_DOC_PROPERTY.F_NAME)
AS
begin
  for select f_id,
             f_name
      from t_nsi_doc_property
      into :f_id,
           :f_name
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_NSI_ED_IZM
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_GET (
    F_ED_IZM BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_SHORT_NAME
      FROM T_NSI_ED_IZM
      where
        f_id=:f_ed_izm
      INTO :F_ID,
           :F_NAME,
           :F_SHORT_NAME
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  INSERT INTO T_NSI_ED_IZM (
    F_ID,
    F_NAME,
    F_SHORT_NAME)
  VALUES (
    :F_ID,
    :F_NAME,
    :F_SHORT_NAME);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_SHORT_NAME
      FROM T_NSI_ED_IZM
      INTO :F_ID,
           :F_NAME,
           :F_SHORT_NAME
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_ED_IZM_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_SHORT_NAME VARCHAR(20))
AS
BEGIN
  UPDATE T_NSI_ED_IZM
  SET F_NAME = :F_NAME,
      F_SHORT_NAME = :F_SHORT_NAME
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_IMPORT_PHOTO (
    F_ARTICLE VARCHAR(60),
    F_MMEDIA BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_NAME VARCHAR(60) = null)
AS
declare variable V_GOOD_ID bigint;
begin
  if (f_name is null) then
    f_name=replace(:f_article,' ','_')||'.jpg';
  if (exists(select f_id from t_nsi_goods where f_article=:f_article)) then
  begin
    if (not exists (select 1 from t_nsi_goods_mmedia where f_good in (select f_id from t_nsi_goods where f_article=:f_article))) then
    insert into t_nsi_goods_mmedia(f_good,f_memo,f_name)
      select f_id,:f_mmedia,:f_name from t_nsi_goods where f_article=:f_article;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_PARTY_CREATE (
    P_GOOD BIGINT,
    P_DATE DATE,
    P_CNT NUMERIC(15,3),
    P_PRICE NUMERIC(15,3))
RETURNS (
    F_ID BIGINT)
AS
begin
  F_ID = gen_id(GEN_T_NSI_GOOD_PARTY_ID, 1);
  insert into T_NSI_GOOD_PARTY (F_ID, F_GOOD, F_DATE, F_CNT, F_PRICE)
  values (:F_ID, :P_GOOD, :P_DATE, :P_CNT, :P_PRICE);
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_D (
    F_ID TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID)
AS
begin
  delete from t_nsi_good_type
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_I (
    F_ID TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID,
    F_NAME TYPE OF COLUMN T_NSI_GOOD_TYPE.F_NAME,
    F_CHECK_OST TYPE OF COLUMN T_NSI_GOOD_TYPE.F_CHECK_OST,
    F_COMPL TYPE OF COLUMN T_NSI_GOOD_TYPE.F_COMPL)
AS
begin
  insert into t_nsi_good_type (
    f_id,
    f_name,
    f_check_ost,
    f_compl)
  values (
    :f_id,
    :f_name,
    :f_check_ost,
    :f_compl);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_S (
    P_ID D_INT = 0)
RETURNS (
    F_ID TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID,
    F_NAME TYPE OF COLUMN T_NSI_GOOD_TYPE.F_NAME,
    F_CHECK_OST TYPE OF COLUMN T_NSI_GOOD_TYPE.F_CHECK_OST,
    F_COMPL TYPE OF COLUMN T_NSI_GOOD_TYPE.F_COMPL)
AS
begin
  if (coalesce(p_id,0)>0) then
  for select f_id,
             f_name,
             f_check_ost,
             f_compl
      from t_nsi_good_type
      where
        f_id=:p_id
      into :f_id,
           :f_name,
           :f_check_ost,
           :f_compl
  do
  begin
    suspend;
  end
  else
  for select f_id,
             f_name,
             f_check_ost,
             f_compl
      from t_nsi_good_type
      into :f_id,
           :f_name,
           :f_check_ost,
           :f_compl
  do
  begin
    suspend;
  end

end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOOD_TYPE_U (
    F_ID TYPE OF COLUMN T_NSI_GOOD_TYPE.F_ID,
    F_NAME TYPE OF COLUMN T_NSI_GOOD_TYPE.F_NAME,
    F_CHECK_OST TYPE OF COLUMN T_NSI_GOOD_TYPE.F_CHECK_OST,
    F_COMPL TYPE OF COLUMN T_NSI_GOOD_TYPE.F_COMPL)
AS
begin
  update t_nsi_good_type
  set f_name = :f_name,
      f_check_ost = :f_check_ost,
      f_compl = :f_compl
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_D (
    F_ID BIGINT)
AS
BEGIN
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_NSI_GOODS') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
  if ((select f_end_ost from SP_T_REG_GOOD_GET(:f_id,'now',null))<>0) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(5);
  update T_NSI_GOODS set f_state=-1
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_DOP_INFO_D (
    P_GOOD_INFO_ID BIGINT)
AS
begin

  delete from t_nsi_goods_dop_info where f_id=:p_good_info_id;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_DOP_INFO_I (
    P_GOOD BIGINT,
    P_GOOD_INFO BIGINT,
    P_GOOD_INFO_VAL VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_INFO BIGINT,
    F_GOOD_INFO_NAME VARCHAR(100),
    F_GOOD_INFO_VAL VARCHAR(60))
AS
begin
  F_GOOD = P_GOOD;
  F_GOOD_INFO = P_GOOD_INFO;
  F_GOOD_INFO_VAL = P_GOOD_INFO_VAL;
  select F_NAME
  from T_NSI_GOODS_INFO
  where F_ID = :F_GOOD_INFO
  into :F_GOOD_INFO_NAME;
  update or insert into T_NSI_GOODS_DOP_INFO (F_GOOD, F_GOOD_INFO, F_GOOD_INFO_VAL)
  values (:F_GOOD, :F_GOOD_INFO, :F_GOOD_INFO_VAL)
  matching (F_GOOD, F_GOOD_INFO);

  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_DOP_INFO_S (
    P_GOOD BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_GOOD_INFO BIGINT,
    F_GOOD_INFO_NAME VARCHAR(100),
    F_GOOD_INFO_VAL VARCHAR(60))
AS
begin
  for select G.F_ID, coalesce(G.F_GOOD, :P_GOOD), I.F_ID, I.F_NAME, G.F_GOOD_INFO_VAL
      from T_NSI_GOODS_INFO I
      left join(select F_ID, F_GOOD_INFO, F_GOOD, F_GOOD_INFO_VAL
                from T_NSI_GOODS_DOP_INFO
                where F_GOOD = :P_GOOD) G on I.F_ID = G.F_GOOD_INFO
      into :F_ID, :F_GOOD, :F_GOOD_INFO, :F_GOOD_INFO_NAME, :F_GOOD_INFO_VAL
  do
    suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GET (
    NSI_ID BIGINT,
    F_GRP BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_GOODS_GRP_NAME VARCHAR(60),
    F_GOODS_GRP_EXT_ID VARCHAR(20),
    F_GOODS_GRP_COLOR VARCHAR(60),
    F_ED_IZM BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60),
    F_DOP_INFO VARCHAR(255),
    F_PARTNER BIGINT,
    F_BARTER SMALLINT,
    F_XML VARCHAR(10000),
    F_GOOD_TYPE BIGINT,
    F_GOOD_TYPE_NAME VARCHAR(60))
AS
declare variable V_PARTNER_INFO varchar(10000);
declare variable V_SCANCODES varchar(10000);
begin
  /* Procedure Text */
  if (F_GRP < 1) then
  begin
    F_GRP = null;
  end
  if (NSI_ID = -10) then
  begin
    F_GOODS_GRP = F_GRP;
    F_NAME = ' ';
    select F_ID
    from SP_T_NSI_GOODS_I(:F_NAME, :F_GOODS_GRP, null, null)
    into :F_ID;
  end
  else
  begin
    F_ID = NSI_ID;
  end
  select F_ID, F_NAME, F_GOODS_GRP, F_ARTICLE, F_ED_IZM, F_DOP_INFO, F_PARTNER, F_BARTER, F_GOOD_TYPE
  from T_NSI_GOODS
  where F_ID = :F_ID
  into :F_ID, :F_NAME, :F_GOODS_GRP, :F_ARTICLE, :F_ED_IZM, :F_DOP_INFO, :F_PARTNER, :F_BARTER, :F_GOOD_TYPE;
  --  end
  if (F_GOODS_GRP is not null) then
  begin
    select F_NAME, F_EXT_ID, F_COLOR
    from SP_T_NSI_GOODS_GRP_GET(:F_GOODS_GRP, null)
    into :F_GOODS_GRP_NAME, :F_GOODS_GRP_EXT_ID, :F_GOODS_GRP_COLOR;
  end
  else
  begin
    F_GOODS_GRP_NAME = '';
    F_GOODS_GRP_EXT_ID = '19';
  end
  if (coalesce(F_GOOD_TYPE,0)>0) then
    select F_NAME
    from SP_T_NSI_GOOD_TYPE_S(:F_GOOD_TYPE)
    into :F_GOOD_TYPE_NAME;
  select first 1 F_NAME, F_SHORT_NAME
  from SP_T_NSI_ED_IZM_GET(:F_ED_IZM)
  into :F_ED_IZM_NAME, :F_ED_IZM_SHORT_NAME;
  select first 1 F_VALUE
  from SP_T_NSI_SCANCODE_GET(:F_ID)
  into :F_SCANCODE;
  /*  v_scancodes='<T_NSI_SCANCODE>';
  for select f_value from SP_T_NSI_SCANCODE_GET(:f_id) into :f_scancode do
  begin
     v_scancodes=v_scancodes||'<scancode>'||f_scancode||'</scancode>';
  end
  v_scancodes=v_scancodes||'</T_NSI_SCANCODE>';
  if (f_partner is not null) then
  begin
    select f_xml from sp_t_nsi_partner_get(:f_partner) into :v_partner_info;
  end
  else
  begin
    v_partner_info='';
  end
  f_xml='<T_NSI_GOOD>'||
    '<f_id>'||f_id||'</f_id>'||
    '<f_name><![CDATA['||coalesce(f_name,'')||']]></f_name>'||
    '<f_article><![CDATA['||coalesce(f_article,'')||']]></f_article>'||
    v_scancodes||
    v_partner_info||
    '</T_NSI_GOOD>'; */
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GET_BY_SCANCODE (
    SCAN VARCHAR(20))
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ED_IZM BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_SCANCODE VARCHAR(60))
AS
begin
  /* Procedure Text */
  for select S.F_GOOD, G.F_NAME, G.F_ARTICLE, S.F_VALUE, G.F_GOODS_GRP
      from T_NSI_SCANCODE S
      inner join T_NSI_GOODS G on S.F_GOOD = G.F_ID
      where S.F_VALUE = :SCAN
      into :F_ID, :F_NAME, :F_ARTICLE, :F_SCANCODE, :F_GOODS_GRP
  do
  begin

    /*  if (f_id is not null) then
  begin
    select
      f_name,
      f_goods_grp,
      f_ed_izm,
      f_article,
      F_ED_IZM_NAME,
      F_ED_IZM_SHORT_NAME,
      F_SCANCODE
    from
      sp_t_nsi_goods_get(:f_id, null)
    into
      :F_NAME,
      :F_GOODS_GRP,
      :F_ED_IZM,
      :F_ARTICLE,
      :F_ED_IZM_NAME,
      :F_ED_IZM_SHORT_NAME,
      :F_SCANCODE;
  end
  else
  begin
    F_NAME=null;
    F_GOODS_GRP=null;
    F_ED_IZM=null;
    F_ARTICLE=null;
    F_ED_IZM_NAME=null;
    F_ED_IZM_SHORT_NAME=null;
    F_SCANCODE=null;
  end*/
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_D (
    F_ID BIGINT)
AS
begin
  update T_NSI_GOODS
  set F_GOODS_GRP = null
  where F_GOODS_GRP = :F_ID;
  update T_NSI_GOODS_GRP
  set F_STATE = -1
  where (F_ID = :F_ID);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_GET (
    F_GRP BIGINT,
    F_PARENT_GRP BIGINT)
RETURNS (
    GRP_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60),
    F_EXT_ID VARCHAR(20),
    F_DOP_INFO VARCHAR(10000),
    F_COLOR VARCHAR(60))
AS
BEGIN
  if (f_grp=-10) then
  begin
    GRP_ID=GEN_ID(GEN_t_nsi_goods_grp_ID,1);
    F_PARENT=f_parent_grp;
    F_NAME=' ';
    execute procedure sp_t_nsi_goods_grp_i(:grp_ID,:F_PARENT,:f_name);
  end
  else
  begin
    SELECT F_ID,
      coalesce(F_PARENT,-1),
      F_NAME,
      coalesce(f_ext_id,'null'),
      f_dop_info,
      f_color
    FROM T_NSI_GOODS_GRP
    where
      f_id=:f_grp
    INTO
      :grp_ID,
      :F_PARENT,
      :F_NAME,
      :F_EXT_ID,
      :F_DOP_INFO,
      :f_color;
  end
  SUSPEND;
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_I (
    F_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60))
AS
BEGIN
  INSERT INTO T_NSI_GOODS_GRP (
    F_ID,
    F_PARENT,
    F_NAME)
  VALUES (
    :F_ID,
    :F_PARENT,
    :F_NAME);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_S
RETURNS (
    GRP_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60),
    F_COLOR VARCHAR(60))
AS
BEGIN
  FOR
    select 0,
        null, 
        ' ',
        null
    from
        rdb$database
    union
    select -1,
        null, 
        ' ',
        null
    from
        rdb$database
    union
    SELECT F_ID,
        coalesce(F_PARENT,-1),
        F_NAME,
        f_color
      FROM T_NSI_GOODS_GRP
      where f_state=1
      INTO :grp_ID,
           :F_PARENT,
           :F_NAME,
           :f_color
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_GRP_U (
    F_ID BIGINT,
    F_PARENT BIGINT,
    F_NAME VARCHAR(60),
    F_EXT_ID VARCHAR(20),
    F_DOP_INFO VARCHAR(10000),
    F_COLOR VARCHAR(60) = null)
AS
BEGIN
  UPDATE T_NSI_GOODS_GRP
  SET F_PARENT = :F_PARENT,
      F_NAME = :F_NAME,
      f_ext_id = :f_ext_id,
      f_dop_info = :f_dop_info,
      f_color = :f_color
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_I (
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM BIGINT,
    F_EXT_ARTICLE VARCHAR(60) = null)
RETURNS (
    F_ID BIGINT)
AS
BEGIN
/*  if (f_article is null) then
    select first 1 f_id from t_nsi_goods where upper(f_name)=upper(:f_name) into :f_id;
  else
    select first 1 f_id from t_nsi_goods where upper(f_article)=upper(:f_article) into :f_id;*/
  if (not exists(select first 1 f_id from t_nsi_goods where upper(f_article)=upper(:f_article))) then
  begin
    f_id=GEN_ID(GEN_t_nsi_goods_ID,1);
    F_ARTICLE=coalesce(F_ARTICLE,'ART-'||f_id);
    f_ext_article=coalesce(f_ext_article,f_article);
    INSERT INTO T_NSI_GOODS (
      f_id,
      F_NAME,
      F_GOODS_GRP,
      F_ARTICLE,
      F_ED_IZM,
      f_ext_article)
    VALUES (
      :F_ID,
      :F_NAME,
      :F_GOODS_GRP,
      :F_ARTICLE,
      :F_ED_IZM,
      :f_ext_article);
  end
  else
    select first 1 f_id from t_nsi_goods where upper(f_article)=upper(:f_article) into :f_id;
  suspend;
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_D (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID)
AS
begin
  delete from t_nsi_goods_info
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_I (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID,
    F_NAME TYPE OF COLUMN T_NSI_GOODS_INFO.F_NAME,
    F_MULTI TYPE OF COLUMN T_NSI_GOODS_INFO.F_MULTI)
AS
begin
  insert into t_nsi_goods_info (
    f_id,
    f_name,
    f_multi)
  values (
    :f_id,
    :f_name,
    :f_multi);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_S
RETURNS (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID,
    F_NAME TYPE OF COLUMN T_NSI_GOODS_INFO.F_NAME,
    F_MULTI TYPE OF COLUMN T_NSI_GOODS_INFO.F_MULTI)
AS
begin
  for select f_id,
             f_name,
             f_multi
      from t_nsi_goods_info
      into :f_id,
           :f_name,
           :f_multi
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_D (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID)
AS
begin
  delete from t_nsi_goods_info_str
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_I (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID,
    F_NSI_GOODS_INFO TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_NSI_GOODS_INFO,
    F_ORDER TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ORDER,
    F_VALUE TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_VALUE)
AS
begin
  insert into t_nsi_goods_info_str (
    f_id,
    f_nsi_goods_info,
    f_order,
    f_value)
  values (
    :f_id,
    :f_nsi_goods_info,
    :f_order,
    :f_value);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_S (
    P_NSI_GOOD_INFO BIGINT)
RETURNS (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID,
    F_NSI_GOODS_INFO TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_NSI_GOODS_INFO,
    F_ORDER TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ORDER,
    F_VALUE TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_VALUE)
AS
begin
  for select f_id,
             f_nsi_goods_info,
             f_order,
             f_value
      from t_nsi_goods_info_str
      where
        f_nsi_goods_info=:p_nsi_good_info
      into :f_id,
           :f_nsi_goods_info,
           :f_order,
           :f_value
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_STR_U (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ID,
    F_NSI_GOODS_INFO TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_NSI_GOODS_INFO,
    F_ORDER TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_ORDER,
    F_VALUE TYPE OF COLUMN T_NSI_GOODS_INFO_STR.F_VALUE)
AS
begin
  update t_nsi_goods_info_str
  set f_nsi_goods_info = :f_nsi_goods_info,
      f_order = :f_order,
      f_value = :f_value
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_INFO_U (
    F_ID TYPE OF COLUMN T_NSI_GOODS_INFO.F_ID,
    F_NAME TYPE OF COLUMN T_NSI_GOODS_INFO.F_NAME,
    F_MULTI TYPE OF COLUMN T_NSI_GOODS_INFO.F_MULTI)
AS
begin
  update t_nsi_goods_info
  set f_name = :f_name,
      f_multi = :f_multi
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_ART_GET (
    F_GOOD_ART VARCHAR(60),
    F_CH_DATE TIMESTAMP = null)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80)
AS
begin
  select first 1 F_ID
  from T_NSI_GOODS
  where F_ARTICLE = :F_GOOD_ART
  into :F_ID;
  for select F_ID, F_GOOD, F_NAME, F_MEMO
      from SP_T_NSI_GOODS_MMEDIA_S(:F_ID, :F_CH_DATE)
      into :F_ID, :F_GOOD, :F_NAME, :F_MEMO
  do
  begin
    suspend;
  end

end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_D (
    F_ID BIGINT)
AS
begin
  delete from t_nsi_goods_mmedia
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_I (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_CH_DATE TIMESTAMP = 'NOW')
AS
begin
  insert into t_nsi_goods_mmedia (
    f_id,
    f_good,
    f_name,
    f_memo,
    f_ch_date)
  values (
    :f_id,
    :f_good,
    :f_name,
    :f_memo,
    :f_ch_date);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_S (
    F_GOOD_ID BIGINT,
    F_CH_DATE TIMESTAMP = null)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80)
AS
declare variable V_SOURCE_ID bigint;
declare variable V_CONNECT_STR varchar(100);
declare variable V_USER varchar(60);
declare variable V_PASSWD varchar(60);
begin
  if (F_CH_DATE is null) then
  begin
    for select F_ID, F_GOOD, F_NAME, F_MEMO
        from T_NSI_GOODS_MMEDIA
        where F_GOOD = :F_GOOD_ID
        into :F_ID, :F_GOOD, :F_NAME, :F_MEMO
    do
    begin
      suspend;
    end
/*    if (F_ID is null) then
    begin
      for select M.F_MMEDIA, M.F_SOURCE
          from T_NSI_GOODS_MMEDIA_MAP M
          where F_GOOD = :F_GOOD_ID
          into :F_ID, :V_SOURCE_ID
      do
      begin
        select F_HOST || ':' || F_BASE, F_USER, F_PASSWORD
        from T_SYS_SOURCE_DBASE
        where f_id=:v_source_id
        into :V_CONNECT_STR, :V_USER, :V_PASSWD;
        execute statement('select f_id, f_good,f_name, f_memo from sp_t_nsi_goods_mmedia_s(:f_good)')(F_GOOD := F_GOOD_ID) on external :V_CONNECT_STR as user :V_USER password :V_PASSWD
            into :F_ID, :F_GOOD, :F_NAME, :F_MEMO;
        suspend;
      end
    end   */
  end
  else
  begin
    for select F_ID, F_GOOD, F_NAME, F_MEMO
        from T_NSI_GOODS_MMEDIA
        where F_GOOD = :F_GOOD_ID and
              coalesce(F_CH_DATE, '01.01.1900') > :F_CH_DATE
        into :F_ID, :F_GOOD, :F_NAME, :F_MEMO
    do
    begin
      suspend;
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_MMEDIA_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_NAME VARCHAR(60),
    F_MEMO BLOB SUB_TYPE 0 SEGMENT SIZE 80)
AS
begin
  update t_nsi_goods_mmedia
  set f_good = :f_good,
      f_name = :f_name,
      f_memo = :f_memo
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_S (
    GRP_ID INTEGER)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM BIGINT,
    F_ED_IZM_NAME VARCHAR(60),
    F_ED_IZM_SHORT_NAME VARCHAR(20),
    F_DOP_INFO VARCHAR(255),
    F_COLOR VARCHAR(60),
    F_MMEDIA_EXISTS VARCHAR(2),
    F_MMEDIA BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    F_CRE_DATE DATE)
AS
begin
  if (coalesce(GRP_ID, -1) < 1) then
  begin
    for select G.F_ID, G.F_NAME, coalesce(G.F_GOODS_GRP, 0), G.F_ARTICLE, G.F_ED_IZM, G.F_DOP_INFO, GR.F_COLOR,
               I.F_NAME, I.F_SHORT_NAME, iif(MM.F_ID is not null, 'Ok', null) --, MM.F_MEMO
               , G.F_CRE_DATE
        from T_NSI_GOODS G
        left join T_NSI_GOODS_GRP GR on G.F_GOODS_GRP = GR.F_ID
        left join T_NSI_ED_IZM I on G.F_ED_IZM = I.F_ID
        left join T_NSI_GOODS_MMEDIA MM on G.F_ID = MM.F_GOOD
        where G.F_STATE = 1
        order by F_ARTICLE
        into :F_ID, :F_NAME, :F_GOODS_GRP, :F_ARTICLE, :F_ED_IZM, :F_DOP_INFO, :F_COLOR, :F_ED_IZM_NAME,
             :F_ED_IZM_SHORT_NAME, :F_MMEDIA_EXISTS --, :F_MMEDIA
             , :F_CRE_DATE
    do
    begin
      suspend;
    end
  end
  else
  begin
    for select G.F_ID, G.F_NAME, coalesce(G.F_GOODS_GRP, 0), G.F_ARTICLE, G.F_ED_IZM, G.F_DOP_INFO, GR.F_COLOR,
               I.F_NAME, I.F_SHORT_NAME, iif(MM.F_ID is not null, 'Ok', null)
        from T_NSI_GOODS G
        left join T_NSI_GOODS_GRP GR on G.F_GOODS_GRP = GR.F_ID
        left join T_NSI_ED_IZM I on G.F_ED_IZM = I.F_ID
        left join T_NSI_GOODS_MMEDIA MM on G.F_ID = MM.F_GOOD
        where G.F_GOODS_GRP = :GRP_ID and
              G.F_STATE = 1
        order by F_ARTICLE
        into :F_ID, :F_NAME, :F_GOODS_GRP, :F_ARTICLE, :F_ED_IZM, :F_DOP_INFO, :F_COLOR, :F_ED_IZM_NAME,
             :F_ED_IZM_SHORT_NAME, :F_MMEDIA_EXISTS
    do
    begin
      suspend;
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_U (
    F_ID BIGINT,
    F_NAME VARCHAR(255),
    F_GOODS_GRP BIGINT,
    F_ARTICLE VARCHAR(20),
    F_ED_IZM BIGINT,
    F_DOP_INFO VARCHAR(255),
    F_BARTER SMALLINT = 0,
    F_GOOD_TYPE BIGINT = null)
AS
BEGIN
  if (F_GOOD_TYPE is not null) then
  begin
    update t_nsi_goods set f_good_type = :F_GOOD_TYPE
      where f_id=:f_id and (f_good_type<>:f_good_type or f_good_type is null);
  end

  if ((f_name is not null) ) then
  begin
    update t_nsi_goods set f_name=:f_name
        where f_id=:f_id and f_name<>:f_name;
  end
  if (not exists(select f_id from t_nsi_goods_grp where f_id=:f_goods_grp)) then
  begin
      update t_nsi_goods set f_goods_grp=null
        where f_id=:f_id and f_goods_grp<>:f_goods_grp;
  end
  else
  begin
    update t_nsi_goods set f_goods_grp=:f_goods_grp
      where f_id=:f_id and coalesce(f_goods_grp,-1)<>:f_goods_grp;
  end
  if ((f_article is not null)  and (not exists(select 1 from t_reg_good where f_good = :f_id))) then
  begin
    UPDATE T_NSI_GOODS
    SET
      f_article = :f_article
    WHERE (F_ID = :F_ID) and f_article<>:f_article;
  end
  UPDATE T_NSI_GOODS
  SET
    f_dop_info = :f_dop_info
  WHERE (F_ID = :F_ID) and coalesce(f_dop_info,'')<>coalesce(:f_dop_info,'');
  if (f_ed_izm is not null) then
  begin
    UPDATE T_NSI_GOODS
    SET
      f_ed_izm = :f_ed_izm
    WHERE (F_ID = :F_ID) and f_ed_izm=:f_ed_izm;
  end
  UPDATE T_NSI_GOODS
    SET
      f_barter = :f_barter
    WHERE (F_ID = :F_ID) and :f_barter<>coalesce(f_barter,'0');
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_GOODS_XML (
    F_GOOD BIGINT)
RETURNS (
    F_VALUE VARCHAR(10000))
AS
begin
  f_value='<T_NSI_GOOD>';
  suspend;
  select
    '<f_id>'||f_id||'</f_id>'||
    '<f_barter>'||coalesce(f_barter,'0')||'</f_barter>'||
    '<f_name><![CDATA['||coalesce(f_name,'')||']]></f_name>'||
    '<f_article><![CDATA['||coalesce(f_article,'')||']]></f_article>'||
    '<f_dop_info><![CDATA['||coalesce(f_dop_info,'')||']]></f_dop_info>'||
    case
      when coalesce(f_partner,0)>0 then (select f_xml from sp_t_nsi_partner_get(f_partner))
      else ''
    end
  from sp_t_nsi_goods_get(:f_good,null)
  into :f_value;
  suspend;
  f_value='<T_NSI_SCANCODE>';
  suspend;
  for select '<scancode>'||f_value||'</scancode>' from SP_T_NSI_SCANCODE_GET(:f_good) into :f_value do
  begin
     suspend;
  end
  f_value='</T_NSI_SCANCODE>';
  suspend;
  f_value='</T_NSI_GOOD>';
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_NSI_MONEY_IN_TYPES
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_GET (
    F_MONEY_TYPE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN

  FOR SELECT F_ID,
             F_NAME,
             F_DESCR
      FROM T_NSI_MONEY_IN_TYPES
      where
        f_id=:f_money_type
      INTO :F_ID,
           :F_NAME,
           :F_DESCR
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  INSERT INTO T_NSI_MONEY_IN_TYPES (
    F_ID,
    F_NAME,
    F_DESCR)
  VALUES (
    :F_ID,
    :F_NAME,
    :F_DESCR);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_DESCR
      FROM T_NSI_MONEY_IN_TYPES
      INTO :F_ID,
           :F_NAME,
           :F_DESCR
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_MONEY_IN_TYPES_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_DESCR VARCHAR(10000))
AS
BEGIN
  UPDATE T_NSI_MONEY_IN_TYPES
  SET F_NAME = :F_NAME,
      F_DESCR = :F_DESCR
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_CARD_GET (
    P_PARTNER BIGINT,
    P_DATE DATE = 'now')
RETURNS (
    F_STR_DATE DATE,
    F_END_DATE DATE,
    F_DISCOUNT_TYPE BIGINT,
    F_DISCOUNT NUMERIC(15,3),
    F_MAX_DEB NUMERIC(15,3),
    F_PAY_DAY BIGINT,
    F_AVG_OUT NUMERIC(15,3),
    F_AVG_PAY NUMERIC(15,3),
    F_DEB_SUM NUMERIC(15,3))
AS
declare variable V_OUT_DOC_TYPE bigint;
declare variable V_CNT_AVG bigint;
begin
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('OUT_DOC_TYPE')
  into :V_OUT_DOC_TYPE;
  select PARAM_VALUE
  from SP_GET_SYS_PARAM('CNT_AVG')
  into :V_CNT_AVG;
  select P.F_STR_DATE, P.F_END_DATE, P.F_DISCOUNT_TYPE, P.F_DISCOUNT, P.F_PAY_DAY, P.F_MAX_DEB
  from T_NSI_PARTNER_CARD P
  where F_PARTNER = :P_PARTNER and
        F_STR_DATE <= :P_DATE and
        (F_END_DATE >= :P_DATE or f_end_date is null)
  into :F_STR_DATE, :F_END_DATE, :F_DISCOUNT_TYPE, :F_DISCOUNT, :F_PAY_DAY, :F_MAX_DEB;
  select F_END_OST
  from SP_T_REG_PARTNER_GET(:P_PARTNER, :P_DATE)
  into :F_DEB_SUM;
  select sum(F_DOC_SUM) / count(1)
  from (select first (:V_CNT_AVG) F_DOC_SUM
        from T_DOC_OUT
        where F_PARTNER = :P_PARTNER and
              F_STATE >= 3 and
              F_TYPE = :V_OUT_DOC_TYPE and
              F_DATE <= :P_DATE
        order by F_DATE)
  into :F_AVG_OUT;
  select sum(F_SUMMA) / count(1)
  from (select first (:V_CNT_AVG) F_SUMMA
        from T_MONEY_IN
        where F_PARTNER = :P_PARTNER and
              F_STATE >= 3 and
              F_DATE <= :P_DATE
        order by F_DATE)
  into :F_AVG_PAY;

  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_CARD_SET (
    P_PARTNER BIGINT,
    P_STR_DATE DATE,
    P_END_DATE DATE,
    P_DISCOUNT_TYPE BIGINT,
    P_DISCOUNT NUMERIC(15,3),
    P_PAY_DAY BIGINT,
    P_MAX_DEB NUMERIC(15,3))
AS
declare variable V_STR_DATE date;
begin
  V_STR_DATE=coalesce(p_str_date,'now');
  if (exists(select F_ID
             from T_NSI_PARTNER_CARD
             where F_PARTNER = :P_PARTNER and
                   F_STR_DATE <= :v_STR_DATE and
                   (F_END_DATE >= :v_STR_DATE or F_END_DATE is null))) then
  begin
    if (exists(select F_ID
               from T_NSI_PARTNER_CARD
               where F_PARTNER = :P_PARTNER and
                     F_STR_DATE <= :v_STR_DATE and
                     (F_END_DATE >= :v_STR_DATE or F_END_DATE is null) and
                     (coalesce(F_DISCOUNT_TYPE, 0) <> coalesce(:P_DISCOUNT_TYPE, 0) or coalesce(F_DISCOUNT, 0) <> coalesce(:P_DISCOUNT, 0) or coalesce(F_PAY_DAY, 0) <> coalesce(:P_PAY_DAY, 0) or coalesce(F_MAX_DEB, 0) <> coalesce(:P_MAX_DEB, 0)))) then
    begin
      update T_NSI_PARTNER_CARD
      set F_END_DATE = :v_STR_DATE - 1
      where F_PARTNER = :P_PARTNER and
            F_STR_DATE <= :v_STR_DATE and
            (F_END_DATE >= :P_STR_DATE or F_END_DATE is null);
      insert into T_NSI_PARTNER_CARD (F_PARTNER, F_STR_DATE, F_END_DATE, F_DISCOUNT_TYPE, F_DISCOUNT, F_PAY_DAY,
                                      F_MAX_DEB)
      values (:P_PARTNER, :v_STR_DATE, :P_END_DATE, :P_DISCOUNT_TYPE, :P_DISCOUNT, :P_PAY_DAY, :P_MAX_DEB);
    end
  end
  else
    insert into T_NSI_PARTNER_CARD (F_PARTNER, F_STR_DATE, F_END_DATE, F_DISCOUNT_TYPE, F_DISCOUNT, F_PAY_DAY,
                                    F_MAX_DEB)
    values (:P_PARTNER, :v_STR_DATE, :P_END_DATE, :P_DISCOUNT_TYPE, :P_DISCOUNT, :P_PAY_DAY, :P_MAX_DEB);

end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_D (
    F_ID BIGINT)
AS
BEGIN
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_NSI_PARTNER') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
  update T_NSI_PARTNER set f_state=-1
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_GET (
    NSI_ID INTEGER)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20),
    F_BANK VARCHAR(255),
    F_BANK_RSCH VARCHAR(20),
    F_BANK_BIK VARCHAR(20),
    F_BANK_KSCH VARCHAR(20),
    F_BANK_ADRES VARCHAR(255),
    F_XML VARCHAR(10000))
AS
declare variable F_BANK_XML varchar(10000);
begin
  /* Procedure Text */
  if (nsi_id=-10) then
  begin
    f_id=GEN_ID(GEN_t_nsi_partner_ID,1);
    execute procedure sp_t_nsi_partner_i(:f_id,null,null,null,null,null);
  end
  else
  begin
    SELECT F_ID,
           F_NAME,
           F_U_NAME,
           F_U_ADDRES,
           F_INN,
           F_KPP
    FROM T_NSI_PARTNER
    where
        f_id=:nsi_id
    INTO :F_ID,
         :F_NAME,
         :F_U_NAME,
         :F_U_ADDRES,
         :F_INN,
         :F_KPP;
    select first 1

      F_R_SCH,
      f_bank_name,
      F_BANK_ADRES,
      F_BANK_K_SCH,
      f_bank_bik,
      f_xml
      from sp_t_partner_bank_s(:f_id)
    into
      :f_bank_rsch,
      :f_bank,
      :f_bank_adres,
      :f_bank_ksch,
      :f_bank_bik,
      :f_bank_xml;
  end
  f_xml='<T_NSI_PARTNER><f_id>'||f_id||'</f_id>'||
    '<f_name><![CDATA['||coalesce(f_name,'')||']]></f_name>'||
    '<f_u_name><![CDATA['||coalesce(f_u_name,'')||']]></f_u_name>'||
    '<f_inn>'||coalesce(f_inn,'')||'</f_inn>'||
    '<f_kpp>'||coalesce(f_kpp,'')||'</f_kpp>'||
    coalesce(f_bank_xml,'')||
    '</T_NSI_PARTNER>';
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20))
AS
BEGIN
  INSERT INTO T_NSI_PARTNER (
    F_ID,
    F_NAME,
    F_U_NAME,
    F_U_ADDRES,
    F_INN,
    F_KPP)
  VALUES (
    :F_ID,
    :F_NAME,
    :F_U_NAME,
    :F_U_ADDRES,
    :F_INN,
    :F_KPP);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_NSI_PARTNER_INFO
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_GET (
    F_PARTNER BIGINT,
    F_INFO_NAME BIGINT)
RETURNS (
    F_RESULT VARCHAR(255))
AS
DECLARE VARIABLE V_RESULT VARCHAR(60) CHARACTER SET WIN1251;
begin
  /* Procedure Text */
    FOR SELECT

             F_VALUE||';'
      FROM T_NSI_PARTNER_iNFO
      where
           f_partner=:f_partner
           and f_info_name=:f_info_name
      INTO :v_result
  DO
  BEGIN
    f_result=coalesce(f_result, '')||coalesce(v_result,'');
  END
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_I (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_INFO_NAME BIGINT,
    F_VALUE VARCHAR(100))
AS
BEGIN
  INSERT INTO T_NSI_PARTNER_INFO (
    F_ID,
    F_PARTNER,
    F_INFO_NAME,
    F_VALUE)
  VALUES (
    :F_ID,
    :F_PARTNER,
    :F_INFO_NAME,
    :F_VALUE);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_S (
    PARTNER_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_INFO VARCHAR(60),
    F_INFO_NAME BIGINT,
    F_VALUE VARCHAR(100))
AS
BEGIN
  FOR SELECT F_ID,
             F_PARTNER,
             F_INFO_NAME,
             F_VALUE
      FROM T_NSI_PARTNER_iNFO
      where
           f_partner=:partner_id
      INTO :F_ID,
           :F_PARTNER,
           :F_INFO_NAME,
           :F_VALUE
  DO
  BEGIN
    select f_name from t_nsi_info_name where f_id=:f_info_name into :f_info;
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_INFO_U (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_INFO_NAME BIGINT,
    F_VALUE VARCHAR(100))
AS
BEGIN
  UPDATE T_NSI_PARTNER_INFO
  SET --F_PARTNER = :F_PARTNER,
      F_VALUE = :F_VALUE
  WHERE (F_ID = :F_ID) and f_value<>:f_value;
  UPDATE T_NSI_PARTNER_INFO
  SET --F_PARTNER = :F_PARTNER,
      F_INFO_NAME = :F_INFO_NAME
  WHERE (F_ID = :F_ID) and f_info_name<>:f_info_name;
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20))
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_U_NAME,
             F_U_ADDRES,
             F_INN,
             F_KPP
      FROM T_NSI_PARTNER
      where
        f_state =1
      INTO :F_ID,
           :F_NAME,
           :F_U_NAME,
           :F_U_ADDRES,
           :F_INN,
           :F_KPP
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTNER_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_U_NAME VARCHAR(255),
    F_U_ADDRES VARCHAR(255),
    F_INN VARCHAR(20),
    F_KPP VARCHAR(20))
AS
BEGIN
  UPDATE T_NSI_PARTNER
  SET F_NAME = :F_NAME,
      F_U_NAME = :F_U_NAME,
      F_U_ADDRES = :F_U_ADDRES,
      F_INN = :F_INN,
      F_KPP = :F_KPP
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PARTY_SET (
    P_GOOD BIGINT,
    P_DATE DATE,
    P_CNT NUMERIC(15,3),
    P_PRICE NUMERIC(15,3),
    P_SKLAD BIGINT)
AS
declare variable V_PARTY bigint;
begin
  V_PARTY = 0;
  select F_ID
  from T_NSI_GOOD_PARTY
  where F_GOOD = :P_GOOD and
        F_DATE = :P_DATE
  into :V_PARTY;
  if (V_PARTY > 0) then
  begin
    update T_NSI_GOOD_PARTY
    set F_CNT = :P_CNT
    where F_ID = :V_PARTY;
  end
  else
  begin
    V_PARTY = gen_id(GEN_T_NSI_GOOD_PARTY_ID, 1);
    insert into T_NSI_GOOD_PARTY (F_ID, F_GOOD, F_DATE, F_CNT, F_PRICE)
    values (:V_PARTY, :P_GOOD, :P_DATE, :P_CNT, :P_PRICE);
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_D (
    F_ID BIGINT)
AS
BEGIN
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_NSI_PRICE') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
  update T_NSI_PRICE set f_state=-1
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_GET (
    PRICE_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3),
    F_PARENT_OBJECT BIGINT,
    F_SAVE_RESULT SMALLINT)
AS
BEGIN
  if (price_id=-10) then
  begin
    price_id=GEN_ID(GEN_t_nsi_price_ID,1);
    EXECUTE PROCEDURE SP_T_NSI_PRICE_I(price_id, ' ', 4, '0', 0.01);
  end
  FOR SELECT F_ID,
             F_NAME,
             f_formula,
             f_round,
             f_parent_object,
             f_save_result
      FROM T_NSI_PRICE
      where
        f_id=:price_id
      INTO :F_ID,
           :F_NAME,
           :f_formula,
           :f_round,
           :f_parent_object,
           :f_save_result
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT_OBJECT BIGINT,
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3))
AS
BEGIN
  INSERT INTO T_NSI_PRICE (
    F_ID,
    F_NAME,
    F_PARENT_OBJECT,
    F_FORMULA,
    f_round)
  VALUES (
    :F_ID,
    :F_NAME,
    :F_PARENT_OBJECT,
    :F_FORMULA,
    :f_round);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT_OBJECT BIGINT,
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3),
    F_SAVE_RESULT SMALLINT)
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             case
               when :f_save_result=1 then null
                else F_PARENT_OBJECT
             end as F_PARENT_OBJECT
                ,
             case
               when :f_save_result=1 then null
               else F_FORMULA
             end as
             F_FORMULA,
             F_ROUND,
             f_save_result
      FROM T_NSI_PRICE
      where f_state=1
      INTO :F_ID,
           :F_NAME,
           :F_PARENT_OBJECT,
           :F_FORMULA,
           :F_ROUND,
           :f_save_result
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_D (
    F_ID BIGINT)
AS
begin
  delete from t_nsi_price_str
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_I (
    F_ID BIGINT,
    F_NSI_PRICE BIGINT,
    F_START_LINE FLOAT,
    F_END_LINE FLOAT,
    F_FORMULA FLOAT,
    F_ROUND FLOAT)
AS
begin
  insert into t_nsi_price_str (
    f_id,
    f_nsi_price,
    f_start_line,
    f_end_line,
    f_formula,
    f_round)
  values (
    :f_id,
    :f_nsi_price,
    :f_start_line,
    :f_end_line,
    :f_formula,
    :f_round);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_S (
    P_NSI_PRICE BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NSI_PRICE BIGINT,
    F_START_LINE FLOAT,
    F_END_LINE FLOAT,
    F_FORMULA FLOAT,
    F_ROUND FLOAT)
AS
begin
  for select f_id,
             f_nsi_price,
             f_start_line,
             f_end_line,
             f_formula,
             f_round
      from t_nsi_price_str
      where
        f_nsi_price=:p_nsi_price
      into :f_id,
           :f_nsi_price,
           :f_start_line,
           :f_end_line,
           :f_formula,
           :f_round
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_STR_U (
    F_ID BIGINT,
    F_NSI_PRICE BIGINT,
    F_START_LINE FLOAT,
    F_END_LINE FLOAT,
    F_FORMULA FLOAT,
    F_ROUND FLOAT)
AS
begin
  update t_nsi_price_str
  set f_nsi_price = :f_nsi_price,
      f_start_line = :f_start_line,
      f_end_line = :f_end_line,
      f_formula = :f_formula,
      f_round = :f_round
  where (f_id = :f_id);
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_PRICE_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT_OBJECT BIGINT,
    F_FORMULA VARCHAR(255),
    F_ROUND NUMERIC(15,3),
    F_SAVE_RESULT SMALLINT)
AS
BEGIN
  UPDATE T_NSI_PRICE
  SET F_NAME = :F_NAME,
      F_PARENT_OBJECT = :F_PARENT_OBJECT,
      F_FORMULA = :F_FORMULA,
      f_round = :f_round,
      f_save_result=:f_save_result
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_NSI_SCANCODE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_GET (
    F_GOOD_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  FOR SELECT F_ID,
             F_VALUE,
             F_GOOD,
             F_COUNT
      FROM T_NSI_SCANCODE
      where
        f_good=:f_good_id
      INTO :F_ID,
           :F_VALUE,
           :F_GOOD,
           :F_COUNT
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_GET_ALL_STR (
    F_GOOD BIGINT)
RETURNS (
    F_RESULT VARCHAR(255))
AS
declare variable F_VALUE varchar(60);
begin
  f_result='';
  FOR SELECT F_VALUE
      FROM T_NSI_SCANCODE
      where
        f_good=:f_good
      INTO :F_VALUE
  DO
  BEGIN
    if (F_VALUE is not null) then
        f_result=f_result||iif(f_result<>'','; ','')||f_value;
  END
  SUSPEND;
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_I (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  INSERT INTO T_NSI_SCANCODE (
    F_ID,
    F_VALUE,
    F_GOOD,
    F_COUNT)
  VALUES (
    :F_ID,
    :F_VALUE,
    :F_GOOD,
    :F_COUNT);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_S (
    F_SCANCODE VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  FOR SELECT F_ID,
             F_VALUE,
             F_GOOD,
             F_COUNT
      FROM T_NSI_SCANCODE
      where
        f_value=:f_scancode
      INTO :F_ID,
           :F_VALUE,
           :F_GOOD,
           :F_COUNT
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_S_BY_GOOD (
    F_IN_GOOD VARCHAR(60))
RETURNS (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  FOR SELECT F_ID,
             F_VALUE,
             F_GOOD,
             F_COUNT
      FROM T_NSI_SCANCODE
      where
        f_good=:F_in_good
      INTO :F_ID,
           :F_VALUE,
           :F_GOOD,
           :F_COUNT
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SCANCODE_U (
    F_ID BIGINT,
    F_VALUE VARCHAR(60),
    F_GOOD BIGINT,
    F_COUNT FLOAT)
AS
BEGIN
  UPDATE T_NSI_SCANCODE
  SET F_VALUE = :F_VALUE,
      F_GOOD = :F_GOOD,
      F_COUNT = :F_COUNT
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_D (
    F_ID BIGINT)
AS
BEGIN
  if (not exists(select * from SP_CHECK_SYS_PRIVS('T_NSI_SKLAD') where f_result='DEL') ) then
    EXECUTE PROCEDURE PR_EXEC_EXCEPTION(3);
  update T_NSI_SKLAD set f_state=-1
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_GET (
    SKLAD_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER BIGINT,
    F_PARTNER_NAME VARCHAR(60),
    F_PARTNER_INN VARCHAR(20),
    F_PARTNER_KPP VARCHAR(20),
    F_PARTNER_ADRES VARCHAR(255),
    F_PARTNER_BANK VARCHAR(255),
    F_PARTNER_BANK_ADRES VARCHAR(255),
    F_PARTNER_BANK_RSCH VARCHAR(20),
    F_PARTNER_BANK_KSCH VARCHAR(20),
    F_PARTNER_BANK_BIK VARCHAR(20),
    F_XML VARCHAR(10000),
    F_PRICE_IN BIGINT,
    F_PRICE_OUT BIGINT,
    F_PRICE_IN_NAME VARCHAR(60),
    F_PRICE_OUT_NAME VARCHAR(60),
    F_PARTNER_ROZN BIGINT,
    F_PARTNER_ROZN_NAME VARCHAR(255),
    F_PREFIX VARCHAR(2))
AS
declare variable F_PARTNER_XML varchar(10000);
begin
  if (SKLAD_ID = -10) then
  begin
    F_ID = gen_id(GEN_T_NSI_SKLAD_ID, 1);
    execute procedure SP_T_NSI_SKLAD_I(:F_ID, :F_NAME, :F_ADDRES, :F_PARTNER);
    if (not F_PARTNER is null) then
      select F_XML
      from SP_T_NSI_PARTNER_GET(:F_PARTNER) P
      into :F_PARTNER_XML;
    else
      F_PARTNER_XML = '';
    F_XML = '<T_NSI_SKLAD>' || '<f_id>' || F_ID || '</f_id>' || '<f_name><![CDATA[' || coalesce(F_NAME, '') || ']]></f_name>' || '<f_addres><![CDATA[' || coalesce(F_ADDRES, '') || ']]></f_addres>' || F_PARTNER_XML || '</T_NSI_SKLAD>';
    suspend;
  end
  else
  begin
    for select F_ID, F_NAME, F_ADDRES, F_PRICE_IN, F_PRICE_OUT,
               (select F_NAME
                from T_NSI_PRICE
                where F_ID = F_PRICE_IN),
               (select F_NAME
                from T_NSI_PRICE
                where F_ID = F_PRICE_OUT), F_PARTNER, F_PARTNER_ROZN,
               (select F_NAME
                from T_NSI_PARTNER
                where F_ID = F_PARTNER_ROZN), F_PREFIX
        from T_NSI_SKLAD
        where F_ID = :SKLAD_ID
        into :F_ID, :F_NAME, :F_ADDRES, :F_PRICE_IN, :F_PRICE_OUT, :F_PRICE_IN_NAME, :F_PRICE_OUT_NAME, :F_PARTNER,
             :F_PARTNER_ROZN, :F_PARTNER_ROZN_NAME, :F_PREFIX
    do
    begin
      if (not F_PARTNER is null) then
        select F_XML, F_NAME, F_INN, F_KPP, F_BANK, F_BANK_RSCH, F_BANK_BIK, F_BANK_KSCH, f_U_addres

        from SP_T_NSI_PARTNER_GET(:F_PARTNER) P
        into :F_PARTNER_XML, :F_PARTNER_NAME, :F_PARTNER_INN, :F_PARTNER_KPP, :F_PARTNER_BANK, :F_PARTNER_BANK_RSCH,
             :F_PARTNER_BANK_BIK, :F_PARTNER_BANK_KSCH, :f_partner_adres;
      else
        F_PARTNER_XML = '';
      F_XML = '<T_NSI_SKLAD>' || '<f_id>' || F_ID || '</f_id>' || '<f_name><![CDATA[' || coalesce(F_NAME, '') || ']]></f_name>' || '<f_addres><![CDATA[' || coalesce(F_ADDRES, '') || ']]></f_addres>' || F_PARTNER_XML || '</T_NSI_SKLAD>';
      suspend;
    end
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER BIGINT)
AS
BEGIN
  INSERT INTO T_NSI_SKLAD (
    F_ID,
    F_NAME,
    F_ADDRES,
    F_Partner)
  VALUES (
    :F_ID,
    :F_NAME,
    :F_ADDRES,
    :f_partner);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER_ROZN BIGINT,
    F_PREFIX VARCHAR(2),
    F_DEBET NUMERIC(15,3),
    F_CREDET NUMERIC(15,3))
AS
declare variable V_SUM numeric(15,3);
begin
  for select F_ID, F_NAME, F_ADDRES, F_PARTNER_ROZN, F_PREFIX
      from T_NSI_SKLAD
      where F_STATE = 1
      into :F_ID, :F_NAME, :F_ADDRES, :F_PARTNER_ROZN, :F_PREFIX
  do
  begin
    select F_END_OST
    from SP_T_REG_PARTNER_GET(:F_PARTNER_ROZN, 'now')
    into :V_SUM;
    if (V_SUM < 0) then
    begin
      F_DEBET = V_SUM * -1;
      F_CREDET = 0;
    end
    else
    begin
      F_CREDET = V_SUM;
      F_DEBET = 0;
    end
    suspend;
    V_SUM = 0;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_NSI_SKLAD_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_ADDRES VARCHAR(255),
    F_PARTNER BIGINT,
    F_PRICE_IN BIGINT,
    F_PRICE_OUT BIGINT,
    F_PARTNER_ROZN BIGINT,
    F_PREFIX VARCHAR(2) = '')
AS
BEGIN
  UPDATE T_NSI_SKLAD
  SET F_NAME = coalesce(:F_NAME,f_name),
      F_ADDRES = coalesce(:F_ADDRES,f_addres),
      F_PARTNER = coalesce(:f_partner,f_partner),
      f_price_in = coalesce(:f_price_in,f_price_in),
      f_price_out = coalesce(:f_price_out,f_price_out),
      f_partner_rozn = coalesce(:f_partner_rozn,f_partner_rozn),
      f_prefix = coalesce(:f_prefix,f_prefix)
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_NSI_STATE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_GET (
    STATE_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_PARENT
      FROM T_NSI_STATE
      where
        f_id=:state_id
      INTO :F_ID,
           :F_NAME,
           :F_PARENT
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_I (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  INSERT INTO T_NSI_STATE (
    F_ID,
    F_NAME,
    F_PARENT)
  VALUES (
    :F_ID,
    :F_NAME,
    :F_PARENT);
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_S
RETURNS (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  FOR SELECT F_ID,
             F_NAME,
             F_PARENT
      FROM T_NSI_STATE
      where f_id>0
      INTO :F_ID,
           :F_NAME,
           :F_PARENT
  DO
  BEGIN
    SUSPEND;
  END
END^


CREATE OR ALTER PROCEDURE SP_T_NSI_STATE_U (
    F_ID BIGINT,
    F_NAME VARCHAR(60),
    F_PARENT BIGINT)
AS
BEGIN
  UPDATE T_NSI_STATE
  SET F_NAME = :F_NAME,
      F_PARENT = :F_PARENT
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_PARTNER_BANK
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_I (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_R_SCH VARCHAR(60))
AS
BEGIN
  INSERT INTO T_PARTNER_BANK (
    F_ID,
    F_PARTNER,
    F_BANK,
    F_R_SCH)
  VALUES (
    :F_ID,
    :F_PARTNER,
    :F_BANK,
    :F_R_SCH);
END^


CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_S (
    F_PARTNER_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_BANK_NAME VARCHAR(60),
    F_BANK_KPP VARCHAR(20),
    F_BANK_INN VARCHAR(20),
    F_BANK_ADRES VARCHAR(255),
    F_BANK_K_SCH VARCHAR(60),
    F_R_SCH VARCHAR(60),
    F_BANK_BIK VARCHAR(20),
    F_XML VARCHAR(10000))
AS
DECLARE VARIABLE F_BANK_XML VARCHAR(10000) CHARACTER SET WIN1251;
BEGIN
    FOR
      select
        b.f_id,
        b.f_bank,
        b.f_r_sch
      from
        t_partner_bank b
      where
        b.f_partner=:f_partner_id
      into
        :f_id,
        :f_bank,
        :f_r_sch
    DO
    BEGIN
      if (f_id>0) then
      begin
        SELECT
          F_NAME,
          F_U_ADDRES,
          F_INN,
          F_KPP,
          F_K_SCH,
          f_bik,
          f_xml
        FROM sp_t_nsi_bank_get(:f_bank)
        INTO
          :F_BANK_NAME,
          :F_BANK_ADRES,
          :F_BANK_INN,
          :F_BANK_KPP,
          :F_BANK_K_SCH,
          :F_BANK_BIK,
          :f_bank_xml;
      end
      else
      begin
        F_BANK_NAME=null;
        F_BANK_ADRES=null;
        F_BANK_INN=null;
        F_BANK_KPP=null;
        F_BANK_K_SCH=null;
        f_bank_xml=null;
      end
      f_xml='<T_PARTNER_BANK>'||
        '<f_r_sch>'||coalesce(f_r_sch,'')||'</f_r_sch>'||
        coalesce(f_bank_xml,'')||
        '</T_PARTNER_BANK>';
      SUSPEND;
    END
END^


CREATE OR ALTER PROCEDURE SP_T_PARTNER_BANK_U (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_BANK BIGINT,
    F_R_SCH VARCHAR(60))
AS
BEGIN
  UPDATE T_PARTNER_BANK
  SET F_PARTNER = :F_PARTNER,
      F_BANK = :F_BANK,
      F_R_SCH = :F_R_SCH
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_PARTNER_DISCOUNT_D (
    F_ID BIGINT)
AS
begin
  delete from t_nsi_partner_discount_card where f_id=:f_id;
end^


CREATE OR ALTER PROCEDURE SP_T_PARTNER_DISCOUNT_I (
    F_ID BIGINT,
    F_PARTNER BIGINT,
    F_DISCOUNT BIGINT)
AS
begin
  INSERT INTO t_nsi_partner_discount_card (
    F_ID,
    F_PARTNER,
    F_DISCOUNT)
  VALUES (
    :F_ID,
    :F_PARTNER,
    :F_DISCOUNT);
end^


CREATE OR ALTER PROCEDURE SP_T_PARTNER_DISCOUNT_S (
    P_PARTNER BIGINT)
RETURNS (
    F_ID BIGINT,
    F_DISCOUNT_ID BIGINT,
    F_NUMBER VARCHAR(60),
    F_DISCOUNT NUMERIC(15,3),
    F_PARTNER BIGINT)
AS
begin
 for select f_id,f_partner,f_discount from t_nsi_partner_discount_card where f_partner=:p_partner into :f_id,:f_partner,:f_discount_id do
 begin
   select f_number, f_discount from SP_T_NSI_DISCOUNT_CARD_GET(:f_discount_id) into
     :f_number,:f_discount;
   suspend;
 end
end^


CREATE OR ALTER PROCEDURE SP_T_PRICE_CALC (
    F_PRICE_ID BIGINT,
    F_GOOD_ID BIGINT,
    F_DATE DATE = current_date)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_MAKE_DATE TIMESTAMP,
    F_VALUE FLOAT)
AS
declare variable F_SAVE_RES smallint;
declare variable F_PARENT_PRICE bigint;
begin
  /* Procedure Text */
  if (exists(select F_ID
             from T_NSI_PRICE
             where F_ID = :F_PRICE_ID)) then
  begin
    select F_SAVE_RESULT, F_PARENT_OBJECT
    from SP_T_NSI_PRICE_GET(:F_PRICE_ID)
    into :F_SAVE_RES, :F_PARENT_PRICE;
  end
  else
    exit;


  if (F_SAVE_RES = 1) then
  begin
    select first 1 P.F_ID, P.F_GOOD, P.F_PRICE, P.F_STR_DATE, P.F_MAKE_DATE, P.F_VALUE
    from T_PRICE P
    where P.F_GOOD = :F_GOOD_ID and
          P.F_PRICE = :F_PRICE_ID and
          P.F_STR_DATE <= :F_DATE and
          P.F_ACTIVE = 1
    into :F_ID, :F_GOOD, :F_PRICE, :F_STR_DATE, :F_MAKE_DATE, :F_VALUE;
    if (F_ID is null) then
    begin
      select first 1 P.F_ID, P.F_GOOD, P.F_PRICE, P.F_STR_DATE, P.F_MAKE_DATE, P.F_VALUE
      from T_PRICE P
      where P.F_GOOD = :F_GOOD_ID and
            P.F_PRICE = :F_PRICE_ID and
            P.F_STR_DATE = (select max(F_STR_DATE)
                            from T_PRICE
                            where F_STR_DATE <= :F_DATE and
                                  F_GOOD = :F_GOOD_ID and
                                  F_PRICE = :F_PRICE_ID)
      into :F_ID, :F_GOOD, :F_PRICE, :F_STR_DATE, :F_MAKE_DATE, :F_VALUE;

    end
  end
  else
  begin
    select P.F_GOOD, P.F_VALUE
           /*(select f_result from sp_round((p.f_value+p.f_value*:f_formula/100),:f_round))*/
    from SP_T_PRICE_calc(:F_PARENT_PRICE, :F_GOOD_ID) P
    into :F_GOOD, :F_VALUE;
    select (select F_RESULT
            from SP_ROUND((:F_VALUE + :F_VALUE * F_FORMULA / 100), F_ROUND))
    from SP_T_NSI_PRICE_STR_S(:F_PRICE_ID)
    where :F_VALUE between F_START_LINE and F_END_LINE
    into :F_VALUE;
  end
  suspend;
end^


CREATE OR ALTER PROCEDURE SP_T_PRICE_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_PRICE
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_PRICE_GET (
    F_PRICE_ID BIGINT,
    F_GOOD_ID BIGINT,
    F_DATE DATE = current_date)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_MAKE_DATE TIMESTAMP,
    F_VALUE FLOAT)
AS
begin
  /* Procedure Text */
  if (not exists(select F_ID
                 from T_NSI_PRICE
                 where F_ID = :F_PRICE_ID)) then
    exit;

/*  if (F_DATE = current_date) then
  begin
    select F_ID, F_GOOD, F_PRICE, F_STR_DATE, F_MAKE_DATE, F_VALUE
    from T_CURR_PRICE
    where F_GOOD = :F_GOOD_ID and
          F_PRICE = :F_PRICE_ID
    into :F_ID, :F_GOOD, :F_PRICE, :F_STR_DATE, :F_MAKE_DATE, :F_VALUE;
    suspend;
  end
  else
  begin*/
    select F_ID, F_GOOD, F_PRICE, F_STR_DATE, F_MAKE_DATE, F_VALUE
    from SP_T_PRICE_CALC(:F_PRICE_ID, :F_GOOD_ID, :F_DATE)
    into :F_ID, :F_GOOD, :F_PRICE, :F_STR_DATE, :F_MAKE_DATE, :F_VALUE;
    suspend;
--  end

end^


CREATE OR ALTER PROCEDURE SP_T_PRICE_I (
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_VALUE FLOAT,
    F_SOURCE BIGINT = NULL,
    F_ACTIVE SMALLINT = 1)
AS
BEGIN
  INSERT INTO T_PRICE (
    F_GOOD,
    F_PRICE,
    F_STR_DATE,
    F_VALUE,
    f_source,
    f_active)
  VALUES (
    :F_GOOD,
    :F_PRICE,
    :F_STR_DATE,
    :f_value,
    :f_source,
    :f_active);
END^


CREATE OR ALTER PROCEDURE SP_T_PRICE_S (
    F_PRICE_ID BIGINT)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_STR_DATE DATE,
    F_MAKE_DATE TIMESTAMP,
    F_GOOD_NAME VARCHAR(255),
    F_VALUE FLOAT,
    F_DEFAULT_SKLAD_OST NUMERIC(15,3),
    F_ARTICLE VARCHAR(20))
AS
declare variable F_DEFAULT_SCLAD bigint;
declare variable F_SAVE_RES smallint;
declare variable F_PARENT_PRICE bigint;
declare variable F_ROUND numeric(15,3);
declare variable F_FORMULA numeric(15,3);
BEGIN
  select param_value from SP_GET_SYS_PARAM('DEFAULT_SKLAD') into :f_default_sclad;
  select f_save_result,f_parent_object,f_round,f_formula
  from
    sp_t_nsi_price_get(:f_price_id)
  into
    :f_save_res,:f_parent_price,:f_round,:f_formula;

/*    FOR SELECT p.F_ID,
               g.f_name,
               g.f_article,
               p.F_GOOD,
               p.F_PRICE,
               p.F_STR_DATE,
               p.F_MAKE_DATE,
               p.f_value
        FROM
          T_curr_PRICE p
          inner join t_nsi_goods g on p.f_good=g.f_id
        where
          f_price=:f_price_id
        INTO :F_ID,
             :f_good_name,
             :f_article,
             :F_GOOD,
             :F_PRICE,
             :F_STR_DATE,
             :F_MAKE_DATE,
             :f_value
    DO
    BEGIN
--      select f_name,f_article from sp_t_nsi_goods_get(coalesce(:f_good,0),null) into :f_good_name,:f_article;
--    select f_move_out from sp_t_reg_good_get(:f_good,'now',:f_default_sclad) into :f_default_sklad_ost;
      SUSPEND;
    END */


  if (f_save_res=1) then
  begin
    FOR SELECT p.F_ID,
               g.f_name,
               g.f_article,
               p.F_GOOD,
               p.F_PRICE,
               p.F_STR_DATE,
               p.F_MAKE_DATE,
               p.f_value
        FROM
          T_PRICE p
          inner join t_nsi_goods g on p.f_good=g.f_id
        where
          f_price=:f_price_id
          and f_active=1
        INTO :F_ID,
             :f_good_name,
             :f_article,
             :F_GOOD,
             :F_PRICE,
             :F_STR_DATE,
             :F_MAKE_DATE,
             :f_value
    DO
    BEGIN
--      select f_name,f_article from sp_t_nsi_goods_get(coalesce(:f_good,0),null) into :f_good_name,:f_article;
--    select f_move_out from sp_t_reg_good_get(:f_good,'now',:f_default_sclad) into :f_default_sklad_ost;
      SUSPEND;
    END
  end
  else
  begin
    for select
        null,
        F_GOOD,
        F_PRICE,
        F_STR_DATE,
        F_MAKE_DATE,
        --(select f_result from sp_round((p.f_value+p.f_value*:f_formula/100),:f_round)),
        f_good_name,
        f_article
      from
        sp_t_price_s(:f_parent_price) p
      into
        :F_ID,
        :F_GOOD,
        :F_PRICE,
        :F_STR_DATE,
        :F_MAKE_DATE,
        --:f_value,
        :f_good_name,
        :f_article
    do
    begin
      select f_value from SP_T_PRICE_GET(:f_price_id,:f_good) into :f_value;
      suspend;
    end
  end
END^


CREATE OR ALTER PROCEDURE SP_T_PRICE_SET (
    P_GOOD BIGINT,
    P_PRICE BIGINT,
    P_DATE DATE,
    P_VALUE NUMERIC(15,3))
AS
declare variable F_CHLD_PRICE bigint;
declare variable F_CHLD_VAL numeric(15,3);
declare variable F_SAVE_RESULT integer;
declare variable F_VAL numeric(15,3);
declare variable F_ID bigint;
begin
  select F_SAVE_RESULT
  from T_NSI_PRICE
  where F_ID = :P_PRICE
  into :F_SAVE_RESULT;
  if (F_SAVE_RESULT = 1) then
  begin
    F_VAL = P_VALUE;
    update T_PRICE
    set F_ACTIVE = 0
    where F_PRICE = :P_PRICE and
          F_GOOD = :P_GOOD and
          F_STR_DATE <= :P_DATE;
    insert into T_PRICE (F_PRICE, F_GOOD, F_STR_DATE, F_VALUE, F_ACTIVE)
    values (:P_PRICE, :P_GOOD, :P_DATE, :P_VALUE, 1);
  end
  else
  begin
    select F_VALUE
    from SP_T_PRICE_CALC(:P_PRICE, :P_GOOD)
    into :F_VAL;
  end
  F_ID = 0;
  select F_ID
  from T_CURR_PRICE
  where F_GOOD = :P_GOOD and
        F_PRICE = :P_PRICE and
        F_VALUE = :F_VAL
  into :F_ID;
  if (coalesce(F_ID, 0) = 0) then
  begin
    delete from T_CURR_PRICE
    where F_GOOD = :P_GOOD and
          F_PRICE = :P_PRICE;
    insert into T_CURR_PRICE (F_GOOD, F_PRICE, F_STR_DATE, F_VALUE)
    values (:P_GOOD, :P_PRICE, :P_DATE, :F_VAL);
  end
  else
  begin
    update T_CURR_PRICE
    set F_STR_DATE = :P_DATE
    where F_ID = :F_ID;
  end
  for select F_ID
      from T_NSI_PRICE P
      where P.F_PARENT_OBJECT = :P_PRICE
      into :F_CHLD_PRICE
  do
  begin
    select F_VALUE
    from SP_T_PRICE_CALC(:F_CHLD_PRICE, :P_GOOD)
    into :F_CHLD_VAL;
    execute procedure SP_T_PRICE_SET(:P_GOOD, :F_CHLD_PRICE, :P_DATE, :F_CHLD_VAL);
  end
end^


CREATE OR ALTER PROCEDURE SP_T_PRICE_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_PRICE BIGINT,
    F_VALUE FLOAT,
    F_STR_DATE DATE = 'now')
AS
BEGIN
  UPDATE T_PRICE
  SET F_GOOD = :F_GOOD,
      F_PRICE = :F_PRICE,
      F_STR_DATE = :F_STR_DATE,
      f_value = :f_value
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_D (
    F_ID BIGINT)
AS
BEGIN
  DELETE FROM T_REG_GOOD
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_GET (
    F_GOOD BIGINT,
    F_DATE DATE,
    F_SKLAD BIGINT)
RETURNS (
    F_START_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT,
    F_END_OST FLOAT)
AS
declare variable V_DATE date;
begin
  if (F_DATE <> current_date) then
  begin
    select max(F_DATE) as F_DATE
    from T_REG_GOOD
    where F_GOOD = :F_GOOD and
          F_DATE <= :F_DATE and
          F_SKLAD = :F_SKLAD
    into :V_DATE;
    select sum(
           case
             when R.F_DATE = :F_DATE then R.F_STR_OST
             else R.F_END_OST
           end) as F_STR_OST,
           sum(
           case
             when R.F_DATE = :F_DATE then R.F_MOVE_IN
             else 0
           end) as F_MOVE_IN,
           sum(
           case
             when R.F_DATE = :F_DATE then R.F_MOVE_OUT
             else 0
           end) as F_MOVE_OUT,

           sum(R.F_END_OST)

    from T_REG_GOOD as R --on D.F_SKLAD = R.F_SKLAD and D.F_DATE = R.F_DATE
    where R.F_GOOD = :F_GOOD and
          R.F_DATE = :V_DATE and
          R.F_SKLAD = :F_SKLAD
    into :F_START_OST, :F_MOVE_IN, :F_MOVE_OUT, :F_END_OST;
    suspend;
  end
  else
  begin
    select F_DATE, F_END_OST
    from T_OST
    where F_GOOD = :F_GOOD and
          F_SKLAD = :F_SKLAD
    into :V_DATE, :F_END_OST;
    if (V_DATE <> F_DATE) then
    begin
      select R.F_STR_OST, R.F_MOVE_IN, R.F_MOVE_OUT, R.F_END_OST
      from T_REG_GOOD as R
      where R.F_GOOD = :F_GOOD and
            R.F_SKLAD = :F_SKLAD and
            R.F_DATE = :V_DATE
      into :F_START_OST, :F_MOVE_IN, :F_MOVE_OUT, :F_END_OST;
    end
    else
    begin
      F_START_OST = F_END_OST;
      F_MOVE_IN = 0;
      F_MOVE_OUT = 0;
    end
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_I (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT)
AS
BEGIN
  INSERT INTO T_REG_GOOD (
    F_ID,
    F_GOOD,
    F_SKLAD,
    F_DATE,
    F_STR_OST,
    F_MOVE_IN,
    F_MOVE_OUT)
  VALUES (
    :F_ID,
    :F_GOOD,
    :F_SKLAD,
    :F_DATE,
    :F_STR_OST,
    :F_MOVE_IN,
    :F_MOVE_OUT);
END^


CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_REFRESH (
    F_GOOD_IN BIGINT,
    F_SKLAD_IN BIGINT,
    F_PRICE BIGINT,
    F_DATE_IN DATE = current_date)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT,
    F_END_OST FLOAT,
    F_GOOD_GRP BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_GRP_NAME VARCHAR(60),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_PRICE_VAL NUMERIC(15,3))
AS
declare variable V_PRICE bigint;
declare variable V_DATE date;
begin
  if (exists(select F_ID
             from T_NSI_PRICE
             where F_ID = :F_PRICE)) then
    V_PRICE = F_PRICE;
  else
    V_PRICE = 0;

  if (current_date > F_DATE_IN) then
  begin
    for select G.F_GOOD, G.F_SKLAD, max(G.F_DATE)
        from T_REG_GOOD G
        where G.F_SKLAD = :F_SKLAD_IN and
              G.F_DATE <= :F_DATE_IN and
              G.F_GOOD = :F_GOOD_IN
        group by G.F_GOOD, G.F_SKLAD
        into :F_GOOD, :F_SKLAD, :F_DATE
    do
    begin
      select R.F_STR_OST, R.F_MOVE_IN, R.F_MOVE_OUT, R.F_END_OST
      from T_REG_GOOD R
      where F_GOOD = :F_GOOD and
            F_SKLAD = :F_SKLAD_IN and
            F_DATE = :F_DATE
      into :F_STR_OST, :F_MOVE_IN, :F_MOVE_OUT, :F_END_OST;
      select F_NAME, F_ARTICLE, F_GOODS_GRP_NAME, F_GOODS_GRP_COLOR
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_GOOD_ARTICLE, :F_GOOD_GRP_NAME, :F_GOOD_GRP_COLOR;
      if (V_PRICE > 0) then
        select F_VALUE
        from SP_T_PRICE_GET(:V_PRICE, :F_GOOD)
        into :F_PRICE_VAL;
      else
        F_PRICE_VAL = 0;
      suspend;
    end

  end
  else
  begin
    for select G.F_GOOD, G.F_SKLAD, G.F_DATE, G.F_END_OST
        from T_OST G
        where G.F_SKLAD = :F_SKLAD_IN and
              G.F_GOOD = :F_GOOD_IN
        into :F_GOOD, :F_SKLAD, :F_DATE, :F_END_OST
    do
    begin
      if (F_DATE = F_DATE_IN) then
      begin
        select R.F_STR_OST, R.F_MOVE_IN, R.F_MOVE_OUT, R.F_END_OST
        from T_REG_GOOD R
        where F_GOOD = :F_GOOD and
              F_SKLAD = :F_SKLAD_IN and
              F_DATE = :F_DATE
        into :F_STR_OST, :F_MOVE_IN, :F_MOVE_OUT, :F_END_OST;
      end
      else
      begin
        F_STR_OST = F_END_OST;
        F_MOVE_IN = 0;
        F_MOVE_OUT = 0;
      end
      select F_NAME, F_ARTICLE, F_GOODS_GRP_NAME, F_GOODS_GRP_COLOR
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_GOOD_ARTICLE, :F_GOOD_GRP_NAME, :F_GOOD_GRP_COLOR;
      if (V_PRICE > 0) then
        select F_VALUE
        from SP_T_PRICE_GET(:V_PRICE, :F_GOOD)
        into :F_PRICE_VAL;
      else
        F_PRICE_VAL = 0;
      suspend;
    end

  end
end^


CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_S (
    F_SKLAD_IN BIGINT,
    F_DATE_IN DATE,
    F_PRICE BIGINT,
    F_SCAN VARCHAR(20) = null,
    F_T_OST SMALLINT = 1)
RETURNS (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT,
    F_END_OST FLOAT,
    F_GOOD_GRP BIGINT,
    F_GOOD_NAME VARCHAR(255),
    F_GOOD_ARTICLE VARCHAR(20),
    F_GOOD_GRP_NAME VARCHAR(60),
    F_GOOD_GRP_COLOR VARCHAR(60),
    F_PRICE_VAL NUMERIC(15,3))
AS
declare variable V_PRICE bigint;
declare variable V_DATE date;
begin
  if (exists(select F_ID
             from T_NSI_PRICE
             where F_ID = :F_PRICE)) then
    V_PRICE = F_PRICE;
  else
    V_PRICE = 0;

  if ((current_date > F_DATE_IN) or (F_T_OST = 0)) then
  begin
    if (F_SCAN is null) then
    begin
      for select G.F_GOOD, G.F_SKLAD, max(G.F_DATE)
          from T_REG_GOOD G
          where G.F_SKLAD = :F_SKLAD_IN and
                G.F_DATE <= :F_DATE_IN
          group by G.F_GOOD, G.F_SKLAD

          into :F_GOOD, :F_SKLAD, :F_DATE
      do
      begin
        select R.F_STR_OST, R.F_MOVE_IN, R.F_MOVE_OUT, R.F_END_OST
        from T_REG_GOOD R
        where F_GOOD = :F_GOOD and
              F_SKLAD = :F_SKLAD_IN and
              F_DATE = :F_DATE
        into :F_STR_OST, :F_MOVE_IN, :F_MOVE_OUT, :F_END_OST;
        select F_NAME, F_ARTICLE, F_GOODS_GRP_NAME, F_GOODS_GRP_COLOR
        from SP_T_NSI_GOODS_GET(:F_GOOD, null)
        into :F_GOOD_NAME, :F_GOOD_ARTICLE, :F_GOOD_GRP_NAME, :F_GOOD_GRP_COLOR;
        if (V_PRICE > 0) then
          select F_VALUE
          from SP_T_PRICE_GET(:V_PRICE, :F_GOOD)
          into :F_PRICE_VAL;
        else
          F_PRICE_VAL = 0;
        suspend;
      end
    end
    else
    begin
      for select G.F_GOOD, G.F_SKLAD, max(G.F_DATE)
          from T_REG_GOOD G
          inner join(select distinct F_GOOD
                     from T_NSI_SCANCODE
                     where F_VALUE = :F_SCAN) S on G.F_GOOD = S.F_GOOD
          where G.F_SKLAD = :F_SKLAD_IN and
                G.F_DATE <= :F_DATE_IN
          group by G.F_GOOD, G.F_SKLAD
          into :F_GOOD, :F_SKLAD, :F_DATE
      do
      begin
        select R.F_STR_OST, R.F_MOVE_IN, R.F_MOVE_OUT, R.F_END_OST
        from T_REG_GOOD R
        where F_GOOD = :F_GOOD and
              F_SKLAD = :F_SKLAD_IN and
              F_DATE = :F_DATE
        into :F_STR_OST, :F_MOVE_IN, :F_MOVE_OUT, :F_END_OST;
        select F_NAME, F_ARTICLE, F_GOODS_GRP_NAME, F_GOODS_GRP_COLOR
        from SP_T_NSI_GOODS_GET(:F_GOOD, null)
        into :F_GOOD_NAME, :F_GOOD_ARTICLE, :F_GOOD_GRP_NAME, :F_GOOD_GRP_COLOR;
        if (V_PRICE > 0) then
          select F_VALUE
          from SP_T_PRICE_GET(:V_PRICE, :F_GOOD)
          into :F_PRICE_VAL;
        else
          F_PRICE_VAL = 0;
        suspend;
      end

    end
  end
  else
  begin
    for select G.F_GOOD, G.F_SKLAD, G.F_DATE, G.F_END_OST
        from T_OST G
        where G.F_SKLAD = :F_SKLAD_IN

        into :F_GOOD, :F_SKLAD, :F_DATE, :F_END_OST
    do
    begin
      if (F_DATE = F_DATE_IN) then
      begin
        select R.F_STR_OST, R.F_MOVE_IN, R.F_MOVE_OUT, R.F_END_OST
        from T_REG_GOOD R
        where F_GOOD = :F_GOOD and
              F_SKLAD = :F_SKLAD_IN and
              F_DATE = :F_DATE
        into :F_STR_OST, :F_MOVE_IN, :F_MOVE_OUT, :F_END_OST;
      end
      else
      begin
        F_STR_OST = F_END_OST;
        F_MOVE_IN = 0;
        F_MOVE_OUT = 0;
      end
      select F_NAME, F_ARTICLE, F_GOODS_GRP_NAME, F_GOODS_GRP_COLOR
      from SP_T_NSI_GOODS_GET(:F_GOOD, null)
      into :F_GOOD_NAME, :F_GOOD_ARTICLE, :F_GOOD_GRP_NAME, :F_GOOD_GRP_COLOR;
      if (V_PRICE > 0) then
        select F_VALUE
        from SP_T_PRICE_GET(:V_PRICE, :F_GOOD)
        into :F_PRICE_VAL;
      else
        F_PRICE_VAL = 0;
      suspend;
    end

  end
end^


CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_SET (
    P_SKLAD D_INT,
    P_GOOD D_INT,
    P_DATE D_DATE,
    P_OPERATION D_BOOL,
    P_CNT D_INT)
AS
declare variable V_REG_ID bigint;
declare variable V_CHECK_OST D_BOOL;
begin
  select (select F_CHECK_OST
          from SP_T_NSI_GOOD_TYPE_S(coalesce(F_GOOD_TYPE,1)))
  from SP_T_NSI_GOODS_GET(:P_GOOD, null)
  into :V_CHECK_OST;

  if (V_CHECK_OST = 0) then
    exit;
  if (not exists(select 1
                 from T_REG_GOOD
                 where F_GOOD = :P_GOOD and
                       F_DATE = :P_DATE and
                       F_SKLAD = :P_SKLAD)) then
  begin
    V_REG_ID = gen_id(GEN_T_REG_GOOD_ID, 1);
    insert into T_REG_GOOD (F_ID, F_DATE, F_GOOD, F_SKLAD)
    values (:V_REG_ID, :P_DATE, :P_GOOD, :P_SKLAD);
  end
  else
  begin
    select F_ID
    from T_REG_GOOD
    where F_GOOD = :P_GOOD and
          F_DATE = :P_DATE and
          F_SKLAD = :P_SKLAD
    into :V_REG_ID;
  end
  if (P_OPERATION = 0) then
  begin
    update T_REG_GOOD
    set F_MOVE_IN = coalesce(F_MOVE_IN, 0) + :P_CNT
    where (F_ID = :V_REG_ID);
  end
  if (P_OPERATION = 1) then
  begin
    update T_REG_GOOD
    set F_MOVE_OUT = coalesce(F_MOVE_out, 0) + :P_CNT
    where (F_ID = :V_REG_ID);
  end
end^


CREATE OR ALTER PROCEDURE SP_T_REG_GOOD_U (
    F_ID BIGINT,
    F_GOOD BIGINT,
    F_SKLAD BIGINT,
    F_DATE DATE,
    F_STR_OST FLOAT,
    F_MOVE_IN FLOAT,
    F_MOVE_OUT FLOAT)
AS
BEGIN
  UPDATE T_REG_GOOD
  SET F_GOOD = :F_GOOD,
      F_SKLAD = :F_SKLAD,
      F_DATE = :F_DATE,
      F_STR_OST = :F_STR_OST,
      F_MOVE_IN = :F_MOVE_IN,
      F_MOVE_OUT = :F_MOVE_OUT
  WHERE (F_ID = :F_ID);
END^


CREATE OR ALTER PROCEDURE SP_T_REG_PARTNER_GET (
    P_PARTNER BIGINT,
    P_DATE DATE)
RETURNS (
    F_DATE DATE,
    F_PARTNER BIGINT,
    F_STR_OST NUMERIC(15,3),
    F_DOC_OUT_SUM NUMERIC(15,3),
    F_DOC_IN_SUM NUMERIC(15,3),
    F_MONEY_IN_SUM NUMERIC(15,3),
    F_MONEY_OUT_SUM NUMERIC(15,3),
    F_END_OST NUMERIC(15,3))
AS
begin
  for select F_DATE, F_PARTNER, F_STR_OST, F_DOC_OUT_SUM, F_DOC_IN_SUM, F_MONEY_IN_SUM, F_MONEY_OUT_SUM, F_END_OST
      from T_REG_PARTNER
      where F_PARTNER = :P_PARTNER and
            F_DATE = (select max(F_DATE)
                      from T_REG_PARTNER
                      where F_PARTNER = :P_PARTNER and
                            F_DATE <= :P_DATE)
      into :F_DATE, :F_PARTNER, :F_STR_OST, :F_DOC_OUT_SUM, :F_DOC_IN_SUM, :F_MONEY_IN_SUM, :F_MONEY_OUT_SUM, :F_END_OST

  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE SP_T_REG_PARTNER_SET (
    P_PARTNER BIGINT,
    P_DATE DATE,
    P_REG_TYPE INTEGER,
    P_REG_SUM NUMERIC(15,3))
AS
declare variable V_REG_ID bigint;
begin
  if (not exists(select 1
                 from T_REG_PARTNER
                 where F_PARTNER = :P_PARTNER and
                       F_DATE = :P_DATE)) then
  begin
    V_REG_ID = gen_id(GEN_T_REG_PARTNER_ID, 1);
    insert into T_REG_PARTNER (F_ID, F_DATE, F_PARTNER)
    values (:V_REG_ID, :P_DATE, :P_PARTNER);
  end
  else
  begin
    select F_ID
    from T_REG_PARTNER
    where F_PARTNER = :P_PARTNER and
          F_DATE = :P_DATE
    into :V_REG_ID;
  end
  if (P_REG_TYPE = 1) then
    update T_REG_PARTNER
    set F_DOC_IN_SUM = coalesce(F_DOC_IN_SUM, 0) + :P_REG_SUM
    where F_ID = :V_REG_ID;
  if (P_REG_TYPE = 2) then
    update T_REG_PARTNER
    set F_DOC_OUT_SUM = coalesce(F_DOC_OUT_SUM, 0) + :P_REG_SUM
    where F_ID = :V_REG_ID;
  if (P_REG_TYPE = 3) then
    update T_REG_PARTNER
    set F_MONEY_IN_SUM = coalesce(F_MONEY_IN_SUM, 0) + :P_REG_SUM
    where F_ID = :V_REG_ID;
  if (P_REG_TYPE = 4) then
    update T_REG_PARTNER
    set F_MONEY_OUT_SUM = coalesce(F_MONEY_OUT_SUM, 0) + :P_REG_SUM
    where F_ID = :V_REG_ID;

end^


CREATE OR ALTER PROCEDURE SP_T_USER_BUFFER_SET (
    P_GOOD BIGINT,
    P_CNT FLOAT)
AS
begin
    update or insert into T_USER_BUFER (F_USER, F_GOOD, F_CNT)
    values (current_user, :P_GOOD, :p_cnt) /*coalesce((select F_CNT
                                                from V_USER_BUFFER
                                                where F_GOOD = :V_GOOD_ID), 0) + :P_CNT)*/
    matching (F_USER, F_GOOD);
end^


CREATE OR ALTER PROCEDURE SP_UNMAKE_PARTY_FROM_DOC (
    P_DOC_IN BIGINT)
AS
declare variable V_PARTY_ID bigint;
declare variable V_CNT float;
begin
  for select S.F_GOOD_PARTY,s.f_cnt
      from T_DOC_IN D
      inner join T_DOC_IN_STR S on D.F_ID = S.F_DOC_IN
      where D.F_ID = :P_DOC_IN
      into :V_PARTY_ID,:v_cnt
  do
    update T_NSI_GOOD_PARTY
    set F_CNT = f_cnt-:v_cnt
    where F_ID = :V_PARTY_ID;

end^


CREATE OR ALTER PROCEDURE SP_UNMAKE_PARTY_FROM_DOC_MOVE (
    P_DOC_MOVE BIGINT)
AS
declare variable V_PARTY_ID bigint;
declare variable V_CNT float;
begin
  for select S.F_GOOD_PARTY,s.f_cnt
      from T_DOC_MOVE D
      inner join T_DOC_MOVE_STR S on D.F_ID = S.F_DOC_MOVE
      where D.F_ID = :P_DOC_MOVE
      into :V_PARTY_ID,:v_cnt
  do
    update T_NSI_GOOD_PARTY
    set F_CNT = f_cnt-:v_cnt
    where F_ID = :V_PARTY_ID;

end^


CREATE OR ALTER PROCEDURE T_NSI_DOC_PROPERTY_VAL_S (
    P_PROPERTY INTEGER)
RETURNS (
    F_ID BIGINT,
    F_DOC_PROPERTY BIGINT,
    F_VALUE VARCHAR(100))
AS
begin
  for select f_id,
             f_doc_property,
             f_value
      from t_nsi_doc_property_val
      where f_doc_property=:p_property
      into :f_id,
           :f_doc_property,
           :f_value
  do
  begin
    suspend;
  end
end^


CREATE OR ALTER PROCEDURE UPD_20160704
AS
declare variable v_prg_version bigint;
begin
  select PARAM_VALUE from sp_get_sys_param('PROGRAM_VERSION') into :v_prg_version;
  if (v_prg_version >= 20160704) then exit;

  if (not exists(select 1 from rdb$relations where rdb$relation_name='T_NSI_GOODS_LINKS')) then
  begin
    execute statement 'CREATE TABLE T_NSI_GOODS_LINKS(F_ID D_ID NOT NULL,F_LINK_NAME D_STR,F_LINK_TYPE D_INT);';
    execute statement 'ALTER TABLE  T_NSI_GOODS_LINKS ADD CONSTRAINT PK_T_NSI_GOODS_LINKS PRIMARY KEY (F_ID);';
    if (not exists(select 1 from rdb$generators where RDB$GENERATOR_NAME='GEN_T_NSI_GOODS_LINKS_ID')) then
      execute statement 'CREATE GENERATOR GEN_T_NSI_GOODS_LINKS_ID;';        
  end
  if (not exists(select 1 from rdb$relations where rdb$relation_name='T_NSI_GOODS_LINK_POS')) then
  begin
    execute statement 'CREATE TABLE T_NSI_GOODS_LINK_POS(F_ID D_ID NOT NULL,F_LINK D_INT,F_GOOD D_INT)';
    execute statement 'ALTER TABLE T_NSI_GOODS_LINK_POS ADD CONSTRAINT PK_T_NSI_GOODS_LINK_POS PRIMARY KEY (F_ID);';
    execute statement 'ALTER TABLE T_NSI_GOODS_LINK_POS ADD CONSTRAINT FK_T_NSI_GOODS_LINK_POS_1 FOREIGN KEY (F_GOOD) REFERENCES T_NSI_GOODS (F_ID);';
    execute statement 'ALTER TABLE T_NSI_GOODS_LINK_POS ADD CONSTRAINT FK_T_NSI_GOODS_LINK_POS_2 FOREIGN KEY (F_LINK) REFERENCES T_NSI_GOODS_LINKS (F_ID);';

    if (not exists(select 1 from rdb$generators where RDB$GENERATOR_NAME='GEN_T_NSI_GOODS_LINK_POS_ID')) then
      execute statement 'CREATE GENERATOR GEN_T_NSI_GOODS_LINK_POS_ID;';        
  end
  if (not exists(select 1 from rdb$relations where rdb$relation_name='T_OST_PARTY')) then
  begin
    execute statement 'CREATE TABLE T_OST_PARTY ( F_ID D_ID, F_OST D_INT,F_GOOD D_INT,F_PARTY D_INT,F_CURR_OST D_MONEY);';
    execute statement 'ALTER TABLE T_OST_PARTY ADD CONSTRAINT PK_T_OST_PARTY PRIMARY KEY (F_ID);';
    execute statement 'ALTER TABLE T_OST_PARTY ADD CONSTRAINT T_OST_PARTY_T_NSI_GOODS FOREIGN KEY (F_GOOD) REFERENCES T_NSI_GOODS (F_ID) ON DELETE SET NULL;';
    execute statement 'ALTER TABLE T_OST_PARTY ADD CONSTRAINT T_OST_PARTY_T_NSI_GOODS_PARTY FOREIGN KEY (F_PARTY) REFERENCES T_NSI_GOOD_PARTY (F_ID) ON DELETE SET NULL;';
    execute statement 'ALTER TABLE T_OST_PARTY ADD CONSTRAINT T_OST_PARTY_T_OST FOREIGN KEY (F_OST) REFERENCES T_OST (F_ID) ON DELETE SET NULL;';

    if (not exists(select 1 from rdb$generators where RDB$GENERATOR_NAME='GEN_T_OST_PARTY')) then
      execute statement 'CREATE GENERATOR GEN_T_OST_PARTY;';        
  end

end^



SET TERM ; ^
